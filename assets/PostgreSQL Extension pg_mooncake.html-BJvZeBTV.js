import{_ as s,c as a,a as p,o as t}from"./app-BeHGwf2X.js";const e={};function o(c,n){return t(),a("div",null,n[0]||(n[0]=[p(`<h1 id="postgresql-extension-pg-mooncake" tabindex="-1"><a class="header-anchor" href="#postgresql-extension-pg-mooncake"><span>PostgreSQL (Extension) - pg_mooncake</span></a></h1><p>Created by: Mr Dk.</p><p>2026 / 02 / 14 16:02</p><p>Ningbo, Zhejiang, China</p><hr><h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h2><p><a href="https://github.com/Mooncake-Labs/pg_mooncake" target="_blank" rel="noopener noreferrer">pg_mooncake</a> 是一款使 PostgreSQL 具备对行式存储的 Heap 表创建 <a href="https://iceberg.apache.org/" target="_blank" rel="noopener noreferrer">Iceberg</a> 格式的副本列存表的插件，通过 PostgreSQL 的逻辑复制能力自动维护两张表的数据同步。插件主体由 Rust 实现。用户可以根据业务查询的类型来选择查询行存表还是列存表，如果选择的是列存表，则借助 <a href="https://github.com/duckdb/pg_duckdb" target="_blank" rel="noopener noreferrer">pg_duckdb</a> 的能力读取并计算列存数据。</p><p>本文简析其关键能力是如何实现的。</p><h2 id="moonlink-服务" tabindex="-1"><a class="header-anchor" href="#moonlink-服务"><span>Moonlink 服务</span></a></h2><p>pg_mooncake 的核心能力实现在一个叫做 <a href="https://github.com/Mooncake-Labs/moonlink" target="_blank" rel="noopener noreferrer">moonlink</a> 的组件中。该组件对外提供 RPC 服务，管理着列存表的元数据，也管理与 PostgreSQL 的逻辑复制以维持行列存的同步。官方建议在生产环境中把这个组件作为一个服务独立部署，但也支持将这个组件运行在一个 PostgreSQL 的 background worker 进程中：</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">BackgroundWorkerBuilder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;moonlink&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">set_library</span><span class="token punctuation">(</span><span class="token string">&quot;pg_mooncake&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">set_function</span><span class="token punctuation">(</span><span class="token string">&quot;moonlink_main&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">enable_shmem_access</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">set_start_time</span><span class="token punctuation">(</span><span class="token class-name">BgWorkerStartTime</span><span class="token punctuation">::</span><span class="token class-name">ConsistentState</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">set_restart_time</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Moonlink 组件启动后，会在 PostgreSQL 的数据目录下创建一个专用的独立目录，并在其中创建用于 RPC 的 Unix Socket：</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token attribute attr-name">#[tokio::main]</span></span>
<span class="line"><span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token class-name">ServiceConfig</span> <span class="token punctuation">{</span></span>
<span class="line">        base_path<span class="token punctuation">:</span> <span class="token string">&quot;pg_mooncake&quot;</span><span class="token punctuation">.</span><span class="token function">to_owned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        data_server_uri<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span></span>
<span class="line">        rest_api_port<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span></span>
<span class="line">        otel_ingestion_api_port<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span></span>
<span class="line">        tcp_port<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span></span>
<span class="line">        log_directory<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span></span>
<span class="line">        otel_export_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">start_with_config</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">start_with_config</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> <span class="token class-name">ServiceConfig</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Start RPC server on Unix socket</span></span>
<span class="line">    <span class="token keyword">let</span> socket_path <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">.</span>base_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;moonlink.sock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> rpc_backend <span class="token operator">=</span> backend<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> rpc_handle <span class="token operator">=</span> <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">rpc_server<span class="token punctuation">::</span></span><span class="token function">start_unix_server</span><span class="token punctuation">(</span>rpc_backend<span class="token punctuation">,</span> socket_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">&quot;RPC server failed: {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="基于逻辑复制的行列存同步" tabindex="-1"><a class="header-anchor" href="#基于逻辑复制的行列存同步"><span>基于逻辑复制的行列存同步</span></a></h2><p>pg_mooncake 插件对用户暴露以下存储过程，为一张行存表创建列存表副本：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CALL</span> mooncake<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;r&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>在 PostgreSQL 中执行这个存储过程后，将首先在 PostgreSQL 的 catalog 中注册这张表，以便将来对这张表的查询能够被 binder 识别；然后再调用 moonlink 的 RPC 让 moonlink 服务也同步创建这张表的列存副本，并准备好行列同步：</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token attribute attr-name">#[pg_extern(sql = <span class="token string">&quot;</span>
<span class="line">CREATE PROCEDURE mooncake.create_table(dst text, src text, src_uri text DEFAULT NULL, table_config json DEFAULT NULL) LANGUAGE c AS &#39;MODULE_PATHNAME&#39;, &#39;@FUNCTION_NAME@&#39;;</span>
<span class="line">&quot;</span>)]</span></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">create_table</span><span class="token punctuation">(</span>dst<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> src<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> src_uri<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> table_config<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token function">create_mooncake_table</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dst_uri<span class="token punctuation">,</span> <span class="token operator">&amp;</span>src<span class="token punctuation">,</span> <span class="token operator">&amp;</span>src_uri<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token function">block_on</span><span class="token punctuation">(</span><span class="token namespace">moonlink_rpc<span class="token punctuation">::</span></span><span class="token function">create_table</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token function">get_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token constant">DATABASE</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        dst<span class="token punctuation">,</span></span>
<span class="line">        src<span class="token punctuation">,</span></span>
<span class="line">        src_uri<span class="token punctuation">,</span></span>
<span class="line">        table_config<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;create_table failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 PostgreSQL 中创建这张表时，需要先从 catalog 中查回行存表的列定义，然后按原样拼接出创建列存表的 SQL，并声明这张表使用的 table AM 为 <code>mooncake</code>：</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">create_mooncake_table</span><span class="token punctuation">(</span>dst<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> dst_uri<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> src<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> src_uri<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> get_columns_query <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        src<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&#39;&#39;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> create_table_query <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;CREATE TABLE {dst} ({columns}) USING mooncake&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    client</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">simple_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>create_table_query<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;error creating table: {dst}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当 <code>create_table</code> 的 RPC 调用到达 moonlink 以后，moonlink 知道需要开始同步一张新的表。如果逻辑复制所需要的复制槽、发布等还没有被初始化，则先进行必要的创建：</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">impl</span> <span class="token class-name">PostgresConnection</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>uri<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">        postgres_client</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">simple_query</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token string">&quot;DROP PUBLICATION IF EXISTS moonlink_pub; CREATE PUBLICATION moonlink_pub WITH (publish_via_partition_root = true);&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token keyword">await</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token class-name">PostgresSourceError</span><span class="token punctuation">::</span>from<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">impl</span> <span class="token class-name">ReplicationClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">pub</span> <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_logical_replication_stream</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span></span>
<span class="line">        publication<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span></span>
<span class="line">        slot_name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span></span>
<span class="line">        start_lsn<span class="token punctuation">:</span> <span class="token class-name">PgLsn</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">LogicalReplicationStream</span><span class="token punctuation">,</span> <span class="token class-name">ReplicationClientError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">r#&quot;(&quot;proto_version&quot; &#39;2&#39;, &quot;publication_names&quot; {}, &quot;streaming&quot; &#39;on&#39;)&quot;#</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">quote_literal</span><span class="token punctuation">(</span>publication<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">r#&quot;START_REPLICATION SLOT {} LOGICAL {} {}&quot;#</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">quote_identifier</span><span class="token punctuation">(</span>slot_name<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            start_lsn<span class="token punctuation">,</span></span>
<span class="line">            options</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建完毕后，将要同步的行存表加入到发布中开始订阅变更，然后进行行表的快照全量数据拷贝并写入 Parquet 文件。</p><h2 id="借助-duckdb-读取列存表" tabindex="-1"><a class="header-anchor" href="#借助-duckdb-读取列存表"><span>借助 DuckDB 读取列存表</span></a></h2><p>对于一张带有列存表副本的 PostgreSQL 行存表来说，如何从 PostgreSQL 中读取列存表呢？列存的元数据维护在 moonlink 服务中，读取并处理列存数据需要基于列式存储的向量化执行器。因此，pg_mooncake 借助 pg_duckdb 来完成这个目标：</p><ul><li>pg_duckdb 使 PostgreSQL 具备将 SQL 改写并转发到 DuckDB 中执行的能力</li><li>pg_mooncake 为 DuckDB 实现了一套 Storage Extension，并在底层以 moonlink 作为元数据服务；这样 DuckDB 可以通过这个 Storage Extension 感知列存表是否存在，以及知道如何扫描列存表</li><li>pg_mooncake 在 DuckDB 中实现了 <code>mooncake_scan</code> 函数来扫描列存表，该函数会通过 moonlink 服务获取 SQL 查询对应的 LSN 下可见的数据版本和 Parquet 文件列表，并复用 DuckDB 的 <code>parquet_scan</code> 来完成 Iceberg 中的 Parquet 文件读取，复用 DuckDB 的向量化执行器实现对列存数据的分析</li></ul><h3 id="mooncake-table-am" tabindex="-1"><a class="header-anchor" href="#mooncake-table-am"><span>Mooncake Table AM</span></a></h3><p>首先，pg_duckdb 默认只识别自带的 <code>duckdb</code> table AM，在遇到 <code>duckdb</code> table AM 的表时将会改写 SQL 并转发到 DuckDB。而 pg_mooncake 将自带的 <code>mooncake</code> table AM 也注册到了 pg_duckdb 中，作为同类型的 table AM 处理：</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">fn</span> <span class="token function-definition function">RegisterDuckdbTableAm</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> c_char<span class="token punctuation">,</span> am<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token namespace">pg_sys<span class="token punctuation">::</span></span><span class="token class-name">TableAmRoutine</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token class-name">CString</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">&quot;mooncake&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;name should not contain an internal 0 byte&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">RegisterDuckdbTableAm</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">as_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">std<span class="token punctuation">::</span>ptr<span class="token punctuation">::</span></span><span class="token macro property">addr_of!</span><span class="token punctuation">(</span><span class="token constant">MOONCAKE_AM</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token macro property">assert!</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">&quot;error registering mooncake table AM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与 pg_duckdb 提供的 <code>duckdb</code> table AM 类似，pg_mooncake 提供的 <code>mooncake</code> table AM 也基本没有做任何实现。因为实际的执行是在 DuckDB 内完成的：</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs" data-title="rs"><pre><code><span class="line"><span class="token attribute attr-name">#[pg_guard]</span></span>
<span class="line"><span class="token keyword">extern</span> <span class="token string">&quot;C-unwind&quot;</span> <span class="token keyword">fn</span> <span class="token function-definition function">mooncake_scan_getnextslot</span><span class="token punctuation">(</span></span>
<span class="line">    _scan<span class="token punctuation">:</span> <span class="token namespace">pg_sys<span class="token punctuation">::</span></span><span class="token class-name">TableScanDesc</span><span class="token punctuation">,</span></span>
<span class="line">    _direction<span class="token punctuation">:</span> <span class="token namespace">pg_sys<span class="token punctuation">::</span></span><span class="token class-name">ScanDirection</span><span class="token punctuation">::</span><span class="token class-name">Type</span><span class="token punctuation">,</span></span>
<span class="line">    _slot<span class="token punctuation">:</span> <span class="token operator">*</span><span class="token keyword">mut</span> <span class="token namespace">pg_sys<span class="token punctuation">::</span></span><span class="token class-name">TupleTableSlot</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token string">&quot;mooncake_scan_getnextslot&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="duckdb-storage-extension" tabindex="-1"><a class="header-anchor" href="#duckdb-storage-extension"><span>DuckDB Storage Extension</span></a></h3><p>在 pg_duckdb 的 planner hook 中，对 <code>mooncake</code> table AM 的列存表访问，在语法树经过 deparse 以后将会得到类似 <code>mooncake.schema.table</code> 的全限定名，对应到 DuckDB 中的 <code>mooncake</code> 数据库。</p><p>而 pg_mooncake 通过 DuckDB 的 <a href="https://duckdb.org/docs/stable/sql/statements/attach" target="_blank" rel="noopener noreferrer"><code>ATTACH</code></a> 语法，向 DuckDB 注册了 <code>mooncake</code> 类型的 Storage Extension，从而实现对 <code>mooncake</code> 数据库下的元数据 (catalog) 管理与表访问：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">MooncakeStorageExtension</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">StorageExtension</span></span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token keyword">public</span><span class="token operator">:</span></span>
<span class="line">    <span class="token function">MooncakeStorageExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">MooncakeStorageExtension</span><span class="token double-colon punctuation">::</span><span class="token function">MooncakeStorageExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    attach <span class="token operator">=</span> MooncakeAttach<span class="token punctuation">;</span></span>
<span class="line">    create_transaction_manager <span class="token operator">=</span> MooncakeCreateTransactionManager<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">unique_ptr<span class="token operator">&lt;</span>Catalog<span class="token operator">&gt;</span> <span class="token function">MooncakeAttach</span><span class="token punctuation">(</span>optional_ptr<span class="token operator">&lt;</span>StorageExtensionInfo<span class="token operator">&gt;</span> storage_info<span class="token punctuation">,</span> ClientContext <span class="token operator">&amp;</span>context<span class="token punctuation">,</span></span>
<span class="line">                                   AttachedDatabase <span class="token operator">&amp;</span>db<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>name<span class="token punctuation">,</span> AttachInfo <span class="token operator">&amp;</span>info<span class="token punctuation">,</span> AttachOptions <span class="token operator">&amp;</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">make_uniq</span><span class="token generic class-name"><span class="token operator">&lt;</span>MooncakeCatalog<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">unique_ptr<span class="token operator">&lt;</span>TransactionManager<span class="token operator">&gt;</span> <span class="token function">MooncakeCreateTransactionManager</span><span class="token punctuation">(</span>optional_ptr<span class="token operator">&lt;</span>StorageExtensionInfo<span class="token operator">&gt;</span> storage_info<span class="token punctuation">,</span></span>
<span class="line">                                                                AttachedDatabase <span class="token operator">&amp;</span>db<span class="token punctuation">,</span> Catalog <span class="token operator">&amp;</span>catalog<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">make_uniq</span><span class="token generic class-name"><span class="token operator">&lt;</span>MooncakeTransactionManager<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> catalog<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些 Storage Extension 需要实现的回调函数在底层通过 FFI 从 C++ 代码进入了 Rust 代码，然后对 moonlink 服务进行 RPC，从而取得相应的信息。</p><h3 id="mooncake-scan-function" tabindex="-1"><a class="header-anchor" href="#mooncake-scan-function"><span>Mooncake Scan Function</span></a></h3><p>DuckDB 的 Storage Extension 中需要被实现的最重要的一个回调就是 <code>GetScanFunction</code>，即获取对当前表进行扫描的函数。对于 mooncake 表来说，其核心扫描逻辑复用了 DuckDB 已有的 <code>parquet_scan</code>：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line">TableFunction <span class="token class-name">MooncakeTable</span><span class="token double-colon punctuation">::</span><span class="token function">GetScanFunction</span><span class="token punctuation">(</span>ClientContext <span class="token operator">&amp;</span>context<span class="token punctuation">,</span> unique_ptr<span class="token operator">&lt;</span>FunctionData<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>bind_data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    TableFunction mooncake_scan <span class="token operator">=</span> <span class="token function">GetParquetScan</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    mooncake_scan<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;mooncake_scan&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    mooncake_scan<span class="token punctuation">.</span>init_global <span class="token operator">=</span> MooncakeScanInitGlobal<span class="token punctuation">;</span></span>
<span class="line">    mooncake_scan<span class="token punctuation">.</span>to_string <span class="token operator">=</span> MooncakeScanToString<span class="token punctuation">;</span></span>
<span class="line">    mooncake_scan<span class="token punctuation">.</span>get_bind_info <span class="token operator">=</span> MooncakeScanGetBindInfo<span class="token punctuation">;</span></span>
<span class="line">    mooncake_scan<span class="token punctuation">.</span>get_multi_file_reader <span class="token operator">=</span> MooncakeMultiFileReader<span class="token double-colon punctuation">::</span>Create<span class="token punctuation">;</span></span>
<span class="line">    mooncake_scan<span class="token punctuation">.</span>function_info <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>MooncakeFunctionInfo<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    bind_data <span class="token operator">=</span> mooncake_scan<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> bind_input<span class="token punctuation">,</span> return_types<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> mooncake_scan<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> TableFunction <span class="token operator">&amp;</span><span class="token function">GetParquetScan</span><span class="token punctuation">(</span>ClientContext <span class="token operator">&amp;</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ExtensionLoader <span class="token function">loader</span><span class="token punctuation">(</span><span class="token operator">*</span>context<span class="token punctuation">.</span>db<span class="token punctuation">,</span> <span class="token string">&quot;mooncake&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> loader<span class="token punctuation">.</span><span class="token function">GetTableFunction</span><span class="token punctuation">(</span><span class="token string">&quot;parquet_scan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span><span class="token function">GetFunctionReferenceByOffset</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在执行初始化的 <code>init_global</code> 函数中，用专门为 mooncake 实现的 <code>MooncakeScanInitGlobal</code> hook 掉了 <code>parquet_scan</code> 自己的 <code>init_global</code> 函数，并在其中额外增加了获取列存表对应数据文件的步骤：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">static</span> unique_ptr<span class="token operator">&lt;</span>GlobalTableFunctionState<span class="token operator">&gt;</span> <span class="token function">MooncakeScanInitGlobal</span><span class="token punctuation">(</span>ClientContext <span class="token operator">&amp;</span>context<span class="token punctuation">,</span></span>
<span class="line">                                                                   TableFunctionInitInput <span class="token operator">&amp;</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">auto</span> <span class="token operator">&amp;</span>bind_data <span class="token operator">=</span> input<span class="token punctuation">.</span>bind_data<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">Cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>MultiFileBindData<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    bind_data<span class="token punctuation">.</span>file_list<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">Cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>MooncakeMultiFileList<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">LazyInitialize</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> bind_data<span class="token punctuation">.</span>names<span class="token punctuation">,</span> input<span class="token punctuation">.</span>column_ids<span class="token punctuation">,</span></span>
<span class="line">                                                                      input<span class="token punctuation">.</span>filters<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">GetParquetScan</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init_global</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了获取要扫描的 Parquet 文件列表，依旧需要借助 moonlink 服务：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line">MooncakeTableMetadata <span class="token operator">&amp;</span><span class="token class-name">MooncakeTable</span><span class="token double-colon punctuation">::</span><span class="token function">GetTableMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    lock_guard<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        metadata <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_uniq</span><span class="token generic class-name"><span class="token operator">&lt;</span>MooncakeTableMetadata<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>moonlink<span class="token punctuation">,</span> schema<span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> lsn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">*</span>metadata<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">MooncakeTableMetadata</span><span class="token double-colon punctuation">::</span><span class="token function">MooncakeTableMetadata</span><span class="token punctuation">(</span>Moonlink <span class="token operator">&amp;</span>moonlink<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>schema<span class="token punctuation">,</span> <span class="token keyword">const</span> string <span class="token operator">&amp;</span>table<span class="token punctuation">,</span></span>
<span class="line">                                             <span class="token keyword">uint64_t</span> lsn<span class="token punctuation">)</span></span>
<span class="line">    <span class="token operator">:</span> <span class="token function">moonlink</span><span class="token punctuation">(</span>moonlink<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">schema</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">table</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    data <span class="token operator">=</span> moonlink<span class="token punctuation">.</span><span class="token function">ScanTableBegin</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> table<span class="token punctuation">,</span> lsn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">uint32_t</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在获取到需要扫描的原始文件列表后，再进一步处理谓词下推、删除向量等，然后真正开始执行 <code>parquet_scan</code>。该函数会读取 Parquet 文件并过滤掉不符合条件或已经删除的行，返回为 DuckDB 的 DataChunk。这些 DataChunk 经由 DuckDB 的向量化执行器完成计算后，通过 pg_duckdb 的 CustomScan 算子返回到 PostgreSQL 中。</p><p>由此，pg_mooncake 借助 pg_duckdb 串联了 PostgreSQL、DuckDB、moonlink，使 PostgreSQL 具备了读取 mooncake 列存表的能力。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>pg_mooncake 主要提供了一个基于 Iceberg 的列存元数据管理 + 数据同步的引擎。借助 DuckDB / pg_duckdb，用户可以通过 PostgreSQL 作为入口对行存表的列存副本进行扫描和计算，从而加速业务中可能出现的分析型查询。</p>`,47)]))}const i=s(e,[["render",o],["__file","PostgreSQL Extension pg_mooncake.html.vue"]]),u=JSON.parse('{"path":"/notes/PostgreSQL/PostgreSQL%20Extension%20pg_mooncake.html","title":"PostgreSQL (Extension) - pg_mooncake","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"背景","slug":"背景","link":"#背景","children":[]},{"level":2,"title":"Moonlink 服务","slug":"moonlink-服务","link":"#moonlink-服务","children":[]},{"level":2,"title":"基于逻辑复制的行列存同步","slug":"基于逻辑复制的行列存同步","link":"#基于逻辑复制的行列存同步","children":[]},{"level":2,"title":"借助 DuckDB 读取列存表","slug":"借助-duckdb-读取列存表","link":"#借助-duckdb-读取列存表","children":[{"level":3,"title":"Mooncake Table AM","slug":"mooncake-table-am","link":"#mooncake-table-am","children":[]},{"level":3,"title":"DuckDB Storage Extension","slug":"duckdb-storage-extension","link":"#duckdb-storage-extension","children":[]},{"level":3,"title":"Mooncake Scan Function","slug":"mooncake-scan-function","link":"#mooncake-scan-function","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{},"filePathRelative":"notes/PostgreSQL/PostgreSQL Extension pg_mooncake.md"}');export{i as comp,u as data};
