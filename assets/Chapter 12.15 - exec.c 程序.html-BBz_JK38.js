import{_ as s,c as a,a as p,o as e}from"./app-BeHGwf2X.js";const t="/blog/assets/12-31-BlRNu_d9.png",o="/blog/assets/12-33-HjoVjt99.png",c="/blog/assets/12-34-C4Qfhp9Q.png",l={};function i(u,n){return e(),a("div",null,n[0]||(n[0]=[p(`<h1 id="chapter-12-15-exec-c-ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#chapter-12-15-exec-c-ç¨‹åº"><span>Chapter 12.15 - exec.c ç¨‹åº</span></a></h1><p>Created by : Mr Dk.</p><p>2019 / 09 / 21 15:57</p><p>Nanjing, Jiangsu, China</p><hr><h2 id="_12-15-exec-c-ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#_12-15-exec-c-ç¨‹åº"><span>12.15 exec.c ç¨‹åº</span></a></h2><h3 id="_12-15-1-åŠŸèƒ½æè¿°" tabindex="-1"><a class="header-anchor" href="#_12-15-1-åŠŸèƒ½æè¿°"><span>12.15.1 åŠŸèƒ½æè¿°</span></a></h3><p>å®ç°å¯¹ <strong>äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶</strong> çš„åŠ è½½ä¸æ‰§è¡Œã€‚æœ€ä¸»è¦çš„å‡½æ•°æ˜¯ <code>do_execve()</code>ã€‚Linux 0.12 å†…æ ¸ä»…æ”¯æŒ <code>a.out</code> æ ¼å¼çš„æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ç§æ–‡ä»¶ä¸­ï¼Œä¿å­˜äº†ä¸€ä¸ª exec æ•°æ®ç»“æ„ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">exec</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_magic<span class="token punctuation">;</span> <span class="token comment">// ?</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_text<span class="token punctuation">;</span> <span class="token comment">// ä»£ç å­—èŠ‚é•¿åº¦</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_data<span class="token punctuation">;</span> <span class="token comment">// æ•°æ®å­—èŠ‚é•¿åº¦</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_bss<span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶æœªåˆå§‹åŒ–æ•°æ®åŒºå­—èŠ‚é•¿åº¦</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_syms<span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨å­—èŠ‚é•¿åº¦</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_entry<span class="token punctuation">;</span> <span class="token comment">// æ‰§è¡Œå¼€å§‹åœ°å€</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_trsize<span class="token punctuation">;</span> <span class="token comment">// ä»£ç é‡å®šä½ä¿¡æ¯å­—èŠ‚é•¿åº¦</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> a_drsize<span class="token punctuation">;</span> <span class="token comment">// æ•°æ®é‡å®šä½ä¿¡æ¯å­—èŠ‚é•¿åº¦</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¨‹åºé€šè¿‡ <code>fork()</code> åˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œåœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨ <code>exec()</code> æ—å‡½æ•°ä¹‹ä¸€ <strong>åŠ è½½</strong>ã€<strong>æ‰§è¡Œ</strong> å¦ä¸€ä¸ªæ–°ç¨‹åºã€‚æ­¤æ—¶ï¼Œå­è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µè¢«æ–°ç¨‹åºå®Œå…¨æ›¿æ¢ã€‚ç”±æ­¤ï¼Œ<code>execve()</code> å‡½æ•°çš„ä¸»è¦åŠŸèƒ½ï¼š</p><ul><li>å¯¹ <strong>å‘½ä»¤è¡Œå‚æ•°</strong> å’Œ <strong>ç¯å¢ƒå‚æ•°</strong> ç©ºé—´é¡µé¢çš„åˆå§‹åŒ–æ“ä½œï¼›å–æ‰§è¡Œå¯¹è±¡çš„ inodeï¼›è®¡ç®—å‚æ•°ä¸ªæ•°å’Œç¯å¢ƒå˜é‡ä¸ªæ•°ï¼›æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œæ‰§è¡Œæƒé™</li><li>æ ¹æ® inodeï¼Œè¯»å– exec ç»“æ„ä¸­çš„ä¿¡æ¯ï¼›åˆ¤æ–­æ˜¯å¦å¯æ‰§è¡Œ</li><li>åˆå§‹åŒ–ï¼šæŒ‡å‘æ–°æ‰§è¡Œæ–‡ä»¶çš„ inodeï¼›å¤ä½ä¿¡å·å¤„ç†å¥æŸ„ï¼›è®¾ç½®å±€éƒ¨æè¿°ç¬¦ï¼›è®¾ç½®å‚æ•°å’Œç¯å¢ƒå‚æ•°é¡µé¢æŒ‡é’ˆï¼›ä¿®æ”¹è¿›ç¨‹æ‰§è¡Œå­—æ®µçš„å†…å®¹</li><li>æ›¿æ¢å †æ ˆä¸Š <code>execve()</code> çš„è¿”å›åœ°å€ä¸ºæ–°æ‰§è¡Œç¨‹åºçš„è¿è¡Œåœ°å€</li></ul><p>ç³»ç»Ÿä¼šæ¸…æ‰ <code>fork()</code> å¤åˆ¶çš„åŸç¨‹åºçš„ç›®å½•é¡¹å’Œé¡µè¡¨é¡¹ï¼Œå¹¶é‡Šæ”¾å¯¹åº”é¡µé¢ï¼Œä¸ºæ–°åŠ è½½çš„ä»£ç é‡æ–°è®¾ç½® PCB ä¸­çš„ä¿¡æ¯ï¼Œç”³è¯·å’Œæ˜ å°„å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå‚æ•°æ‰€å å†…å­˜é¡µé¢ã€‚è®¾ç½®äº†ä»£ç æ‰§è¡Œç‚¹ã€‚æ­¤æ—¶ï¼Œå¹¶ä¸ç«‹åˆ»ä»å—è®¾å¤‡ä¸ŠåŠ è½½æ–°ç¨‹åºä»£ç ï¼Œè€Œæ˜¯é€šè¿‡é¦–æ¬¡è¿è¡Œæ—¶çš„ç¼ºé¡µå¼‚å¸¸ä¸­æ–­ã€‚åœ¨ä¸»å†…å­˜åŒºä¸ºæ–°ç¨‹åºç”³è¯·å†…å­˜é¡µé¢ï¼Œè®¾ç½®é¡µè¡¨ï¼Œè½½å…¥é¡µé¢ - Load on demand (æŒ‰éœ€åŠ è½½)</p><p>å¯¹äºæ–°è¿›ç¨‹æ¥è¯´ï¼Œæ˜¯å¦å…³é—­çˆ¶è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œç”±æ–‡ä»¶æè¿°ç¬¦çš„ close on exec æ ‡å¿—æœ‰å…³ã€‚å¦‚æœè¯¥æ ‡å¿—è¢«è®¾ç½®ï¼Œåˆ™æ‰§è¡Œ <code>execve()</code> åï¼Œå¯¹åº”çš„æè¿°ç¬¦å°†è¢«å…³é—­ã€‚</p><p>å¯¹äºå‚æ•°çš„å¤„ç†ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>envp<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>argc</code> ä¸ºå‚æ•°ä¸ªæ•°</li><li><code>argv</code> ä¸ºå­—ç¬¦ä¸²å‚æ•°æ•°ç»„ï¼Œä»¥ NULL ç»“å°¾</li><li><code>envp</code> ä¸ºç¯å¢ƒå˜é‡å‚æ•°</li></ul><p><code>execve()</code> ä¸ºå‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡å‚æ•°é¢„ç•™äº† MAX_ARG_PAGES (32) ä¸ªé¡µé¢ (128kB)</p><p>åœ¨è¯¥ç©ºé—´ä¸­ï¼Œä»¥ç±»ä¼¼äºå †æ ˆæ“ä½œçš„æ–¹å¼ï¼Œä» 128kB æœ«ç«¯æ”¾å…¥å‚æ•°ï¼š</p><p><img src="`+t+'" alt="12-31"></p><p>ç„¶åæ ¹æ®å‚æ•°å˜é‡ä¸ªæ•° argc å’Œç¯å¢ƒå˜é‡ä¸ªæ•° envcï¼Œåœ¨æ–°ç¨‹åºçš„ç”¨æˆ·æ€å †æ ˆä¸­åˆ›å»ºæŒ‡é’ˆè¡¨ã€‚å…¶ä¸­ï¼Œéœ€è¦åˆ†åˆ«ä¸ºå‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡å„é¢„ç•™ä¸€ä¸ª NULL æŒ‡é’ˆï¼Œä½œä¸ºå‚æ•°è¡¨çš„ç»“æŸæ ‡å¿—ï¼Œå¹¶æœ€ç»ˆå­˜æ”¾å‘½ä»¤è¡Œå‚æ•°è¡¨å’Œç¯å¢ƒå˜é‡è¡¨çš„é¦–åœ°å€ï¼Œä»¥åŠå‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°ã€‚</p><p>è°ƒæ•´å †æ ˆæŒ‡é’ˆåˆ°å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°çš„ä½ç½®ï¼š</p><p><img src="'+o+'" alt="12-33"></p><p>åœ¨å‡½æ•° <code>do_execve()</code> è¿”å›æ—¶ï¼Œå°†å†…æ ¸æ€å †æ ˆä¸Šä¿å­˜çš„ eip æ›¿æ¢ä¸ºæ–°æ‰§è¡Œç¨‹åºçš„å…¥å£åœ°å€ï¼Œå°†å†…æ ¸æ€å †æ ˆä¸Šä¿å­˜çš„ esp æ›¿æ¢ä¸ºæ–°çš„ç”¨æˆ·æ€å †æ ˆä½ç½® (å¦‚ä¸Šå›¾æ‰€ç¤º)ã€‚ç³»ç»Ÿè°ƒç”¨è¿”å›æŒ‡ä»¤ä¼šå¼¹å‡ºè¿™ä¸¤ä¸ªå€¼ï¼Œå¹¶ä½¿ CPU æ‰§è¡Œæ–°çš„ç¨‹åºï¼š</p><p><img src="'+c+`" alt="12-34"></p><blockquote><p>åœ¨è¿›å…¥è¯¥ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œç¨‹åºçš„ç”¨æˆ·å †æ ˆçš„ eip å’Œ esp è¢«ä¿å­˜åœ¨å†…æ ¸æ€å †æ ˆä¸Šï¼š</p><ul><li>eip æŒ‡å‘ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œç»§ç»­æ‰§è¡Œçš„ç¨‹åºæŒ‡ä»¤</li><li>esp æŒ‡å‘ç”¨æˆ·æ€å †æ ˆæ ˆé¡¶</li></ul><p>ç»è¿‡ <code>execve()</code> å‡½æ•°çš„å¤„ç†åï¼Œä¸ºç¨‹åºè®¾ç½®äº†æ–°çš„ç¯å¢ƒå’Œå‚æ•°åŠå…¶æŒ‡é’ˆè¡¨ï¼Œå¹¶ä½¿ esp æŒ‡å‘å‚æ•°è¡¨åœ°å€ï¼Œé‡æ–°è®¾ç½®äº†ç¨‹åºçš„ä»£ç æ®µã€æ•°æ®æ®µ (ä½†ä¸ç«‹åˆ»åˆ†é…é¡µé¢ - Load on demand)ï¼Œå°† eip è®¾ç½®ä¸ºä»£ç æ®µçš„é¦–æ¡æŒ‡ä»¤å’¯ã€‚</p><p>è¿™æ ·ï¼Œä»ä¸­æ–­è¿”å›åï¼Œç”¨æˆ·æ€å †æ ˆ esp æŒ‡å‘äº†æ–°è®¾ç½®çš„ç¯å¢ƒå‚æ•°ï¼Œä» eip æŒ‡å‘çš„æ–°ç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œã€‚æ­¤æ—¶å¼•å‘ç¼ºé¡µï¼Œå†åˆ†é…é¡µé¢ï¼Œå°†æ–°ç¨‹åºçš„å¼€å¤´éƒ¨åˆ†è½½å…¥å†…å­˜ã€‚è¿™ä¸€å¥—æœºåˆ¶æœ‰ç‚¹å¤æ‚çš„å“¦ï¼Œä½†æŒºå·§å¦™çš„ ğŸ¤¤</p></blockquote><h3 id="_12-15-2-ä»£ç æ³¨é‡Š" tabindex="-1"><a class="header-anchor" href="#_12-15-2-ä»£ç æ³¨é‡Š"><span>12.15.2 ä»£ç æ³¨é‡Š</span></a></h3><h4 id="sys-uselib-æ›¿æ¢è¿›ç¨‹åº“æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨" tabindex="-1"><a class="header-anchor" href="#sys-uselib-æ›¿æ¢è¿›ç¨‹åº“æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨"><span>sys_uselib() - æ›¿æ¢è¿›ç¨‹åº“æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">sys_uselib</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> library<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span> inode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> base<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">get_limit</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span> <span class="token operator">!=</span> TASK_SIZE<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// å½“å‰è¿›ç¨‹æ˜¯å¦ä¸ºæ™®é€šè¿›ç¨‹</span></span>
<span class="line">        <span class="token comment">// æ™®é€šè¿›ç¨‹çš„é•¿åº¦è¢«è®¾ç½®ä¸º TASK_SIZE (64MB)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>library<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>inode <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>library<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// åº“æ–‡ä»¶ inode</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span></span>
<span class="line">        inode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ”¾å›åŸåº“æ–‡ä»¶ inode</span></span>
<span class="line">    <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>library<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>library <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// é‡Šæ”¾åº“ä»£ç å ç”¨çš„å†…å­˜é¡µ</span></span>
<span class="line">    base <span class="token operator">=</span> <span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    base <span class="token operator">+=</span> LIBRARY_OFFSET<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free_page_tables</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> LIBRARY_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    current<span class="token operator">-&gt;</span>library <span class="token operator">=</span> inode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="create-tables-åˆ›å»ºå‚æ•°æŒ‡é’ˆè¡¨" tabindex="-1"><a class="header-anchor" href="#create-tables-åˆ›å»ºå‚æ•°æŒ‡é’ˆè¡¨"><span>create_tables() - åˆ›å»ºå‚æ•°æŒ‡é’ˆè¡¨</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> <span class="token function">create_tables</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> p<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">int</span> envc<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token operator">*</span>envp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> sp<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    sp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0xfffffffc</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    sp <span class="token operator">-=</span> envc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// sp å‘ä¸‹ç§»åŠ¨ç•™å‡ºç¯å¢ƒå˜é‡çš„æ‰€æœ‰æŒ‡é’ˆç©ºé—´ (åŒ…æ‹¬ä¸€ä¸ª NULL)</span></span>
<span class="line">    envp <span class="token operator">=</span> sp<span class="token punctuation">;</span> <span class="token comment">// envp æŒ‡å‘ç¯å¢ƒå˜é‡æŒ‡é’ˆè¡¨</span></span>
<span class="line">    sp <span class="token operator">-=</span> argc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// sp å‘ä¸‹ç§»åŠ¨ç•™å‡ºå‘½ä»¤è¡Œå‚æ•°çš„æ‰€æœ‰æŒ‡é’ˆç©ºé—´ (åŒ…æ‹¬ä¸€ä¸ª NULL)</span></span>
<span class="line">    argv <span class="token operator">=</span> sp<span class="token punctuation">;</span> <span class="token comment">// argv æŒ‡å‘å‘½ä»¤è¡Œå‚æ•°æŒ‡é’ˆè¡¨</span></span>
<span class="line">    <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> envp<span class="token punctuation">,</span> <span class="token operator">--</span>sp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¯å¢ƒå˜é‡æŒ‡é’ˆè¡¨æŒ‡é’ˆ</span></span>
<span class="line">    <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> argv<span class="token punctuation">,</span> <span class="token operator">--</span>sp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å‘½ä»¤è¡Œå‚æ•°æŒ‡é’ˆè¡¨æŒ‡é’ˆ</span></span>
<span class="line">    <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> argc<span class="token punctuation">,</span> <span class="token operator">--</span>sp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>argc<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> p<span class="token punctuation">,</span> argv<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">get_fs_byte</span><span class="token punctuation">(</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// next string</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// argv è¡¨çš„æœ€åæ˜¯ NULL</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>envc<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> p<span class="token punctuation">,</span> envp<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">get_fs_byte</span><span class="token punctuation">(</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// next string</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// envp è¡¨çš„æœ€åæ˜¯ NULL</span></span>
<span class="line">    <span class="token keyword">return</span> sp<span class="token punctuation">;</span> <span class="token comment">// è¿”å›æ–°æ ˆæŒ‡é’ˆ</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="count-è®¡ç®—å‘½ä»¤è¡Œå‚æ•°-ç¯å¢ƒå˜é‡çš„ä¸ªæ•°" tabindex="-1"><a class="header-anchor" href="#count-è®¡ç®—å‘½ä»¤è¡Œå‚æ•°-ç¯å¢ƒå˜é‡çš„ä¸ªæ•°"><span>count() - è®¡ç®—å‘½ä»¤è¡Œå‚æ•°/ç¯å¢ƒå˜é‡çš„ä¸ªæ•°</span></a></h4><p>æŒ‡é’ˆè¡¨ä¸­çš„æœ€åä¸€ä¸ªæŒ‡é’ˆé¡¹ä¸º NULLã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> tmp<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> argv<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">get_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>tmp<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            i<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> i<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="copy-strings-æ‹·è´å‚æ•°-ç¯å¢ƒå­—ç¬¦ä¸²" tabindex="-1"><a class="header-anchor" href="#copy-strings-æ‹·è´å‚æ•°-ç¯å¢ƒå­—ç¬¦ä¸²"><span>copy_strings() - æ‹·è´å‚æ•°/ç¯å¢ƒå­—ç¬¦ä¸²</span></a></h4><p>å¢åŠ äº† <code>from_kmem</code> å‚æ•°ï¼ŒæŒ‡æ˜äº†å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„æ˜¯æ¥è‡ªç”¨æˆ·ç«¯è¿˜æ˜¯å†…æ ¸æ®µï¼š</p><table><thead><tr><th>from_kmem</th><th>æŒ‡é’ˆ argv *</th><th>å­—ç¬¦ä¸² argv **</th></tr></thead><tbody><tr><td>0</td><td>User space</td><td>User space</td></tr><tr><td>1</td><td>Kernel space</td><td>User space</td></tr><tr><td>2</td><td>Kernel space</td><td>Kernel space</td></tr></tbody></table><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ‰€æœ‰å‚æ•°å­—ç¬¦ä¸²éƒ½åœ¨ç”¨æˆ·ç©ºé—´ä¸­</p><blockquote><p>æ³¨æ„ï¼Œ<code>get_fs_long()</code> æ˜¯å°† fs æŒ‡å‘æ®µä¸­çš„ long æ•°æ®æ‹·è´åˆ° ds æŒ‡å‘æ®µä¸­ã€‚å› æ­¤ï¼Œå¦‚æœè¢«æ‹·è´çš„æ•°æ®åœ¨å†…æ ¸æ•°æ®æ®µï¼Œéœ€è¦è®© fs æŒ‡å‘å†…æ ¸ç©ºé—´ã€‚</p></blockquote><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">copy_strings</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> unsinged <span class="token keyword">long</span> <span class="token operator">*</span>page<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> p<span class="token punctuation">,</span> <span class="token keyword">int</span> from_kmem<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span>tmp<span class="token punctuation">,</span> <span class="token operator">*</span>pag<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> len<span class="token punctuation">,</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> old_fs<span class="token punctuation">,</span> new_fs<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    new_fs <span class="token operator">=</span> <span class="token function">get_ds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ®µå¯„å­˜å™¨ ds æŒ‡å‘å†…æ ¸æ•°æ®æ®µ</span></span>
<span class="line">    old_fs <span class="token operator">=</span> <span class="token function">get_fs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ®µå¯„å­˜å™¨ fs æŒ‡å‘ç”¨æˆ·æ•°æ®æ®µ</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>from_kmem <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">set_fs</span><span class="token punctuation">(</span>new_fs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä½¿ fs æŒ‡å‘å†…æ ¸ç©ºé—´</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>argc<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>from_kmem <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// è‹¥ argv æŒ‡å‘å†…æ ¸ç©ºé—´ï¼Œåˆ™ä½¿ fs æŒ‡å‘å†…æ ¸ç©ºé—´</span></span>
<span class="line">            <span class="token function">set_fs</span><span class="token punctuation">(</span>new_fs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tmp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">get_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> argv<span class="token punctuation">)</span> <span class="token operator">+</span> argc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;argc is wrong&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>from_kmem <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">set_fs</span><span class="token punctuation">(</span>old_fs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fs æŒ‡å›ç”¨æˆ·ç©ºé—´</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// tmp ä¸ºå­—ç¬¦ä¸²æŒ‡é’ˆï¼ŒæŒ‡å‘å‚æ•°å­—ç¬¦ä¸²</span></span>
<span class="line">        <span class="token comment">// ä»ç”¨æˆ·ç©ºé—´å–å­—ç¬¦ä¸²</span></span>
<span class="line">        len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">do</span> <span class="token punctuation">{</span></span>
<span class="line">            len<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">get_fs_byte</span><span class="token punctuation">(</span>tmp<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ç»Ÿè®¡äº†å­—ç¬¦ä¸²çš„é•¿åº¦</span></span>
<span class="line">        <span class="token comment">// æ­¤æ—¶ tmp æŒ‡å‘å­—ç¬¦ä¸²å°¾</span></span>
<span class="line">        <span class="token comment">// å­—ç¬¦ä¸²æ­¤æ—¶åº”å½“ä½äºå†…æ ¸ç©ºé—´ä¸­</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä¸å¤ªå¯èƒ½å‘ç”Ÿ</span></span>
<span class="line">            <span class="token function">set_fs</span><span class="token punctuation">(</span>old_fs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// å°†å­—ç¬¦ä¸²é€ä¸ªå­—ç¬¦å¤åˆ¶åˆ°å‚æ•°å’Œç¯å¢ƒç©ºé—´æœ«ç«¯</span></span>
<span class="line">        <span class="token comment">// é¦–å…ˆåˆ¤æ–­ç›¸åº”ä½ç½®æ˜¯å¦å·²æœ‰å†…å­˜é¡µé¢</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token operator">--</span>p<span class="token punctuation">;</span> <span class="token operator">--</span>tmp<span class="token punctuation">;</span> <span class="token operator">--</span>len<span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// offset ä¸ºé¡µé¢ä¸­çš„åç§»</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>offset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                offset <span class="token operator">=</span> p <span class="token operator">%</span> PAGE_SIZE<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>from_kmem <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token function">set_fs</span><span class="token punctuation">(</span>old_fs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pag <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> page<span class="token punctuation">[</span>p<span class="token operator">/</span>PAGE_SIZE<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">                    <span class="token operator">!</span><span class="token punctuation">(</span>pag <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> page<span class="token punctuation">[</span>p<span class="token operator">/</span>PAGE_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">get_free_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>from_kmem <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token function">set_fs</span><span class="token punctuation">(</span>old_fs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token operator">*</span><span class="token punctuation">(</span>pag <span class="token operator">+</span> offset<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">get_fs_byte</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>from_kmem <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">set_fs</span><span class="token punctuation">(</span>old_fs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> p<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ“¦ è¿™åŠæ¯›å‡½æ•°åˆ°åº• tm ä»€ä¹ˆæ„æ€å•Šï¼Ÿï¼Ÿï¼Ÿ</p></blockquote><h4 id="change-ldt-ä¿®æ”¹ä»»åŠ¡çš„-ldt" tabindex="-1"><a class="header-anchor" href="#change-ldt-ä¿®æ”¹ä»»åŠ¡çš„-ldt"><span>change_ldt() - ä¿®æ”¹ä»»åŠ¡çš„ LDT</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">change_ldt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> text_size<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> page<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> code_limit<span class="token punctuation">,</span> data_limit<span class="token punctuation">,</span> code_base<span class="token punctuation">,</span> data_base<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»£ç æ®µå’Œæ•°æ®æ®µé•¿åº¦è®¾ç½®ä¸º 64MB</span></span>
<span class="line">    code_limit <span class="token operator">=</span> TASK_SIZE<span class="token punctuation">;</span></span>
<span class="line">    data_limit <span class="token operator">=</span> TASK_SIZE<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// é‡æ–°è®¾ç½® LDT ä¸­ä»£ç æ®µå’Œæ•°æ®æ®µçš„åŸºå€å’Œæ®µé™é•¿</span></span>
<span class="line">    code_base <span class="token operator">=</span> <span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    data_base <span class="token operator">=</span> code_base<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">set_limit</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> code_limit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">set_limit</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data_limit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å°†å‚æ•°å’Œç¯å¢ƒç©ºé—´ä¸­å·²å­˜æ”¾æ•°æ®çš„é¡µé¢æ”¾åˆ°æ•°æ®æ®µæœ«ç«¯</span></span>
<span class="line">    <span class="token comment">// ä»è¿›ç¨‹ç©ºé—´åº“ä»£ç å¼€å§‹å¤„é€†å‘ä¸€é¡µä¸€é¡µåœ°æ”¾ (åº“ä»£ç å ç”¨è¿›ç¨‹ç©ºé—´æœ«ç«¯ 4MB éƒ¨åˆ†)</span></span>
<span class="line">    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">&quot;push $0x17\\n\\tpop %%fs&quot;</span><span class="token operator">::</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    data_base <span class="token operator">+=</span> data_limit <span class="token operator">-</span> LIBRARY_SIZE<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> MAX_ARG_PAGES <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        data_base <span class="token operator">-=</span> PAGE_SIZE<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">put_dirty_page</span><span class="token punctuation">(</span>page<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> data_base<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> data_limit<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>æ–°æ‰§è¡Œçš„ç¨‹åºå’ŒåŸç¨‹åºä½¿ç”¨çš„æ®µåŸºå€ä¸åŸç¨‹åºç›¸åŒï¼Œæ‰€æœ‰ä¸ç”¨å†é‡æ–°è®¾ç½®æ®µåŸºå€äº†ï¼Œåªéœ€è¦è®¾ç½®æ®µé™é•¿ã€‚</p></blockquote><h4 id="do-execve-execve-ç³»ç»Ÿä¸­æ–­è°ƒç”¨å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#do-execve-execve-ç³»ç»Ÿä¸­æ–­è°ƒç”¨å‡½æ•°"><span>do_execve() - execve ç³»ç»Ÿä¸­æ–­è°ƒç”¨å‡½æ•°</span></a></h4><p>å‡½æ•°çš„å‚æ•°å…¨éƒ¨ç”±æ±‡ç¼–å‹å…¥å †æ ˆã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">do_execve</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> eip<span class="token punctuation">,</span> <span class="token keyword">long</span> tmp<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> envp<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">m_inode</span> <span class="token operator">*</span> inode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> page<span class="token punctuation">[</span>MAX_ARG_PAGES<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> envc<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> e_uid<span class="token punctuation">,</span> e_gid<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> retval<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> sh_bang <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æ˜¯å¦éœ€è¦æ‰§è¡Œè„šæœ¬ç¨‹åº</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> p <span class="token operator">=</span> PAGE_SIZE <span class="token operator">*</span> MAX_ARG_PAGES <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å†…æ ¸å‡†å¤‡äº† 32 ä¸ª page (128kB) å­˜æ”¾å‚æ•°å’Œç¯å¢ƒå­—ç¬¦ä¸²</span></span>
<span class="line">    <span class="token comment">// p è¢«åˆå§‹åŒ–æŒ‡å‘ 128kB ç©ºé—´çš„æœ€åä¸€ä¸ªé•¿å­—</span></span>
<span class="line">    <span class="token comment">// p æŒ‡æ˜åœ¨ 128kB ä¸­çš„å½“å‰ä½ç½®</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0xffff</span> <span class="token operator">&amp;</span> eip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x000f</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// CS å¯„å­˜å™¨åº”å½“æŒ‡å‘å½“å‰ä»»åŠ¡çš„æ®µé€‰æ‹©ç¬¦ 0x000f</span></span>
<span class="line">        <span class="token comment">// è‹¥ä¸æ˜¯ï¼Œåˆ™åªå¯èƒ½æ˜¯å†…æ ¸ä»£ç æ®µï¼Œä½†å†…æ ¸ä»£ç æ˜¯ä¸èƒ½è¢« execve æ›¿æ¢çš„</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;execve called from supervisor mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_ARG_PAGES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// é¡µé¢æ¸…é›¶</span></span>
<span class="line">        page<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>inode <span class="token operator">=</span> <span class="token function">namei</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// å–æ‰§è¡Œæ–‡ä»¶çš„ inode</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span></span>
<span class="line">    argc <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¡ç®—å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°</span></span>
<span class="line">    envc <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span>envp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¡ç®—ç¯å¢ƒå­—ç¬¦ä¸²å˜é‡ä¸ªæ•°</span></span>
<span class="line">    </span>
<span class="line">restart_interp<span class="token operator">:</span></span>
<span class="line">    <span class="token comment">// è¦æ‰§è¡Œçš„å¿…é¡»æ˜¯ä¸€ä¸ªæ–‡ä»¶</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        retval <span class="token operator">=</span> <span class="token operator">-</span>EACCES<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exec_error2<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æƒé™åˆ¤æ–­</span></span>
<span class="line">    i <span class="token operator">=</span> inode<span class="token operator">-&gt;</span>i_mode<span class="token punctuation">;</span></span>
<span class="line">    e_uid <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> S_ISUID<span class="token punctuation">)</span> <span class="token operator">?</span> inode<span class="token operator">-&gt;</span>i_uid <span class="token operator">:</span> current<span class="token operator">-&gt;</span>euid<span class="token punctuation">;</span></span>
<span class="line">    e_gid <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> S_ISGID<span class="token punctuation">)</span> <span class="token operator">?</span> inode<span class="token operator">-&gt;</span>i_gid <span class="token operator">:</span> current<span class="token operator">-&gt;</span>egid<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>euid <span class="token operator">==</span> inode<span class="token operator">-&gt;</span>i_uid<span class="token punctuation">)</span></span>
<span class="line">        i <span class="token operator">&gt;&gt;=</span> <span class="token number">6</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_group_p</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_gid<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        i <span class="token operator">&gt;&gt;=</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_mode <span class="token operator">&amp;</span> <span class="token number">0111</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">suser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        retval <span class="token operator">=</span> <span class="token operator">-</span>ENOEXEC<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exec_error2<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æƒé™æ£€æŸ¥é€šè¿‡</span></span>
<span class="line">    <span class="token comment">// å–å‡ºæ–‡ä»¶é¦–éƒ¨çš„æ•°æ®</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bh <span class="token operator">=</span> <span class="token function">bread</span><span class="token punctuation">(</span>inode<span class="token operator">-&gt;</span>i_dev<span class="token punctuation">,</span> inode<span class="token operator">-&gt;</span>i_zone<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        retval <span class="token operator">=</span> <span class="token operator">-</span>EACCES<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exec_error2<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    ex <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">exec</span> <span class="token operator">*</span><span class="token punctuation">)</span> bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// exec å¤´éƒ¨</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">&#39;#&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">&#39;!&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>sh_bang<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ–‡ä»¶å¤´éƒ¨ä»¥ #! å¼€å¤´</span></span>
<span class="line">        <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ–‡ä»¶å¤´éƒ¨å·²è¢«æ‹·è´åˆ° exec ä¸­ï¼Œå…ˆé‡Šæ”¾ç¼“å†²å—</span></span>
<span class="line">    <span class="token comment">// æ–‡ä»¶åˆæ³•æ€§çš„åˆ¤æ–­</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">N_MAGIC</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token operator">!=</span> ZMAGIC <span class="token operator">||</span></span>
<span class="line">        ex<span class="token punctuation">.</span>a_trsize <span class="token operator">||</span></span>
<span class="line">        ex<span class="token punctuation">.</span>a_drsize <span class="token operator">||</span></span>
<span class="line">        ex<span class="token punctuation">.</span>a_text <span class="token operator">+</span> ex<span class="token punctuation">.</span>a_data <span class="token operator">+</span> ex<span class="token punctuation">.</span>a_bss <span class="token operator">&gt;</span> <span class="token number">0x3000000</span> <span class="token operator">||</span></span>
<span class="line">        inode<span class="token operator">-&gt;</span>i_size <span class="token operator">&lt;</span> ex<span class="token punctuation">.</span>a_text <span class="token operator">+</span> ex<span class="token punctuation">.</span>a_data <span class="token operator">+</span> ex<span class="token punctuation">.</span>a_syms <span class="token operator">+</span> <span class="token function">N_TXTOFF</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        retval <span class="token operator">=</span> <span class="token operator">-</span>ENOEXEC<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exec_error2<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// æ‰§è¡Œæ–‡ä»¶ä¸­ä»£ç å¼€å§‹å¤„ä¸ä½äºé¡µè¾¹ç•Œ</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">N_TXTOFF</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token operator">!=</span> BLOCK_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;%s: N_TXTOFF != BLOCK_SIZE. See a.out.h.&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        retval <span class="token operator">=</span> <span class="token operator">-</span>ENOEXEC<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">goto</span> exec_error2<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sh_bang<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¤åˆ¶å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå­—ç¬¦ä¸²åˆ°å¯¹åº”å†…å­˜ç©ºé—´ä¸­</span></span>
<span class="line">        p <span class="token operator">=</span> <span class="token function">copy_strings</span><span class="token punctuation">(</span>envc<span class="token punctuation">,</span> envp<span class="token punctuation">,</span> page<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        p <span class="token operator">=</span> <span class="token function">copy_strings</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> page<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">goto</span> exec_error2<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>executable<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>executable<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ”¾å›åŸæ‰§è¡Œç¨‹åºçš„ inode</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>executable <span class="token operator">=</span> inode<span class="token punctuation">;</span> <span class="token comment">// è®¾ç½®æ–°çš„æ‰§è¡Œæ–‡ä»¶ inode</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>signal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å¤ä½æ‰€æœ‰ä¿¡å·</span></span>
<span class="line">    <span class="token comment">// å¤„ç†æ‰€æœ‰ä¿¡å·</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        current<span class="token operator">-&gt;</span>sigaction<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sa_make <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        current<span class="token operator">-&gt;</span>sigaction<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>sigaction<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sa_handler <span class="token operator">!=</span> SIG_IGN<span class="token punctuation">)</span></span>
<span class="line">            current<span class="token operator">-&gt;</span>sigaction<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// å…³é—­æ‰“å¼€çš„æ–‡ä»¶ (æ ¹æ® close_on_exec æ ‡å¿—)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_OPEN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>close_on_exec <span class="token operator">&gt;&gt;</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">sys_close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>close_on_exec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é‡Šæ”¾åŸæ¥ç¨‹åºçš„ä»£ç æ®µå’Œæ•°æ®æ®µæ‰€å¯¹åº”çš„ç‰©ç†é¡µé¢å’Œé¡µè¡¨</span></span>
<span class="line">    <span class="token function">free_page_tables</span><span class="token punctuation">(</span><span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">get_limit</span><span class="token punctuation">(</span><span class="token number">0x0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">free_page_tables</span><span class="token punctuation">(</span><span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">get_limit</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// å¦‚æœåŸè¿›ç¨‹ä½¿ç”¨äº†åå¤„ç†å™¨</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>last_task_used_math <span class="token operator">==</span> current<span class="token punctuation">)</span></span>
<span class="line">        last_task_used_math <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>used_math <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// åœ¨æ ˆç©ºé—´ä¸­åˆ›å»ºæŒ‡é’ˆè¡¨ï¼Œå…± main() ä½¿ç”¨</span></span>
<span class="line">    p <span class="token operator">+=</span> <span class="token function">change_ldt</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>a_text<span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    p <span class="token operator">-=</span> LIBRARY_SIZE <span class="token operator">+</span> MAX_ARG_PAGES <span class="token operator">*</span> PAGE_SIZE<span class="token punctuation">;</span></span>
<span class="line">    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">create_tables</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> p<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> envc<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä¿®æ”¹è¿›ç¨‹ PCB</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>brk <span class="token operator">=</span> ex<span class="token punctuation">.</span>a_bss <span class="token operator">+</span></span>
<span class="line">        <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>end_data <span class="token operator">=</span> ex<span class="token punctuation">.</span>a_data <span class="token operator">+</span></span>
<span class="line">         <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>end_code <span class="token operator">=</span> ex<span class="token punctuation">.</span>a_text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>start_stack <span class="token operator">=</span> p <span class="token operator">&amp;</span> <span class="token number">0xfffff000</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>suid <span class="token operator">=</span> current<span class="token operator">-&gt;</span>euid <span class="token operator">=</span> e_uid<span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>sgid <span class="token operator">=</span> current<span class="token operator">-&gt;</span>egid <span class="token operator">=</span> e_gid<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    eip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> ex<span class="token punctuation">.</span>a_entry<span class="token punctuation">;</span> <span class="token comment">// eip æŒ‡å‘ç¨‹åºå…¥å£åœ°å€</span></span>
<span class="line">    eip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// esp æŒ‡å‘å‚æ•°è¡¨é¡¶ç«¯</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">exec_error2<span class="token operator">:</span></span>
<span class="line">    <span class="token function">iput</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">exec_error1<span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_ARG_PAGES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">free_page</span><span class="token punctuation">(</span>page<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,46)]))}const k=s(l,[["render",i],["__file","Chapter 12.15 - exec.c ç¨‹åº.html.vue"]]),d=JSON.parse('{"path":"/linux-kernel-comments-notes/Chapter%2012%20-%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/Chapter%2012.15%20-%20exec.c%20%E7%A8%8B%E5%BA%8F.html","title":"Chapter 12.15 - exec.c ç¨‹åº","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"12.15 exec.c ç¨‹åº","slug":"_12-15-exec-c-ç¨‹åº","link":"#_12-15-exec-c-ç¨‹åº","children":[{"level":3,"title":"12.15.1 åŠŸèƒ½æè¿°","slug":"_12-15-1-åŠŸèƒ½æè¿°","link":"#_12-15-1-åŠŸèƒ½æè¿°","children":[]},{"level":3,"title":"12.15.2 ä»£ç æ³¨é‡Š","slug":"_12-15-2-ä»£ç æ³¨é‡Š","link":"#_12-15-2-ä»£ç æ³¨é‡Š","children":[]}]}],"git":{},"filePathRelative":"linux-kernel-comments-notes/Chapter 12 - æ–‡ä»¶ç³»ç»Ÿ/Chapter 12.15 - exec.c ç¨‹åº.md"}');export{k as comp,d as data};
