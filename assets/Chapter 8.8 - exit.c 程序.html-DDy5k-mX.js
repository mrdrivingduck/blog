import{_ as s}from"./5-20-XR9q3PuR.js";import{_ as a,c as p,a as t,o as e}from"./app-BeHGwf2X.js";const o={};function l(c,n){return e(),p("div",null,n[0]||(n[0]=[t('<h1 id="chapter-8-8-exit-c-ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#chapter-8-8-exit-c-ç¨‹åº"><span>Chapter 8.8 - exit.c ç¨‹åº</span></a></h1><p>Created by : Mr Dk.</p><p>2019 / 08 / 20 17:43</p><p>Ningbo, Zhejiang, China</p><hr><h2 id="_8-8-exit-c-ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#_8-8-exit-c-ç¨‹åº"><span>8.8 exit.c ç¨‹åº</span></a></h2><h3 id="_8-8-1-åŠŸèƒ½æè¿°" tabindex="-1"><a class="header-anchor" href="#_8-8-1-åŠŸèƒ½æè¿°"><span>8.8.1 åŠŸèƒ½æè¿°</span></a></h3><p>ä¸»è¦å®ç°è¿›ç¨‹ç»ˆæ­¢å’Œé€€å‡ºçš„ç›¸å…³å¤„ç†äº‹å®œã€‚</p><h3 id="_8-8-2-ä»£ç æ³¨é‡Š" tabindex="-1"><a class="header-anchor" href="#_8-8-2-ä»£ç æ³¨é‡Š"><span>8.8.2 ä»£ç æ³¨é‡Š</span></a></h3><h4 id="release-å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#release-å‡½æ•°"><span>release() å‡½æ•°</span></a></h4><p>åœ¨ <code>sys_kill()</code> å’Œ <code>sys_waitpid()</code> ç³»ç»Ÿè°ƒç”¨ä¸­è¢«è°ƒç”¨ï¼Œé‡Šæ”¾è¿›ç¨‹å ç”¨çš„ä»»åŠ¡æ•°ç»„é¡¹ï¼Œä»¥åŠ TSS å ç”¨çš„å†…å­˜é¡µé¢ï¼š</p><ul><li>æ‰«æä»»åŠ¡æ•°ç»„æŒ‡é’ˆè¡¨</li><li>å¦‚æœæ‰¾åˆ°ï¼Œæ¸…ç©ºä»»åŠ¡æ§½ï¼Œé‡Šæ”¾ä»»åŠ¡æ•°æ®ç»“æ„å ç”¨çš„å†…å­˜é¡µé¢</li><li>æ‰§è¡Œè°ƒåº¦å‡½æ•°ï¼Œåœ¨è¿”å›æ—¶ç«‹åˆ»é€€å‡º</li></ul><p>å¦‚æœè¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šä»»åŠ¡å¯¹åº”çš„é¡¹ï¼Œåˆ™å†…æ ¸ panicï¼Œå°†ä»»åŠ¡ p ä»è¿›ç¨‹åŒå‘é“¾è¡¨ä¸­åˆ é™¤ï¼š</p><p><img src="'+s+`" alt="5-20"></p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span> p<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// ä»»åŠ¡æŒ‡é’ˆä¸º NULL</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">&quot;task releasing itself\\n\\r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_TASKS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            task<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ›´æ–°è¿›ç¨‹é“¾è¡¨çš„é“¾æ¥</span></span>
<span class="line">            <span class="token comment">// å°†ä»»åŠ¡ p ä»åŒå‘é“¾è¡¨ä¸­åˆ é™¤</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>p_osptr<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// ä¸æ˜¯æœ€è€å­è¿›ç¨‹</span></span>
<span class="line">                p<span class="token operator">-&gt;</span>p_osptr<span class="token operator">-&gt;</span>p_ysptr <span class="token operator">=</span> p<span class="token operator">-&gt;</span>p_ysptr<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>p_ysptr<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// ä¸æ˜¯æœ€æ–°å­è¿›ç¨‹</span></span>
<span class="line">                p<span class="token operator">-&gt;</span>p_ysptr<span class="token operator">-&gt;</span>p_osptr <span class="token operator">=</span> p<span class="token operator">-&gt;</span>p_osptr<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">else</span></span>
<span class="line">                <span class="token comment">// æœ€æ–°å­è¿›ç¨‹éœ€è¦è®¾ç½®çˆ¶è¿›ç¨‹æŒ‡é’ˆ</span></span>
<span class="line">                p<span class="token operator">-&gt;</span>p_pptr<span class="token operator">-&gt;</span>p_cptr <span class="token operator">=</span> p<span class="token operator">-&gt;</span>p_osptr<span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token function">free_page</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">   <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;trying to release non-existent task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ£€æŸ¥è¿›ç¨‹æ ‘-è°ƒè¯•å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#æ£€æŸ¥è¿›ç¨‹æ ‘-è°ƒè¯•å‡½æ•°"><span>æ£€æŸ¥è¿›ç¨‹æ ‘ - è°ƒè¯•å‡½æ•°</span></a></h4><p>ä¸‹é¢çš„éƒ¨åˆ†æ˜¯æ¡ä»¶ç¼–è¯‘çš„ï¼Œä»…åœ¨è°ƒè¯•æ—¶ä½¿ç”¨ã€‚å› ä¸ºè¿™ä¸ªå‡½æ•°å¾ˆæ…¢ï¼š</p><ul><li>éªŒè¯ p_ysptr å’Œ p_osptr æ„æˆçš„åŒå‘é“¾è¡¨</li><li>æ£€æŸ¥ p_cptr å’Œ p_pptr æ„æˆçš„è¿›ç¨‹æ ‘</li></ul><p>é€»è¾‘æœ‰äº›æ— èŠï¼Œæˆ‘ä¸ä¹æ„å†™ã€‚</p><h4 id="send-sig-å‘ä»»åŠ¡å‘é€ä¿¡å·" tabindex="-1"><a class="header-anchor" href="#send-sig-å‘ä»»åŠ¡å‘é€ä¿¡å·"><span>send_sig() - å‘ä»»åŠ¡å‘é€ä¿¡å·</span></a></h4><p>é¦–å…ˆåˆ¤æ–­å‚æ•°çš„æ­£ç¡®æ€§ã€‚åˆ¤æ–­æ¡ä»¶æ˜¯å¦èƒ½å¤Ÿæ»¡è¶³ - æ˜¯å¦æœ‰å‘é€ä¿¡å·çš„æƒåˆ©ã€‚å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œå°±å‘æŒ‡å®šçš„è¿›ç¨‹å‘é€ä¿¡å·ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">send_sig</span><span class="token punctuation">(</span><span class="token keyword">long</span> sig<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">int</span> priv<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// æ²¡æœ‰æƒé™ &amp;&amp; å½“å‰è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID å’Œ p ä¸åŒ &amp;&amp; ä¸æ˜¯è¶…çº§ç”¨æˆ·</span></span>
<span class="line">    <span class="token comment">// suser() - (current-&gt;euid == 0)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>euid <span class="token operator">!=</span> p<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">suser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¦‚æœå‘é€çš„ä¿¡å·æ˜¯ SIGKILL æˆ– SIGCONT</span></span>
<span class="line">    <span class="token comment">// å¦‚æœæ­¤æ—¶ p å¤„äºåœæ­¢çŠ¶æ€ï¼Œå°±ç½®å…¶ä¸ºå°±ç»ªçŠ¶æ€</span></span>
<span class="line">    <span class="token comment">// ä¿®æ”¹è¿›ç¨‹çš„ä¿¡å· bitmapï¼Œå»æ‰ä¼šå¯¼è‡´è¿›ç¨‹åœæ­¢çš„ä¿¡å·</span></span>
<span class="line">    <span class="token comment">//   -- SIGSTOP, SIGTSTP, SIGTTIN, SIGTTOU</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sig <span class="token operator">==</span> SIGKILL<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>sig <span class="token operator">==</span> SIGCONT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>state <span class="token operator">==</span> TASK_STOPPED<span class="token punctuation">)</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_RUNNING<span class="token punctuation">;</span></span>
<span class="line">        p<span class="token operator">-&gt;</span>exit_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        p<span class="token operator">-&gt;</span>signal <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGSTOP<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGTSTP<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span></span>
<span class="line">                        <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGTTIN<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGTTOU<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å‘é€çš„ä¿¡å·è¢«è¿›ç¨‹å¿½ç•¥ï¼Œå› æ­¤ä¸éœ€è¦å‘é€ä¿¡å·</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> p<span class="token operator">-&gt;</span>sigaction<span class="token punctuation">[</span>sig<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sa_handler <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¦‚æœä¿¡å·æ˜¯ SIGSTOPã€SIGTSTPã€SIGTTINã€SIGTTOU ä¹‹ä¸€</span></span>
<span class="line">    <span class="token comment">// å°±è¦è®©æ¥æ”¶ä¿¡å·çš„è¿›ç¨‹åœæ­¢è¿è¡Œ</span></span>
<span class="line">    <span class="token comment">// å› æ­¤è¿˜è¦å¤ä½è®©è¿›ç¨‹ç»§ç»­è¿è¡Œçš„ä¿¡å· - SIGCONT</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sig <span class="token operator">&gt;=</span> SIGSTOP<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sig <span class="token operator">&lt;=</span> SIGTTOU<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        p<span class="token operator">-&gt;</span>signal <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGCONT<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å‘é€ä¿¡å·</span></span>
<span class="line">    p<span class="token operator">-&gt;</span>signal <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>sig<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="session-of-pgrp-æ ¹æ®è¿›ç¨‹ç»„å·å–å¾—è¿›ç¨‹æ‰€å±ä¼šè¯å·" tabindex="-1"><a class="header-anchor" href="#session-of-pgrp-æ ¹æ®è¿›ç¨‹ç»„å·å–å¾—è¿›ç¨‹æ‰€å±ä¼šè¯å·"><span>session_of_pgrp() - æ ¹æ®è¿›ç¨‹ç»„å·å–å¾—è¿›ç¨‹æ‰€å±ä¼šè¯å·</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">session_of_pgrp</span><span class="token punctuation">(</span><span class="token keyword">int</span> pgrp<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>LAST_TASK<span class="token punctuation">;</span> p <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>FIRST_TASK<span class="token punctuation">;</span> <span class="token operator">--</span>p<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pgrp <span class="token operator">==</span> pgrp<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="kill-pg-å‘è¿›ç¨‹ç»„å‘é€ä¿¡å·" tabindex="-1"><a class="header-anchor" href="#kill-pg-å‘è¿›ç¨‹ç»„å‘é€ä¿¡å·"><span>kill_pg() - å‘è¿›ç¨‹ç»„å‘é€ä¿¡å·</span></a></h4><blockquote><p>æœ‰æ„æ€çš„æ˜¯ï¼ŒLinux é‡Œé¢çš„ kill å®é™…ä¸Šæ˜¯å‘è¿›ç¨‹æˆ–è¿›ç¨‹ç»„å‘é€ä¿¡å·ï¼Œè€Œä¸æ˜¯æ€æ­»è¿›ç¨‹çš„æ„æ€ã€‚åªæ˜¯å…¶ä¸­æœ‰ä¸€ä¸ªä¿¡å·å¯ä»¥æ€æ­»è¿›ç¨‹ã€‚</p></blockquote><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">kill_pg</span><span class="token punctuation">(</span><span class="token keyword">int</span> pgrp<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">int</span> priv<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> err<span class="token punctuation">,</span> retval <span class="token operator">=</span> <span class="token operator">-</span>ESRCH<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> found <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>sig <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> sig <span class="token operator">&gt;</span> <span class="token number">32</span> <span class="token operator">||</span> pgrp <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>LAST_TASK<span class="token punctuation">;</span> p <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>FIRST_TASK<span class="token punctuation">;</span> <span class="token operator">--</span>p<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pgrp <span class="token operator">==</span> pgrp<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>sig <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">send_sig</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> priv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// ä¿¡å·å‘é€å¤±è´¥ï¼Œè¿”å›å‘é€å¤±è´¥çš„é”™è¯¯ç </span></span>
<span class="line">                retval <span class="token operator">=</span> err<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">else</span></span>
<span class="line">                <span class="token comment">// ä¿¡å·å‘é€æˆåŠŸ</span></span>
<span class="line">                found<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span>found <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åªè¦æœ‰ä¸€æ¬¡ä¿¡å·å‘é€æˆåŠŸï¼Œå°±è¿”å› 0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="kill-proc-å‘è¿›ç¨‹å‘é€ä¿¡å·" tabindex="-1"><a class="header-anchor" href="#kill-proc-å‘è¿›ç¨‹å‘é€ä¿¡å·"><span>kill_proc() - å‘è¿›ç¨‹å‘é€ä¿¡å·</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">kill_proc</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">int</span> priv<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>sig <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> sig <span class="token operator">&gt;</span> <span class="token number">32</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>LAST_TASK<span class="token punctuation">;</span> p <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>FIRST_TASK<span class="token punctuation">;</span> <span class="token operator">--</span>p<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pid <span class="token operator">==</span> pid<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// å‘é€æˆåŠŸè¿”å› 0ï¼Œå‘é€å¤±è´¥è¿”å›å‡ºé”™å·</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span>sig <span class="token operator">?</span> <span class="token function">send_sig</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> priv<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span>ESRCH<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿›ç¨‹ä¸å­˜åœ¨</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="sys-kill-kill-ç³»ç»Ÿè°ƒç”¨" tabindex="-1"><a class="header-anchor" href="#sys-kill-kill-ç³»ç»Ÿè°ƒç”¨"><span>sys_kill() - kill ç³»ç»Ÿè°ƒç”¨</span></a></h4><p>å¯ç”¨äºå‘ä»»ä½•è¿›ç¨‹æˆ–è¿›ç¨‹ç»„å‘é€ä»»ä½•ä¿¡å·ï¼Œå¹¶éåªæ˜¯æ€æ­»è¿›ç¨‹ï¼š</p><ul><li>pid æ˜¯è¿›ç¨‹å· <ul><li>pid &gt; 0 : ä¿¡å·å‘é€ç»™ pid è¿›ç¨‹</li><li>pid = 0 : ä¿¡å·å‘é€ç»™å½“å‰è¿›ç¨‹çš„è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹</li><li>pid = -1 : ä¿¡å·å‘é€ç»™é™¤ init è¿›ç¨‹æ„å¤–çš„æ‰€æœ‰è¿›ç¨‹</li><li>pid &lt; -1 : ä¿¡å·å‘é€ç»™è¿›ç¨‹ç»„ -pid çš„æ‰€æœ‰è¿›ç¨‹</li></ul></li><li>sig æ˜¯è¦å‘é€çš„ä¿¡å· <ul><li>sig = 0 åˆ™ä¸å‘é€ä¿¡å·ï¼Œä½†ä»ä¼šè¿›è¡Œé”™è¯¯æ£€æŸ¥</li></ul></li></ul><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">sys_kill</span><span class="token punctuation">(</span><span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token operator">*</span>p <span class="token operator">=</span> NR_TASKS <span class="token operator">+</span> task<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> err<span class="token punctuation">,</span> retval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å½“å‰è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pid<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">kill_pg</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// é™¤ init è¿›ç¨‹ä¹‹å¤–çš„æ‰€æœ‰è¿›ç¨‹</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>p <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>FIRST_TASK<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">send_sig</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                retval <span class="token operator">=</span> err<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// è¿›ç¨‹ç»„ -pid ä¸­çš„æ‰€æœ‰è¿›ç¨‹</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">kill_pg</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// æ™®é€šçš„ä¿¡å·å‘é€</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">kill_proc</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="is-orphaned-pgrp-åˆ¤æ–­å­¤å„¿è¿›ç¨‹ç»„" tabindex="-1"><a class="header-anchor" href="#is-orphaned-pgrp-åˆ¤æ–­å­¤å„¿è¿›ç¨‹ç»„"><span>is_orphaned_pgrp() - åˆ¤æ–­å­¤å„¿è¿›ç¨‹ç»„</span></a></h4><p>ä¸¤ç§æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå¯èƒ½å¯¼è‡´è¿›ç¨‹ç»„å˜æˆå­¤å„¿ã€‚</p><ul><li>ç»„å¤–æœ€åä¸€ä¸ªè¿æ¥çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ç»ˆæ­¢</li><li>æœ€åä¸€ä¸ªçˆ¶è¿›ç¨‹çš„ç›´æ¥åè£”ç»ˆæ­¢</li></ul><p><img src="`+s+`" alt="5-20"></p><p>å­¤å„¿è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹ä¼šä¸å®ƒä»¬çš„ä½œä¸šæ§åˆ¶ shell æ–­å¼€è”ç³»ã€‚å› æ­¤ï¼Œå«æœ‰åœæ­¢çŠ¶æ€è¿›ç¨‹çš„å­¤å„¿è¿›ç¨‹ç»„éœ€è¦æ¥æ”¶åˆ°ä¸€ä¸ª SIGHUP ä¿¡å·å’Œä¸€ä¸ª SIGCONT ä¿¡å·ï¼ŒæŒ‡ç¤ºå®ƒä»¬å·²ç»ä»å®ƒä»¬çš„ä¼šè¯ä¸­æ–­å¼€è”ç³»ï¼š</p><ul><li>SIGHUP ä¿¡å·å°†å¯¼è‡´è¿›ç¨‹ç»ˆæ­¢</li><li>SIGCONT ä¿¡å·ä½¿è¿›ç¨‹ç»§ç»­è¿è¡Œ</li></ul><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// åˆ¤æ–­è¿›ç¨‹ç»„æ˜¯å¦æ˜¯å­¤å„¿è¿›ç¨‹</span></span>
<span class="line"><span class="token comment">// å¦‚æœä¸æ˜¯åˆ™è¿”å› 0ï¼Œå¦‚æœæ˜¯åˆ™è¿”å› 1</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">is_orphaned_pgrp</span><span class="token punctuation">(</span><span class="token keyword">int</span> pgrp<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>LAST_TASK<span class="token punctuation">;</span> p <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>FRIST_TASK<span class="token punctuation">;</span> <span class="token operator">--</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token operator">||</span>                           <span class="token comment">// ç©ºæ§½</span></span>
<span class="line">            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pgrp <span class="token operator">!=</span> pgrp<span class="token punctuation">)</span> <span class="token operator">||</span>            <span class="token comment">// ä¸æ˜¯æŒ‡å®šè¿›ç¨‹ç»„çš„æˆå‘˜</span></span>
<span class="line">            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>state <span class="token operator">==</span> TASK_ZOMBIE<span class="token punctuation">)</span> <span class="token operator">||</span>    <span class="token comment">// å·²ç»å¤„äºåƒµæ­»çŠ¶æ€</span></span>
<span class="line">            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>p_pptr<span class="token operator">-&gt;</span>pid <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment">// çˆ¶è¿›ç¨‹æ˜¯ init è¿›ç¨‹</span></span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span>                          <span class="token comment">// è·³è¿‡</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>p_pptr<span class="token operator">-&gt;</span>pgrp <span class="token operator">!=</span> pgrp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>           <span class="token comment">// çˆ¶è¿›ç¨‹ä¸å±äºè¿›ç¨‹ç»„</span></span>
<span class="line">            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>p_pptr<span class="token operator">-&gt;</span>session <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// å±äºåŒä¸€ä¸ªä¼šè¯</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                 <span class="token comment">// è‚¯å®šä¸æ˜¯å­¤å„¿</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¦åˆ™ï¼Œä¸€å®šæ˜¯å­¤å„¿è¿›ç¨‹ç»„</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è¿™ä¸€æ®µæ²¡çœ‹æ‡‚ ğŸ˜¥</p></blockquote><h4 id="has-stopped-jobs-åˆ¤æ–­è¿›ç¨‹ç»„ä¸­æ˜¯å¦å«æœ‰å¤„äºåœæ­¢çŠ¶æ€çš„ä½œä¸š" tabindex="-1"><a class="header-anchor" href="#has-stopped-jobs-åˆ¤æ–­è¿›ç¨‹ç»„ä¸­æ˜¯å¦å«æœ‰å¤„äºåœæ­¢çŠ¶æ€çš„ä½œä¸š"><span>has_stopped_jobs() - åˆ¤æ–­è¿›ç¨‹ç»„ä¸­æ˜¯å¦å«æœ‰å¤„äºåœæ­¢çŠ¶æ€çš„ä½œä¸š</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">has_stopped_jobs</span><span class="token punctuation">(</span><span class="token keyword">int</span> pgrp<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>LAST_TASK<span class="token punctuation">;</span> p <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>FIRST_TASK<span class="token punctuation">;</span> <span class="token operator">--</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pgrp <span class="token operator">!=</span> pgrp<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>state <span class="token operator">==</span> TASK_STOPPED<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="do-exit-ç¨‹åºé€€å‡ºå¤„ç†å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#do-exit-ç¨‹åºé€€å‡ºå¤„ç†å‡½æ•°"><span>do_exit() - ç¨‹åºé€€å‡ºå¤„ç†å‡½æ•°</span></a></h4><p>è¢« <code>exit()</code> ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°è°ƒç”¨ã€‚æ ¹æ®å½“å‰è¿›ç¨‹è‡ªèº«çš„ç‰¹æ€§è¿›è¡Œå¤„ç†ï¼Œå°†å½“å‰è¿›ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸ºåƒµæ­»çŠ¶æ€ã€‚è°ƒç”¨è°ƒåº¦å‡½æ•°æ‰§è¡Œå…¶å®ƒè¿›ç¨‹ï¼Œä¸å†è¿”å›ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">volatile</span> <span class="token keyword">void</span> <span class="token function">do_exit</span><span class="token punctuation">(</span><span class="token keyword">long</span> code<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é‡Šæ”¾å½“å‰è¿›ç¨‹ä»£ç æ®µå’Œæ•°æ®æ®µæ‰€å å†…å­˜é¡µ</span></span>
<span class="line">    <span class="token function">free_page_tables</span><span class="token punctuation">(</span><span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">get_limit</span><span class="token punctuation">(</span><span class="token number">0x0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä»£ç æ®µ</span></span>
<span class="line">    <span class="token function">free_page_tables</span><span class="token punctuation">(</span><span class="token function">get_base</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>ldt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">get_limit</span><span class="token punctuation">(</span><span class="token number">0x17</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ•°æ®æ®µ</span></span>
<span class="line">    <span class="token comment">// å…³é—­è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_OPEN<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>filp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">sys_close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// inode ä»¥åŠåº“æ–‡ä»¶çš„åŒæ­¥æ“ä½œ</span></span>
<span class="line">    <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pwd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>pwd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>root <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>executable<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>executable <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">iput</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>library<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>library <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®è¿›ç¨‹çŠ¶æ€</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_ZOMBIE<span class="token punctuation">;</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>exit_code <span class="token operator">=</span> code<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥å½“å‰è¿›ç¨‹çš„é€€å‡ºï¼Œæ˜¯å¦ä¼šé€ æˆä»»ä½•è¿›ç¨‹ç»„å˜æˆå­¤å„¿è¿›ç¨‹ç»„</span></span>
<span class="line">    <span class="token comment">// å¦‚æœæœ‰ï¼Œä¸”æœ‰å¤„äºåœæ­¢çŠ¶æ€çš„è¿›ç¨‹ï¼Œåˆ™å‘é€ SIGHUP å’Œ SIGCONT ä¿¡å·</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æƒ…å†µ 1 - çˆ¶è¿›ç¨‹åœ¨å¦ä¸€ä¸ªè¿›ç¨‹ç»„ä¸­ï¼Œæœ¬è¿›ç¨‹æ˜¯è¿›ç¨‹ç»„ä¸å¤–ç•Œå”¯ä¸€çš„è”ç³»</span></span>
<span class="line">    <span class="token comment">// æ‰€ä»¥è¿›ç¨‹ç»„å°†å˜æˆä¸€ä¸ªå­¤å„¿è¿›ç¨‹ç»„</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>p_pptr<span class="token operator">-&gt;</span>pgrp <span class="token operator">!=</span> current<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">        <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>p_pptr<span class="token operator">-&gt;</span>session <span class="token operator">==</span> current<span class="token operator">-&gt;</span>session<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">        <span class="token function">is_orphaned_pgrp</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">        <span class="token function">has_stopped_jobs</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">kill_pg</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">,</span> SIGHUP<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">kill_pg</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">,</span> ISGCONT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é€šçŸ¥çˆ¶è¿›ç¨‹å½“å‰è¿›ç¨‹å°†è¦ç»ˆæ­¢</span></span>
<span class="line">    current<span class="token operator">-&gt;</span>p_pptr<span class="token operator">-&gt;</span>signal <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGCHLD<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¤„ç†å½“å‰è¿›ç¨‹æ‰€æœ‰çš„å­è¿›ç¨‹</span></span>
<span class="line">    <span class="token comment">// è®© init è¿›ç¨‹é›†æˆå½“å‰è¿›ç¨‹çš„æ‰€æœ‰å­è¿›ç¨‹</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> current<span class="token operator">-&gt;</span>p_cptr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>p_pptr <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>state <span class="token operator">==</span> TASK_ZOMBIE<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// å‘ init è¿›ç¨‹å‘é€ SIGCHLD</span></span>
<span class="line">                task<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>signal <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGCHLD<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æƒ…å†µ 2 - å½“å‰è¿›ç¨‹å’Œå­è¿›ç¨‹åœ¨ä¸åŒçš„è¿›ç¨‹ç»„ä¸­</span></span>
<span class="line">            <span class="token comment">// æœ¬è¿›ç¨‹æ˜¯å®ƒä»¬ä¸å¤–ç•Œçš„å”¯ä¸€é“¾æ¥</span></span>
<span class="line">            <span class="token comment">// å­è¿›ç¨‹æ‰€åœ¨çš„è¿›ç¨‹ç»„å°†å˜æˆå­¤å„¿è¿›ç¨‹ç»„</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pgrp <span class="token operator">!=</span> current<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">                <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>session <span class="token operator">==</span> current<span class="token operator">-&gt;</span>session<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">                <span class="token function">is_orphaned_pgrp</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">                <span class="token function">has_stopped_jobs</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">kill_pg</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">,</span> SIGHUP<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">kill_pg</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">,</span> SIGCONT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>p_osptr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>p_osptr<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// å¤„ç†ä¸‹ä¸€ä¸ªå­è¿›ç¨‹</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æœ€è€çš„å­è¿›ç¨‹</span></span>
<span class="line">            p<span class="token operator">-&gt;</span>p_osptr <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>p_cptr<span class="token punctuation">;</span> <span class="token comment">// é“¾æ¥åˆ° task 1 çš„æœ€æ–°å­è¿›ç¨‹</span></span>
<span class="line">            task<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>p_cptr<span class="token operator">-&gt;</span>p_ysptr <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// task 1 çš„åŸæœ€æ–°å­è¿›ç¨‹åé“¾æ¥</span></span>
<span class="line">            task<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span>p_cptr <span class="token operator">=</span> current<span class="token operator">-&gt;</span>p_cptr<span class="token punctuation">;</span> <span class="token comment">// task 1 çš„æœ€æ–°å­è¿›ç¨‹</span></span>
<span class="line">            current<span class="token operator">-&gt;</span>p_cptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// æœ¬è¿›ç¨‹çš„å­è¿›ç¨‹ç½®ç©º</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å½“å‰è¿›ç¨‹æ˜¯ä¼šè¯é¦–é¢†è¿›ç¨‹</span></span>
<span class="line">    <span class="token comment">// å¦‚æœæœ‰æ§åˆ¶ç»ˆç«¯ï¼Œåˆ™åº”å½“å‘ä½¿ç”¨æ§åˆ¶ç»ˆç«¯çš„è¿›ç¨‹ç»„å‘é€æŒ‚æ–­ä¿¡å· SIGHUP å¹¶é‡Šæ”¾ç»ˆç«¯</span></span>
<span class="line">    <span class="token comment">// æ‰«æä»»åŠ¡æ•°ç»„ï¼Œå°†å±äºå½“å‰è¿›ç¨‹ä¼šè¯çš„è¿›ç¨‹ç»ˆç«¯ç½®ç©º</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>leader<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">struct</span> <span class="token class-name">task_sturct</span> <span class="token operator">*</span><span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">struct</span> <span class="token class-name">tty_struct</span> <span class="token operator">*</span>tty<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>tty <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tty <span class="token operator">=</span> <span class="token function">TTY_TABLE</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>tty<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>pgrp <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">kill_pg</span><span class="token punctuation">(</span>tty<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">,</span> SIGHUP<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            tty<span class="token operator">-&gt;</span>pgrp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">            tty<span class="token operator">-&gt;</span>session <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token operator">&amp;</span>LAST_TASK<span class="token punctuation">;</span> p <span class="token operator">&gt;</span> <span class="token operator">&amp;</span>FIRST_TASK<span class="token punctuation">;</span> <span class="token operator">--</span>p<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>session <span class="token operator">==</span> current<span class="token operator">-&gt;</span>session<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>tty <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å½“å‰è¿›ç¨‹ä½¿ç”¨è¿‡åå¤„ç†å™¨</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>last_task_used_math <span class="token operator">==</span> current<span class="token punctuation">)</span></span>
<span class="line">        last_task_used_math <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG_PROC_TREE</span></span></span>
<span class="line">    <span class="token function">audit_ptree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç³»ç»Ÿè°ƒç”¨-exit" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿè°ƒç”¨-exit"><span>ç³»ç»Ÿè°ƒç”¨ exit()</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// ç³»ç»Ÿè°ƒç”¨ exit()</span></span>
<span class="line"><span class="token comment">// error_code æ˜¯ç”¨æˆ·ç¨‹åºæä¾›çš„é€€å‡ºçŠ¶æ€ä¿¡æ¯ï¼Œåªæœ‰ä½å­—èŠ‚æœ‰æ•ˆ</span></span>
<span class="line"><span class="token comment">// è¢«å·¦ç§» 8 ä½ï¼Œä½å­—èŠ‚ä¸­å°†ç”¨æ¥ä¿å­˜ wait() çš„çŠ¶æ€ä¿¡æ¯</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">sys_exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> error_code<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">do_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error_code <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç³»ç»Ÿè°ƒç”¨-waitpid" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿè°ƒç”¨-waitpid"><span>ç³»ç»Ÿè°ƒç”¨ waitpid()</span></a></h4><p>æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ°ä»¥ä¸‹æƒ…å†µå‘ç”Ÿï¼š</p><ul><li>pid æŒ‡å®šçš„å­è¿›ç¨‹é€€å‡º</li><li>æ”¶åˆ°è¦æ±‚ç»ˆæ­¢è¯¥è¿›ç¨‹çš„ä¿¡å·</li><li>éœ€è¦è°ƒç”¨ä¸€ä¸ªä¿¡å·å¥æŸ„</li></ul><p>è‹¥ pid æ‰€æŒ‡è¿›ç¨‹æ—©å·²åƒµæ­»ï¼Œåˆ™æœ¬ç³»ç»Ÿè°ƒç”¨ç«‹åˆ»è¿”å›ï¼Œå¹¶é‡Šæ”¾å­è¿›ç¨‹å ç”¨çš„èµ„æº</p><ul><li>pid &gt; 0ï¼šç­‰å¾…è¿›ç¨‹å·ä¸º pid çš„å­è¿›ç¨‹</li><li>pid = 0ï¼šç­‰å¾…è¿›ç¨‹ç»„å· == å½“å‰è¿›ç¨‹ç»„å·çš„ä»»ä½•å­è¿›ç¨‹</li><li>pid &lt; -1ï¼šç­‰å¾…è¿›ç¨‹ç»„å·ç­‰äº -pid çš„ä»»ä½•å­è¿›ç¨‹</li><li>pid = -1ï¼šç­‰å¾…ä»»ä½•å­è¿›ç¨‹</li></ul><p>é€‰é¡¹ï¼š</p><ul><li>WUNTRACEDï¼šå¦‚æœå­è¿›ç¨‹æ˜¯åœæ­¢çš„ï¼Œä¹Ÿé©¬ä¸Šè¿”å›</li><li>WNOHANGï¼šå¦‚æœæ²¡æœ‰å­è¿›ç¨‹é€€å‡ºæˆ–ç»ˆæ­¢ï¼Œå°±é©¬ä¸Šè¿”å›</li></ul><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">sys_waitpid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span> stat_addr<span class="token punctuation">,</span> <span class="token keyword">int</span> options<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> flag<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> oldblocked<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">verify_area</span><span class="token punctuation">(</span>stat_addr<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// éªŒè¯å­˜æ”¾çŠ¶æ€ä¿¡æ¯çš„å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿ</span></span>
<span class="line">repeat<span class="token operator">:</span></span>
<span class="line">    flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> current<span class="token operator">-&gt;</span>p_cptr<span class="token punctuation">;</span> p<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>p_osptr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pid <span class="token operator">!=</span> pid<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// å½“å‰è¿›ç¨‹çš„å…¶å®ƒå­è¿›ç¨‹ï¼Œè·³è¿‡</span></span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pid<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pgrp <span class="token operator">!=</span> current<span class="token operator">-&gt;</span>pgrp<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// pid == 0</span></span>
<span class="line">                <span class="token comment">// è¯¥è¿›ç¨‹çš„è¿›ç¨‹ç»„å’Œå½“å‰è¿›ç¨‹ç»„ä¸åŒï¼Œè·³è¿‡</span></span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pgrp <span class="token operator">!=</span> <span class="token operator">-</span>pid<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// pid &lt; -1</span></span>
<span class="line">                <span class="token comment">// è¯¥è¿›ç¨‹çš„è¿›ç¨‹ç»„å·ä¸ä¸º -pid</span></span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// pid == -1</span></span>
<span class="line">        <span class="token comment">// pid &gt; 0 &amp;&amp; p-&gt;pid == pid</span></span>
<span class="line">        <span class="token comment">// pid == 0 &amp;&amp; p-&gt;pgrp == current-&gt;pgrp</span></span>
<span class="line">        <span class="token comment">// pid == -1 &amp;&amp; p-&gt;pgrp == -pid</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// æ­¤æ—¶ï¼Œp å·²ç»æŒ‡å‘é€‰æ‹©åˆ°çš„ä¸€ä¸ªè¿›ç¨‹</span></span>
<span class="line">        <span class="token keyword">switch</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> TASK_STOPPED<span class="token operator">:</span></span>
<span class="line">                <span class="token comment">// å­è¿›ç¨‹å·²åœæ­¢</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>options <span class="token operator">&amp;</span> WUNTRACED<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>p<span class="token operator">-&gt;</span>exit_code<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">put_fs_long</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>exit_code <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x7f</span><span class="token punctuation">,</span> stat_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                p<span class="token operator">-&gt;</span>exit_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">return</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">case</span> TASK_ZOMBIE<span class="token operator">:</span></span>
<span class="line">                <span class="token comment">// å­è¿›ç¨‹å·²åƒµæ­»</span></span>
<span class="line">                <span class="token comment">// ç´¯è®¡æ—¶é—´</span></span>
<span class="line">                current<span class="token operator">-&gt;</span>cutime <span class="token operator">+=</span> p<span class="token operator">-&gt;</span>utime<span class="token punctuation">;</span></span>
<span class="line">                current<span class="token operator">-&gt;</span>cstime <span class="token operator">+=</span> p<span class="token operator">-&gt;</span>stime<span class="token punctuation">;</span></span>
<span class="line">                flag <span class="token operator">=</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// æ”¾ç½®é€€å‡ºç </span></span>
<span class="line">                <span class="token function">put_fs_long</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>exit_code<span class="token punctuation">,</span> stat_addr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// é‡Šæ”¾å­è¿›ç¨‹</span></span>
<span class="line">                <span class="token function">release</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">return</span> flag<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                <span class="token comment">// æ—¢ä¸åœæ­¢ï¼Œä¹Ÿä¸åƒµæ­»</span></span>
<span class="line">                <span class="token comment">// æ‰¾åˆ°è¿‡ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„å­è¿›ç¨‹ï¼Œä½†å…¶å¤„äºè¿è¡Œæ€æˆ–ç¡çœ æ€</span></span>
<span class="line">                flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å­˜åœ¨ç¬¦åˆç­‰å¾…è¦æ±‚çš„å­è¿›ç¨‹ï¼Œä½†æ²¡æœ‰å¤„äºé€€å‡ºæˆ–åƒµæ­»çŠ¶æ€</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;</span> WNOHANG<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// é€‰é¡¹ - å¦‚æœæ²¡æœ‰å­è¿›ç¨‹å¤„äºé€€å‡ºæˆ–ç»ˆæ­¢çŠ¶æ€ï¼Œå°±ç«‹åˆ»è¿”å›</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æŠŠå½“å‰è¿›ç¨‹ç½®ä¸ºå¯ä¸­æ–­ç­‰å¾…çŠ¶æ€</span></span>
<span class="line">        <span class="token comment">// ä¿ç•™å¹¶ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ä¿¡å·å±è”½ bitmapï¼Œå…è®¸æ¥æ”¶ SIGCHLD</span></span>
<span class="line">        <span class="token comment">// è°ƒåº¦</span></span>
<span class="line">        current<span class="token operator">-&gt;</span>state <span class="token operator">=</span> TASK_INTERRUPTIBLE<span class="token punctuation">;</span></span>
<span class="line">        oldblocked <span class="token operator">=</span> current<span class="token operator">-&gt;</span>blocked<span class="token punctuation">;</span></span>
<span class="line">        current<span class="token operator">-&gt;</span>blocked <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGCHLD<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        current<span class="token operator">-&gt;</span>blocked <span class="token operator">=</span> oldblocked<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currrent<span class="token operator">-&gt;</span>signal <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>blokced <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SIGCHLD<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// æ¥æ”¶åˆ°å…¶å®ƒæœªå±è”½ä¿¡å·ï¼Œè¿”å› - é‡æ–°å¯åŠ¨ç³»ç»Ÿè°ƒç”¨</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">else</span></span>
<span class="line">            <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// flag == 0ï¼Œæ²¡æœ‰æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„å­è¿›ç¨‹</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">-</span>ECHILD<span class="token punctuation">;</span> <span class="token comment">// å­è¿›ç¨‹ä¸å­˜åœ¨</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,56)]))}const r=a(o,[["render",l],["__file","Chapter 8.8 - exit.c ç¨‹åº.html.vue"]]),k=JSON.parse('{"path":"/linux-kernel-comments-notes/Chapter%208%20-%20%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81/Chapter%208.8%20-%20exit.c%20%E7%A8%8B%E5%BA%8F.html","title":"Chapter 8.8 - exit.c ç¨‹åº","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"8.8 exit.c ç¨‹åº","slug":"_8-8-exit-c-ç¨‹åº","link":"#_8-8-exit-c-ç¨‹åº","children":[{"level":3,"title":"8.8.1 åŠŸèƒ½æè¿°","slug":"_8-8-1-åŠŸèƒ½æè¿°","link":"#_8-8-1-åŠŸèƒ½æè¿°","children":[]},{"level":3,"title":"8.8.2 ä»£ç æ³¨é‡Š","slug":"_8-8-2-ä»£ç æ³¨é‡Š","link":"#_8-8-2-ä»£ç æ³¨é‡Š","children":[]}]}],"git":{},"filePathRelative":"linux-kernel-comments-notes/Chapter 8 - å†…æ ¸ä»£ç /Chapter 8.8 - exit.c ç¨‹åº.md"}');export{r as comp,k as data};
