import{_ as s,c as a,a as p,o as e}from"./app-BeHGwf2X.js";const t="/blog/assets/12-16-k9qbSBBf.png",c="/blog/assets/12-17-T_7Oq3Kc.png",l="/blog/assets/12-19-BLKjD1G4.png",o={};function i(u,n){return e(),a("div",null,n[0]||(n[0]=[p('<h1 id="chapter-12-2-buffer-c-ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#chapter-12-2-buffer-c-ç¨‹åº"><span>Chapter 12.2 - buffer.c ç¨‹åº</span></a></h1><p>Created by : Mr Dk.</p><p>2019 / 09 / 02 0:46</p><p>Ningbo, Zhejiang, China</p><hr><h2 id="_12-2-buffer-c-ç¨‹åº" tabindex="-1"><a class="header-anchor" href="#_12-2-buffer-c-ç¨‹åº"><span>12.2 buffer.c ç¨‹åº</span></a></h2><p>é«˜é€Ÿç¼“å†²ç®¡ç†ç¨‹åºã€‚</p><h3 id="_12-2-1-åŠŸèƒ½æè¿°" tabindex="-1"><a class="header-anchor" href="#_12-2-1-åŠŸèƒ½æè¿°"><span>12.2.1 åŠŸèƒ½æè¿°</span></a></h3><h4 id="_1-é«˜é€Ÿç¼“å†²åŒºçš„ç‰©ç†ä½ç½®" tabindex="-1"><a class="header-anchor" href="#_1-é«˜é€Ÿç¼“å†²åŒºçš„ç‰©ç†ä½ç½®"><span>1. é«˜é€Ÿç¼“å†²åŒºçš„ç‰©ç†ä½ç½®</span></a></h4><p>é«˜é€Ÿç¼“å†²åŒºä½äº <strong>å†…æ ¸ä»£ç </strong> å’Œ <strong>ä¸»å†…å­˜åŒº</strong> ä¹‹é—´ï¼Œé™¤äº† <strong>å—è®¾å¤‡é©±åŠ¨ç¨‹åº</strong>ï¼Œå†…æ ¸ç¨‹åºå¦‚æœéœ€è¦è®¿é—®å—è®¾å¤‡ä¸­çš„æ•°æ®ï¼Œéƒ½éœ€è¦ç»è¿‡é«˜é€Ÿç¼“å†²åŒºæ¥é—´æ¥åœ°è¿›è¡Œæ“ä½œã€‚</p><h4 id="_2-é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–"><span>2. é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–</span></a></h4><p>åœ¨åˆå§‹åŒ–æ—¶ï¼Œé«˜é€Ÿç¼“å†²åŒºè¢«åˆ’åˆ†ä¸º 1024B å¤§å°çš„ç¼“å†²å—ï¼Œä»æ•´ä¸ªç¼“å†²åŒºä¸¤ç«¯å¼€å§‹ï¼Œåˆ†åˆ«åŒæ—¶è®¾ç½® <strong>ç¼“å†²å—å¤´ç»“æ„</strong> å’Œ <strong>ç¼“å†²å—</strong>ï¼š</p><ul><li>åœ°å€é«˜ç«¯è¢«åˆ’åˆ†ä¸º 1024B çš„ç¼“å†²å—</li><li>åœ°å€ä½ç«¯åˆ†åˆ«å»ºç«‹èµ·å¯¹åº”å„å¤´ç»“æ„çš„ <code>buffer_head</code></li></ul><p>æŒç»­åˆ°ç¼“å†²åŒºæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å†åˆ’åˆ†å‡ºç¼“å†²å—ä¸ºæ­¢ã€‚</p><p><img src="'+t+`" alt="12-16"></p><h4 id="_3-é«˜é€Ÿç¼“å†²åŒºç»“æ„å’Œé“¾è¡¨" tabindex="-1"><a class="header-anchor" href="#_3-é«˜é€Ÿç¼“å†²åŒºç»“æ„å’Œé“¾è¡¨"><span>3. é«˜é€Ÿç¼“å†²åŒºç»“æ„å’Œé“¾è¡¨</span></a></h4><p>buffer_head çš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">char</span> <span class="token operator">*</span> b_data<span class="token punctuation">;</span> <span class="token comment">// æŒ‡å‘å¯¹åº”ç¼“å†²å—</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> b_blocknr<span class="token punctuation">;</span> <span class="token comment">// å—å·</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> b_dev<span class="token punctuation">;</span> <span class="token comment">// è®¾å¤‡å· (0 ä»£è¡¨ç©ºé—²)</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_uptodate<span class="token punctuation">;</span> <span class="token comment">// æ•°æ®æ˜¯å¦å·²æ›´æ–°</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_dirt<span class="token punctuation">;</span> <span class="token comment">// æ•°æ®æ˜¯å¦å·²ä¿®æ”¹</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_count<span class="token punctuation">;</span> <span class="token comment">// ä½¿ç”¨è¯¥å—çš„å¼•ç”¨æ•°</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b_lock<span class="token punctuation">;</span> <span class="token comment">// ç¼“å†²åŒºæ˜¯å¦è¢«é”å®š</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span> b_wait<span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…è¯¥ç¼“å†²åŒºè§£é”çš„ä»»åŠ¡</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> b_prev<span class="token punctuation">;</span> <span class="token comment">// hash é˜Ÿåˆ—æ­£å‘æŒ‡é’ˆ</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> b_next<span class="token punctuation">;</span> <span class="token comment">// hash é˜Ÿåˆ—åå‘æŒ‡é’ˆ</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> b_prev_free<span class="token punctuation">;</span> <span class="token comment">// ç©ºé—²é“¾è¡¨æ­£å‘æŒ‡é’ˆ</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> b_next_free<span class="token punctuation">;</span> <span class="token comment">// ç©ºé—²é“¾è¡¨åå‘æŒ‡é’ˆ</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»å¦‚å›¾ï¼š</p><p><img src="`+c+'" alt="12-17"></p><p>æ‰€æœ‰ç¼“å†²å—çš„ buffer_head è¢«é“¾æ¥æˆä¸€ä¸ª <strong>åŒå‘é“¾è¡¨</strong> ç»“æ„ - ç§°ä¸º <strong>ç©ºé—²é“¾è¡¨</strong>ã€‚</p><ul><li>ç”± <code>b_prev_free</code> å’Œ <code>b_next_free</code> é“¾æ¥</li><li>å®é™…ä¸Šæ˜¯ä¸€ä¸ª LRU (Least Recently Used) é“¾è¡¨</li></ul><blockquote><p>ä½†æ˜¯ç©ºé—²é“¾è¡¨ä¸­çš„é¡¹å¹¶ä¸éƒ½æ˜¯ç©ºé—²çš„... ğŸ¤¨</p></blockquote><p><code>free_list</code> æŒ‡é’ˆæ˜¯é“¾è¡¨çš„å¤´æŒ‡é’ˆï¼ŒæŒ‡å‘è¿‘æœŸæœ€å°‘ä½¿ç”¨çš„ç¼“å†²å—ã€‚è¯¥ç¼“å†²å—çš„åå‘æŒ‡é’ˆæŒ‡å‘é“¾è¡¨çš„æœ€åä¸€ä¸ªç¼“å†²å—ï¼Œå³æœ€è¿‘åˆšä½¿ç”¨çš„ç¼“å†²å—ã€‚</p><p><code>b_lock</code> æ˜¯é”å®šæ ‡å¿— - è¡¨ç¤º <strong>é©±åŠ¨ç¨‹åº</strong> æ­£åœ¨å¯¹è¯¥ç¼“å†²å—çš„å†…å®¹è¿›è¡Œä¿®æ”¹ï¼š</p><ul><li>æ›´æ–°æ•°æ®å—ä¿¡æ¯æ—¶ï¼Œå½“å‰è¿›ç¨‹ä¼šè‡ªæ„¿ç¡çœ ç­‰å¾…ï¼Œåˆ«çš„è¿›ç¨‹æœ‰æœºä¼šè®¿é—®è¯¥ç¼“å†²å—</li><li>åº”å½“åœ¨ç¡çœ ä¹‹å‰é”å®šè¯¥ç¼“å†²å—</li></ul><p><code>b_count</code> è¡¨ç¤ºç›¸åº”ç¼“å†²å—è¢«å„ä¸ªè¿›ç¨‹å¼•ç”¨çš„æ¬¡æ•°ï¼š</p><ul><li>è®¡æ•°ä¸ä¸º 0 æ—¶ï¼Œå°±ä¸èƒ½é‡Šæ”¾ç›¸åº”ç¼“å†²å—</li><li>è®¡æ•°ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºè¯¥ç¼“å†²å—ç©ºé—²</li><li>å¯¹äºç¨‹åºç”³è¯·çš„ç¼“å†²å—ï¼Œå¦‚æœåœ¨ hash è¡¨ä¸­å·²ç»å­˜åœ¨è¯¥å—ï¼Œåˆ™ç›´æ¥å°† b_count åŠ  1</li><li>å¦åˆ™é‡æ–°ç”³è¯·ä¸€å—ç©ºé—²ç¼“å†²å—ï¼Œå¹¶å°† b_count è®¾å¤‡ä¸º 1</li><li>ç¨‹åºé‡Šæ”¾å¯¹ç¼“å†²å—çš„å¼•ç”¨æ—¶ï¼Œb_count å‡ 1</li></ul><p><code>b_dirt</code> æ˜¯ <strong>è„</strong> æ ‡å¿— - è¯´æ˜ç¼“å†²å—ä¸­çš„å†…å®¹å·²è¢«ä¿®æ”¹ï¼Œä¸å—è®¾å¤‡ä¸Šå¯¹åº”å†…å®¹ä¸åŒ</p><p><code>b_uptodate</code> æ˜¯æ•°æ®æœ‰æ•ˆæ ‡å¿— - è¯´æ˜ç¼“å†²å—ä¸­çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ</p><ul><li>åˆå§‹åŒ–æˆ–é‡Šæ”¾å—æ—¶ï¼Œ<code>b_dirt</code> å’Œ <code>b_uptodate</code> éƒ½åº”è®¾ç½®ä¸º 0</li></ul><h4 id="_4-é«˜é€Ÿç¼“å†²åŒºçš„-hash-è¡¨" tabindex="-1"><a class="header-anchor" href="#_4-é«˜é€Ÿç¼“å†²åŒºçš„-hash-è¡¨"><span>4. é«˜é€Ÿç¼“å†²åŒºçš„ hash è¡¨</span></a></h4><p>ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿæœ‰æ•ˆåœ°åœ¨ç¼“å†²åŒºä¸­åˆ¤æ–­ <strong>è¯·æ±‚çš„æ•°æ®å—æ˜¯å¦åœ¨ç¼“å†²åŒºä¸­</strong>ï¼Œä½¿ç”¨äº†å…·æœ‰ 307 ä¸ª buffer_header æŒ‡é’ˆé¡¹çš„ hash è¡¨ï¼Œç”± <code>b_prev</code> å’Œ <code>b_next</code> é“¾æ¥ã€‚</p><p>Hash å‡½æ•°ï¼š<code>(è®¾å¤‡å· ^ é€»è¾‘å—å·) mod 307</code>ã€‚å°†å…·æœ‰ç›¸åŒ hash çš„ç¼“å†²å—é“¾æ¥åœ¨ hash è¡¨çš„åŒä¸€é¡¹ä¸Šã€‚æ•°æ®ç»“æ„å…³ç³»çš„ç¤ºæ„ï¼š</p><p><img src="'+l+`" alt="12-19"></p><p>å®çº¿ä¸º hash è¡¨æŒ‡é’ˆï¼Œè™šçº¿ä¸ºä¹‹å‰æ‰€è°“çš„ç©ºé—²é“¾è¡¨æŒ‡é’ˆã€‚</p><h4 id="_5-ç¼“å†²å—æœç´¢å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_5-ç¼“å†²å—æœç´¢å‡½æ•°"><span>5. ç¼“å†²å—æœç´¢å‡½æ•°</span></a></h4><p>é¦–å…ˆåœ¨ hash è¡¨æŸé¡¹çš„é˜Ÿåˆ—ä¸­æœç´¢æŒ‡å®š <strong>è®¾å¤‡å·</strong> å’Œ <strong>é€»è¾‘å—å·</strong> çš„ç¼“å†²å—æ˜¯å¦å·²å­˜åœ¨</p><ul><li>è‹¥å­˜åœ¨ï¼Œåˆ™ä¹‹é—´è¿”å› buffer_head æŒ‡é’ˆ</li><li>è‹¥ä¸åœ¨ï¼Œåˆ™éœ€è¦ä»ç©ºé—²é“¾è¡¨çš„å¤´éƒ¨å¼€å§‹ï¼Œå¯»æ‰¾ä¸€ä¸ªç©ºé—²çš„ç¼“å†²å—</li></ul><p>å…¶ä¸­è¿˜éœ€è¦å¯¹æ‰¾åˆ°çš„ç©ºé—²ç¼“å†²å—ä½œæ¯”è¾ƒ - å“ªä¸ªæ¯”è¾ƒé€‚åˆï¼Ÿ</p><ul><li>æƒå€¼ - ç”± <strong>é”å®šæ ‡å¿—</strong> å’Œ <strong>ä¿®æ”¹æ ‡å¿—</strong> è®¡ç®—</li></ul><p>è‹¥æ²¡æœ‰æ‰¾åˆ°ç©ºé—²å—ï¼Œåˆ™è¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œé†’æ¥äº†å†æ¥ç€æ‰¾ï¼›è‹¥ç©ºé—²å—è¢«é”å®šï¼Œåˆ™è¿›ç¨‹ä¹Ÿè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…é©±åŠ¨ç¨‹åºå¯¹å…¶è§£é”ã€‚è‹¥ä»ç¡çœ åˆ°é†’æ¥ç»§ç»­æ‰§è¡Œä¹‹é—´çš„æ—¶é—´é‡Œï¼Œè¯¥å—è¢«å…¶å®ƒè¿›ç¨‹å ç”¨ï¼Œåˆ™éœ€è¦é‡æ–°å¼€å§‹æœç´¢ã€‚å¦‚æœè¯¥ç¼“å†²å—å·²è¢«ä¿®æ”¹è¿‡ï¼Œåˆ™éœ€è¦å°†ç¼“å†²å—ä¸ç¡¬ç›˜åŒæ­¥ - å†™ç›˜ã€‚</p><ul><li>å†æ¬¡ç­‰å¾…è¯¥å—è§£é”</li><li>å¦‚æœè¯¥å—åˆè¢«å…¶å®ƒè¿›ç¨‹å ç”¨ï¼Œåˆ™åˆå‰åŠŸå°½å¼ƒï¼Œéœ€è¦é‡æ–°å¼€å§‹æœç´¢</li></ul><p>å¦‚æœåœ¨å½“å‰è¿›ç¨‹ç¡çœ æ—¶ï¼Œå…¶å®ƒè¿›ç¨‹å·²ç»å°†æˆ‘ä»¬éœ€è¦çš„ç¼“å†²å—åŠ å…¥äº† hash é˜Ÿåˆ—ä¸­ã€‚å› æ­¤è¿˜éœ€è¦æœç´¢ä¸€ä¸‹ hash é˜Ÿåˆ—ï¼Œåˆéœ€è¦é‡æ–°æ‰§è¡Œã€‚æœ€ç»ˆï¼Œæ‰¾åˆ°äº†ä¸€å— <strong>æœªè¢«è¿›ç¨‹ä½¿ç”¨ã€æ²¡ä¸Šé”ã€æ²¡è¢«ä¿®æ”¹</strong> çš„ç©ºé—²å—ï¼š</p><ul><li>å°†è¯¥å—çš„å¼•ç”¨æ¬¡æ•°ç½® 1</li><li>å¤ä½å…¶å®ƒå‡ ä¸ªæ ‡å¿—</li><li>ä»ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤è¯¥å—ï¼Œè®¾ç½® <strong>è®¾å¤‡å·</strong> å’Œ <strong>é€»è¾‘å—å·</strong> å</li><li>æ’å…¥ hash è¡¨å¯¹åº”é¡¹çš„å¤´éƒ¨</li><li>é“¾æ¥åˆ°ç©ºé—²é“¾è¡¨çš„æœ«å°¾å¤„</li></ul><p>ç”±äºæ“ä½œæ˜¯ä»ç©ºé—²é“¾è¡¨çš„å¤´éƒ¨å¼€å§‹æœç´¢ï¼Œç§»é™¤æœ€è¿‘æœ€ä¸å¸¸ç”¨çš„å—åï¼Œæ’å…¥å°¾éƒ¨ï¼Œå› æ­¤å®ç°äº† LRU ç®—æ³•ã€‚ç®—æ³•ç­–ç•¥ï¼š</p><ul><li>ç¼“å†²å—å·²åœ¨ hash è¡¨ä¸­ï¼Œåˆ™ç›´æ¥ä½¿ç”¨</li><li>ä»ç©ºé—²é“¾è¡¨å¤´éƒ¨å¼€å§‹æœç´¢æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å†²å—å¹¶ä½¿ç”¨</li><li>ä¼˜å…ˆçº§ <ul><li>æ ¹æ® <code>b_dirt</code> å’Œ <code>b_lock</code> è®¡ç®—æƒé‡</li><li>ç”±äºå†™å…¥æ“ä½œè¾ƒä¸ºè€—æ—¶ï¼Œéœ€è¦åŠ åˆ° <code>b_dirt</code> çš„æƒé‡</li><li>åœ¨æƒé‡æœ€å°çš„ç¼“å†²å—ä¸Šç­‰å¾…</li></ul></li></ul><h4 id="_6-ç¼“å†²å—è¯»å–å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_6-ç¼“å†²å—è¯»å–å‡½æ•°"><span>6. ç¼“å†²å—è¯»å–å‡½æ•°</span></a></h4><p>å–å¾—çš„ç¼“å†²å—å¯èƒ½æ˜¯ä¸€ä¸ªæ–°çš„ç©ºé—²å—ï¼Œä¹Ÿå¯èƒ½æ˜¯æ­£å¥½å«æœ‰éœ€è¦çš„æ•°æ®çš„ç¼“å†²å—ã€‚å› æ­¤è¦åˆ¤æ–­ç¼“å†²å—çš„ <code>b_uptodate</code> æŸ¥çœ‹ç¼“å†²å—æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼š</p><ul><li><p>å¦‚æœæœ‰æ•ˆï¼Œåˆ™æ•°æ®å—å¯ä»¥ç›´æ¥è¢«è¿”å›ç»™ç”³è¯·ç¨‹åº</p></li><li><p>å¦åˆ™å°±è°ƒç”¨ <strong>ä½å±‚å—è®¾å¤‡è¯»å†™å‡½æ•° ll_rw_block()</strong> ï¼Œå¹¶è®©è‡ªèº«è¿›å…¥ç¡çœ ï¼Œç­‰å¾…æ•°æ®è¢«è¯»å…¥ç¼“å†²å—ï¼Œé†’æ¥åå†åˆ¤æ–­æ•°æ®æ˜¯å¦å·²ç»æœ‰æ•ˆï¼š</p></li><li><p>å¦‚æœæœ‰æ•ˆï¼Œåˆ™å¯ä»¥è¿”å›ç»™ç”³è¯·çš„ç¨‹åº</p></li><li><p>å¦åˆ™è¯»æ“ä½œå¤±è´¥ï¼Œäºæ˜¯é‡Šæ”¾ç¼“å†²å—ï¼Œå¹¶è¿”å› NULL</p></li></ul><p>å½“ç¨‹åºä¸å†éœ€è¦ä½¿ç”¨ç¼“å†²å—ä¸­çš„æ•°æ®æ—¶ï¼Œå°±é‡Šæ”¾ç¼“å†²å—ï¼Œå¹¶å”¤é†’å› ç­‰å¾…ç¼“å†²å—è€Œç¡çœ çš„è¿›ç¨‹ã€‚ç©ºé—²é“¾è¡¨ä¸­çš„ç¼“å†²å—ï¼Œåªæœ‰å½“ï¼š</p><ul><li>è¢«å†™ç›˜åˆ·æ–°</li><li>è§£é”</li><li>å¼•ç”¨è®¡æ•°ä¸º 0</li></ul><p>æ‰èƒ½æŒªä½œä»–ç”¨ã€‚</p><h4 id="_7-é«˜é€Ÿç¼“å†²åŒºè®¿é—®è¿‡ç¨‹å’ŒåŒæ­¥æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#_7-é«˜é€Ÿç¼“å†²åŒºè®¿é—®è¿‡ç¨‹å’ŒåŒæ­¥æ“ä½œ"><span>7. é«˜é€Ÿç¼“å†²åŒºè®¿é—®è¿‡ç¨‹å’ŒåŒæ­¥æ“ä½œ</span></a></h4><p>è®©å†…å­˜ä¸­çš„ä¸€äº›ç¼“å†²å—å†…å®¹ä¸ç£ç›˜å—è®¾å¤‡ä¸Šçš„ä¿¡æ¯ä¸€è‡´ã€‚æ¯”å¦‚ <code>sync_inodes()</code> æ˜¯ä¸ºäº†æŠŠ inode_table ä¸­çš„ inode ä¿¡æ¯ä¸ç£ç›˜ä¸€è‡´èµ·æ¥ã€‚åŒæ­¥æ“ä½œé€šå¸¸è¢«åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ol><li>æ•°æ®ç»“æ„ä¿¡æ¯ä¸é«˜é€Ÿç¼“å†²åŒºä¸­ç¼“å†²å—çš„åŒæ­¥</li><li>é«˜é€Ÿç¼“å†²åŒºä¸­æ•°æ®å—ä¸ç£ç›˜å¯¹åº”å—çš„åŒæ­¥</li></ol><h3 id="_12-2-2-ä»£ç æ³¨é‡Š" tabindex="-1"><a class="header-anchor" href="#_12-2-2-ä»£ç æ³¨é‡Š"><span>12.2.2 ä»£ç æ³¨é‡Š</span></a></h3><h4 id="æŒ‡é’ˆå®šä¹‰" tabindex="-1"><a class="header-anchor" href="#æŒ‡é’ˆå®šä¹‰"><span>æŒ‡é’ˆå®šä¹‰</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">extern</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span> <span class="token comment">// å†…æ ¸ä»£ç æœ«ç«¯</span></span>
<span class="line"><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> start_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>end<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> hash_table<span class="token punctuation">[</span>NR_HASH<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// NR_HASH = 307</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> free_list<span class="token punctuation">;</span> <span class="token comment">// ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆ</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span> buffer_wait <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// ç©ºé—²ç¼“å†²å—ç­‰å¾…é˜Ÿåˆ—</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> NR_BUFFERS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ç³»ç»Ÿä¸­å«æœ‰çš„ç¼“å†²åŒºä¸ªæ•°</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="wait-on-buffer-ç­‰å¾…æŒ‡å®šç¼“å†²åŒºè§£é”" tabindex="-1"><a class="header-anchor" href="#wait-on-buffer-ç­‰å¾…æŒ‡å®šç¼“å†²åŒºè§£é”"><span>wait_on_buffer() - ç­‰å¾…æŒ‡å®šç¼“å†²åŒºè§£é”</span></a></h4><p>å¦‚æœæŒ‡å®šçš„ç¼“å†²å—å·²ç»ä¸Šé”ï¼Œåˆ™è®©è¿›ç¨‹ä¸å¯ä¸­æ–­åœ°ç­‰å¾…åœ¨ç¼“å†²å—çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ç¼“å†²å—è§£é”æ—¶ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹å°†è¢«å”¤é†’ã€‚å…¶ä¸­æ¶‰åŠåˆ°äº†å¼€ / å…³ä¸­æ–­ï¼š</p><ul><li>è™½ç„¶è¿›ç¨‹æ˜¯åœ¨å…³ä¸­æ–­ä¹‹åè¿›å…¥ä¼‘çœ çš„</li><li>ä½†ç”±äºæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ EFLAGSï¼Œä¿å­˜åœ¨ TSS æ®µä¸­</li><li>å› æ­¤è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œå½“å‰ EFLAGS ä¹Ÿéšä¹‹æ”¹å˜</li></ul><p>å³ï¼šæ¯ä¸ªè¿›ç¨‹ä¸­æ–­çš„å¼€ / å…³çŠ¶æ€æ˜¯ç‹¬ç«‹çš„ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">cli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_lock<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bh<span class="token operator">-&gt;</span>b_wait<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">sti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="sys-sync-åŒæ­¥è®¾å¤‡å’Œé«˜é€Ÿç¼“å†²ä¸­çš„æ•°æ®" tabindex="-1"><a class="header-anchor" href="#sys-sync-åŒæ­¥è®¾å¤‡å’Œé«˜é€Ÿç¼“å†²ä¸­çš„æ•°æ®"><span>sys_sync() - åŒæ­¥è®¾å¤‡å’Œé«˜é€Ÿç¼“å†²ä¸­çš„æ•°æ®</span></a></h4><p>é¦–å…ˆè°ƒç”¨ inode åŒæ­¥å‡½æ•°ï¼Œå°†å†…å­˜ä¸­æ‰€æœ‰ä¿®æ”¹è¿‡çš„ inode å†™å…¥é«˜é€Ÿç¼“å†²ã€‚ç„¶åæ‰«ææ•´ä¸ªé«˜é€Ÿç¼“å†²åŒºï¼Œå¯¹å·²ç»è¢«ä¿®æ”¹çš„ç¼“å†²å—ç”Ÿæˆå†™ç›˜è¯·æ±‚ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">sys_sync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">sync_inodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    bh <span class="token operator">=</span> start_buffer<span class="token punctuation">;</span> <span class="token comment">// ç¼“å†²åŒºå¼€å§‹å¤„</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_BUFFERS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>d_dirt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// ç¼“å†²å—å·²è¢«ä¿®æ”¹</span></span>
<span class="line">            <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>WRITE<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨å—è®¾å¤‡é©±åŠ¨ç¨‹åº</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="sync-dev-å¯¹æŒ‡å®šè®¾å¤‡æ‰§è¡Œé«˜é€Ÿç¼“å†²æ•°æ®ä¸è®¾å¤‡ä¸Šæ•°æ®çš„åŒæ­¥æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#sync-dev-å¯¹æŒ‡å®šè®¾å¤‡æ‰§è¡Œé«˜é€Ÿç¼“å†²æ•°æ®ä¸è®¾å¤‡ä¸Šæ•°æ®çš„åŒæ­¥æ“ä½œ"><span>sync_dev() - å¯¹æŒ‡å®šè®¾å¤‡æ‰§è¡Œé«˜é€Ÿç¼“å†²æ•°æ®ä¸è®¾å¤‡ä¸Šæ•°æ®çš„åŒæ­¥æ“ä½œ</span></a></h4><p>å…ˆæœç´¢æ‰€æœ‰çš„é«˜é€Ÿç¼“å†²å—ï¼Œå¯¹æŒ‡å®šè®¾å¤‡ dev çš„ç¼“å†²å—ï¼Œè‹¥å…¶æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œåˆ™è¿›è¡ŒåŒæ­¥æ“ä½œã€‚ç„¶åå°†å†…å­˜ inode çš„æ•°æ®å†™å…¥é«˜é€Ÿç¼“å†²ä¸­ï¼Œå†å¯¹æŒ‡å®šè®¾å¤‡æ‰§è¡Œä¸€æ¬¡ç›¸åŒçš„åŒæ­¥æ“ä½œã€‚é‡‡ç”¨ä¸¤è¾¹åŒæ­¥æ“ä½œæ˜¯ä¸ºäº†æé«˜å†…æ ¸æ‰§è¡Œæ•ˆç‡ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">sync_dev</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åŒæ­¥æŒ‡å®šè®¾å¤‡æ‰€æœ‰å·²ä¿®æ”¹ç¼“å†²å—</span></span>
<span class="line">    bh <span class="token operator">=</span> start_buffer<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_BUFFERS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> bh<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">!=</span> dev<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…ç¼“å†²åŒºè§£é”</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> bh<span class="token operator">-&gt;</span>b_dirt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>WRITE<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">sync_inodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°† inode å†™å…¥é«˜é€Ÿç¼“å†²</span></span>
<span class="line">    </span>
<span class="line">    bh <span class="token operator">=</span> start_buffer<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_BUFFERS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> bh<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">!=</span> dev<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> bh<span class="token operator">-&gt;</span>b_dirt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>WRITE<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="invalidate-buffers-ä½¿æŒ‡å®šè®¾å¤‡åœ¨é«˜é€Ÿç¼“å†²åŒºä¸­çš„æ•°æ®æ— æ•ˆ" tabindex="-1"><a class="header-anchor" href="#invalidate-buffers-ä½¿æŒ‡å®šè®¾å¤‡åœ¨é«˜é€Ÿç¼“å†²åŒºä¸­çš„æ•°æ®æ— æ•ˆ"><span>invalidate_buffers() - ä½¿æŒ‡å®šè®¾å¤‡åœ¨é«˜é€Ÿç¼“å†²åŒºä¸­çš„æ•°æ®æ— æ•ˆ</span></a></h4><p>å¯¹æŒ‡å®šè®¾å¤‡çš„ç¼“å†²å—å¤ä½ <code>b_uptodate</code> å’Œ <code>b_dirt</code> æ ‡å¿—ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token keyword">inline</span> <span class="token function">invalidate_buffers</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    bh <span class="token operator">=</span> start_buffer<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_BUFFERS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> bh<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">!=</span> dev<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">==</span> dev<span class="token punctuation">)</span></span>
<span class="line">            bh<span class="token operator">-&gt;</span>b_uptodate <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_dirt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="hash-è®¡ç®—ã€æŸ¥æ‰¾å®" tabindex="-1"><a class="header-anchor" href="#hash-è®¡ç®—ã€æŸ¥æ‰¾å®"><span>Hash è®¡ç®—ã€æŸ¥æ‰¾å®</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">_hashfn</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dev<span class="token operator">^</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> NR_HASH<span class="token punctuation">)</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">hash</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span> hash_table<span class="token punctuation">[</span><span class="token function">_hashfn</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">]</span></span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="remove-from-queues-ä»-hash-é˜Ÿåˆ—å’Œç©ºé—²é“¾è¡¨ä¸­ç§»èµ°ç¼“å†²å—" tabindex="-1"><a class="header-anchor" href="#remove-from-queues-ä»-hash-é˜Ÿåˆ—å’Œç©ºé—²é“¾è¡¨ä¸­ç§»èµ°ç¼“å†²å—"><span>remove_from_queues() - ä» hash é˜Ÿåˆ—å’Œç©ºé—²é“¾è¡¨ä¸­ç§»èµ°ç¼“å†²å—</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">remove_from_queues</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä» hash é˜Ÿåˆ—ä¸­ç§»é™¤ç¼“å†²å—</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">)</span></span>
<span class="line">        bh<span class="token operator">-&gt;</span>b_next<span class="token operator">-&gt;</span>b_prev <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_prev<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_prev<span class="token punctuation">)</span></span>
<span class="line">        bh<span class="token operator">-&gt;</span>b_prev<span class="token operator">-&gt;</span>b_next <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// è¯¥ç¼“å†²å—æ˜¯ hash é˜Ÿåˆ—çš„ç¬¬ä¸€å—</span></span>
<span class="line">    <span class="token comment">// éœ€è¦è®© hash è¡¨ä¸­çš„é¡¹æŒ‡å‘è¯¥é¡¹</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span> <span class="token operator">==</span> bh<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span> <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤ç¼“å†²å—</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_prev_free<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Free block list corrupted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_prev_free<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_next_free<span class="token operator">-&gt;</span>b_prev_free <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_prev_free<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// å¦‚æœç©ºé—²é“¾è¡¨å¤´æŒ‡å‘æœ¬ç¼“å†²å—</span></span>
<span class="line">    <span class="token comment">// åˆ™æŒ‡å‘ä¸‹ä¸€ç¼“å†²å—</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>free_list <span class="token operator">==</span> bh<span class="token punctuation">)</span></span>
<span class="line">        free_list <span class="token operator">=</span> bh<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="insert-into-queues-å°†ç¼“å†²å—æ’å…¥ç©ºé—²é“¾è¡¨å°¾éƒ¨-åŒæ—¶æ”¾å…¥-hash-é˜Ÿåˆ—ä¸­" tabindex="-1"><a class="header-anchor" href="#insert-into-queues-å°†ç¼“å†²å—æ’å…¥ç©ºé—²é“¾è¡¨å°¾éƒ¨-åŒæ—¶æ”¾å…¥-hash-é˜Ÿåˆ—ä¸­"><span>insert_into_queues() - å°†ç¼“å†²å—æ’å…¥ç©ºé—²é“¾è¡¨å°¾éƒ¨ï¼ŒåŒæ—¶æ”¾å…¥ hash é˜Ÿåˆ—ä¸­</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">insert_into_queues</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ’å…¥ç©ºé—²é“¾è¡¨å°¾éƒ¨</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> free_list<span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_prev_free <span class="token operator">=</span> free_list<span class="token operator">-&gt;</span>b_prev_free<span class="token punctuation">;</span></span>
<span class="line">    free_list<span class="token operator">-&gt;</span>b_prev_free<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> bh<span class="token punctuation">;</span></span>
<span class="line">    free_list<span class="token operator">-&gt;</span>b_prev_free <span class="token operator">=</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ”¾å…¥ hash é˜Ÿåˆ—</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_next <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">hash</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">,</span> bh<span class="token operator">-&gt;</span>b_blocknr<span class="token punctuation">)</span> <span class="token operator">=</span> bh<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_next<span class="token punctuation">)</span></span>
<span class="line">        bh<span class="token operator">-&gt;</span>b_next<span class="token operator">-&gt;</span>b_prev <span class="token operator">=</span> bh<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="find-buffer-åˆ©ç”¨-hash-è¡¨åœ¨é«˜é€Ÿç¼“å†²ä¸­å¯»æ‰¾ç»™å®šè®¾å¤‡å’ŒæŒ‡å®šå—å·çš„ç¼“å†²å—" tabindex="-1"><a class="header-anchor" href="#find-buffer-åˆ©ç”¨-hash-è¡¨åœ¨é«˜é€Ÿç¼“å†²ä¸­å¯»æ‰¾ç»™å®šè®¾å¤‡å’ŒæŒ‡å®šå—å·çš„ç¼“å†²å—"><span>find_buffer() - åˆ©ç”¨ hash è¡¨åœ¨é«˜é€Ÿç¼“å†²ä¸­å¯»æ‰¾ç»™å®šè®¾å¤‡å’ŒæŒ‡å®šå—å·çš„ç¼“å†²å—</span></a></h4><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> <span class="token function">find_buffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> tmp<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> tmp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> tmp <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>b_next<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>b_dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> tmp<span class="token operator">-&gt;</span>b_blocknr <span class="token operator">==</span> block<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> tmp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="get-hash-table-åˆ©ç”¨-hash-è¡¨å¯»æ‰¾æŒ‡å®šç¼“å†²å—" tabindex="-1"><a class="header-anchor" href="#get-hash-table-åˆ©ç”¨-hash-è¡¨å¯»æ‰¾æŒ‡å®šç¼“å†²å—"><span>get_hash_table() - åˆ©ç”¨ hash è¡¨å¯»æ‰¾æŒ‡å®šç¼“å†²å—</span></a></h4><p>è‹¥æ‰¾åˆ°ï¼Œåˆ™å¯¹ç¼“å†²å—ä¸Šé”ï¼Œå¹¶è¿”å›å—çš„å¤´æŒ‡é’ˆã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> <span class="token function">get_hash_table</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bh <span class="token operator">=</span> <span class="token function">find_buffer</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// ç¼“å†²å—ä¸­æ²¡æœ‰</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">        bh<span class="token operator">-&gt;</span>b_count<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// å¢åŠ å¼•ç”¨æ¬¡æ•°</span></span>
<span class="line">        <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…è§£é”</span></span>
<span class="line">        <span class="token comment">// ç¡çœ çŠ¶æ€åï¼Œéœ€è¦æ£€éªŒç¼“å†²å—çš„æ­£ç¡®æ€§</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> bh<span class="token operator">-&gt;</span>b_blocknr <span class="token operator">==</span> block<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> bh<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ç¼“å†²å—çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œæ’¤é”€å¼•ç”¨ï¼Œé‡æ–°å¯»æ‰¾</span></span>
<span class="line">        bh<span class="token operator">-&gt;</span>b_count<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="getblk-å–é«˜é€Ÿç¼“å†²ä¸­æŒ‡å®šçš„ç¼“å†²å—" tabindex="-1"><a class="header-anchor" href="#getblk-å–é«˜é€Ÿç¼“å†²ä¸­æŒ‡å®šçš„ç¼“å†²å—"><span>getblk() - å–é«˜é€Ÿç¼“å†²ä¸­æŒ‡å®šçš„ç¼“å†²å—</span></a></h4><p>æ£€æŸ¥æŒ‡å®šè®¾å¤‡å·å’Œå—å·çš„ç¼“å†²å—æ˜¯å¦å·²åœ¨é«˜é€Ÿç¼“å†²ä¸­ï¼š</p><ul><li>å¦‚æœæ˜¯ï¼Œåˆ™è¿”å›å¯¹åº”çš„å¤´æŒ‡é’ˆ</li><li>å¦‚æœä¸æ˜¯ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªå¯¹åº”è®¾å¤‡å·å’Œå—å·çš„æ–°é¡¹ï¼Œå¹¶è¿”å›ç¼“å†²å—å¤´æŒ‡é’ˆ</li></ul><p>é¦–å…ˆå®šä¹‰äº†åˆ¤æ–­ç¼“å†²å—æƒé‡çš„å® - ä¿®æ”¹æ ‡å¿—çš„æƒé‡è¾ƒé«˜ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BADNESS</span><span class="token expression"><span class="token punctuation">(</span>bh<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token operator">-&gt;</span>b_dirt<span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token operator">-&gt;</span>b_lock<span class="token punctuation">)</span></span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> <span class="token function">getblk</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> tmp<span class="token punctuation">,</span> <span class="token operator">*</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">repeat<span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh <span class="token operator">=</span> <span class="token function">get_hash_table</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// ç¼“å†²åŒºå·²åœ¨é«˜é€Ÿç¼“å†²ä¸­</span></span>
<span class="line">        <span class="token keyword">return</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¦åˆ™å°±å¼€å§‹æ‰«æç©ºé—²é“¾è¡¨</span></span>
<span class="line">    tmp <span class="token operator">=</span> free_list<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">do</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>b_count<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// ç¼“å†²å—æ­£è¢«ä½¿ç”¨ï¼Œè·³è¿‡</span></span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh <span class="token operator">||</span> <span class="token function">BADNESS</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">BADNESS</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            bh <span class="token operator">=</span> tmp<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">BADNESS</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// BADNESS == 0</span></span>
<span class="line">                <span class="token comment">// æ²¡æœ‰é”å®šï¼Œæ²¡æœ‰ä¿®æ”¹çš„å—</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tmp <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>b_next_free<span class="token punctuation">)</span> <span class="token operator">!=</span> free_list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ‰€æœ‰ç¼“å†²å—éƒ½è¢«ä½¿ç”¨ï¼Œåˆ™ç¡çœ ç­‰å¾…</span></span>
<span class="line">        <span class="token function">sleep_on</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_wait<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å”¤é†’åé‡æ–°å¯»æ‰¾ç¼“å†²å—</span></span>
<span class="line">        <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰¾åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„ç©ºé—²ç¼“å†²å—</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_count<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// å”¤é†’åè¯¥å—åˆè¢«å ç”¨äº†</span></span>
<span class="line">        <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ç¼“å†²åŒºå·²è¢«ä¿®æ”¹</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dirt<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ•°æ®å†™ç›˜</span></span>
<span class="line">        <span class="token function">sync_dev</span><span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_dev<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å†æ¬¡ç­‰å¾…ç¼“å†²åŒºè§£é”</span></span>
<span class="line">        <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_count<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// åˆè¢«å ç”¨......</span></span>
<span class="line">            <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¡çœ ç­‰å¾…çš„è¿‡ç¨‹ä¸­</span></span>
<span class="line">    <span class="token comment">// å…¶å®ƒè¿›ç¨‹å¯èƒ½å·²ç»å°†è¯¥ç¼“å†²å—åŠ å…¥é«˜é€Ÿç¼“å†²ä¸­</span></span>
<span class="line">    <span class="token comment">// å†æ¬¡æ£€æŸ¥</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">find_buffer</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å ç”¨ç¼“å†²å—</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_dirt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_uptodate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">remove_from_queue</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç§»å‡ºç©ºé—²é“¾è¡¨</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_dev <span class="token operator">=</span> dev<span class="token punctuation">;</span></span>
<span class="line">    bh<span class="token operator">-&gt;</span>b_blocknr <span class="token operator">=</span> block<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">insert_into_queues</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ’å…¥åˆ°ç©ºé—²é“¾è¡¨å°¾éƒ¨</span></span>
<span class="line">    <span class="token keyword">return</span> bh<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="brelse-é‡Šæ”¾æŒ‡å®šç¼“å†²å—" tabindex="-1"><a class="header-anchor" href="#brelse-é‡Šæ”¾æŒ‡å®šç¼“å†²å—"><span>brelse() - é‡Šæ”¾æŒ‡å®šç¼“å†²å—</span></a></h4><p>ç­‰å¾…ç¼“å†²å—è§£é”ï¼Œç„¶åå°†å¼•ç”¨è®¡æ•°é€’å‡ï¼Œæœ€åå”¤é†’ç­‰å¾…ç©ºé—²ç¼“å†²å—çš„è¿›ç¨‹ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">brelse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> buf<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>buf<span class="token operator">-&gt;</span>b_count<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Trying to free free buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer_wait<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="bread-è¯»å–æŒ‡å®šæ•°æ®å—-å¹¶è¿”å›å«æœ‰æ•°æ®çš„ç¼“å†²åŒº" tabindex="-1"><a class="header-anchor" href="#bread-è¯»å–æŒ‡å®šæ•°æ®å—-å¹¶è¿”å›å«æœ‰æ•°æ®çš„ç¼“å†²åŒº"><span>bread() - è¯»å–æŒ‡å®šæ•°æ®å—ï¼Œå¹¶è¿”å›å«æœ‰æ•°æ®çš„ç¼“å†²åŒº</span></a></h4><p>æ ¹æ®è®¾å¤‡å·å’Œæ•°æ®å—å·ï¼Œåœ¨é«˜é€Ÿç¼“å†²åŒºç”³è¯·ä¸€å—ç¼“å†²å—ï¼š</p><ul><li>è‹¥ç¼“å†²å—å·²å«æœ‰æœ‰æ•ˆçš„æ•°æ®ï¼Œå°±ç›´æ¥è¿”å›ç¼“å†²å—æŒ‡é’ˆ</li><li>å¦åˆ™è¯»å–æŒ‡å®šçš„æ•°æ®åˆ°ç¼“å†²å—ï¼Œå¹¶è¿”å›ç¼“å†²å—æŒ‡é’ˆ</li></ul><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> <span class="token function">bread</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> block<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bh <span class="token operator">=</span> <span class="token function">getblk</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;bread: getblk returned NULL\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// æ•°æ®æœ‰æ•ˆï¼Œå¯ç›´æ¥ä½¿ç”¨</span></span>
<span class="line">        <span class="token keyword">return</span> bh<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>READ<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// äº§ç”Ÿè¯»å–å—è®¾å¤‡çš„è¯·æ±‚</span></span>
<span class="line">    <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…æ•°æ®è¢«è¯»å…¥ï¼Œç­‰å¾…ç¼“å†²åŒºè§£é”</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// ç¼“å†²åŒºå·²æ›´æ–°</span></span>
<span class="line">        <span class="token keyword">return</span> bh<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// è¯»è®¾å¤‡æ“ä½œå¤±è´¥ï¼Œé‡Šæ”¾ç¼“å†²åŒº</span></span>
<span class="line">    <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="bread-page-ä¸€æ¬¡è¯»å–å››ä¸ªç¼“å†²å—" tabindex="-1"><a class="header-anchor" href="#bread-page-ä¸€æ¬¡è¯»å–å››ä¸ªç¼“å†²å—"><span>bread_page() - ä¸€æ¬¡è¯»å–å››ä¸ªç¼“å†²å—</span></a></h4><p>åŒæ—¶è¯»å–å››å—å¯ä»¥è·å¾—é€Ÿåº¦ä¸Šçš„å¥½å¤„ï¼Œå‚æ•°ä¸­çš„æ•°ç»„ <code>b[4]</code> åŒ…å«äº†å››ä¸ªè®¾å¤‡æ•°æ®å—å·ã€‚</p><p>å¤åˆ¶å†…å­˜å—çš„å® - ä» from åœ°å€å¤åˆ¶ä¸€å— (1024B) åˆ° to ä½ç½®ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">COPYBLK</span><span class="token expression"><span class="token punctuation">(</span>from<span class="token punctuation">,</span> to<span class="token punctuation">)</span> </span><span class="token punctuation">\\</span></span>
<span class="line"><span class="token expression"><span class="token function">__asm__</span><span class="token punctuation">(</span></span><span class="token string">&quot;cld\\n\\t&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token string">&quot;rep\\n\\t&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token string">&quot;movsl\\n\\t&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token expression"><span class="token operator">::</span></span><span class="token string">&quot;c&quot;</span><span class="token expression"><span class="token punctuation">(</span>BLOCK_SIZE<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token string">&quot;S&quot;</span><span class="token expression"><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token string">&quot;D&quot;</span><span class="token expression"><span class="token punctuation">(</span>to<span class="token punctuation">)</span> </span><span class="token punctuation">\\</span></span>
<span class="line">    <span class="token expression"><span class="token operator">:</span></span><span class="token string">&quot;cx&quot;</span><span class="token expression"><span class="token punctuation">,</span> </span><span class="token string">&quot;di&quot;</span><span class="token expression"><span class="token punctuation">,</span> </span><span class="token string">&quot;si&quot;</span><span class="token expression"><span class="token punctuation">)</span></span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">bread_page</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getblk</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// å–å¾—å¯¹åº”ç¼“å†²å—</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>b_updodate<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token comment">// å¦‚æœç¼“å†²å—ä¸­çš„æ•°æ®ä¸å¯ç”¨</span></span>
<span class="line">                    <span class="token comment">// äº§ç”Ÿè¯»è®¾å¤‡è¯·æ±‚</span></span>
<span class="line">                    <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>READ<span class="token punctuation">,</span> bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…ç¼“å†²åŒºè§£é”</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span></span>
<span class="line">                <span class="token comment">// æ•°æ®æœ‰æ•ˆï¼Œå¤åˆ¶æ•°æ®</span></span>
<span class="line">                <span class="token function">COPYBLK</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>b_data<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾ç¼“å†²åŒº</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="breada-ä»æŒ‡å®šè®¾å¤‡è¯»å–æŒ‡å®šçš„ä¸€äº›å—" tabindex="-1"><a class="header-anchor" href="#breada-ä»æŒ‡å®šè®¾å¤‡è¯»å–æŒ‡å®šçš„ä¸€äº›å—"><span>breada() - ä»æŒ‡å®šè®¾å¤‡è¯»å–æŒ‡å®šçš„ä¸€äº›å—</span></a></h4><p>å‡½æ•°å‚æ•°ä¸ªæ•°å¯å˜ï¼ŒæˆåŠŸæ—¶è¿”å›ç¬¬ä¸€å—çš„ buffer_head æŒ‡é’ˆï¼Œå¦åˆ™è¿”å› NULLã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> <span class="token function">breada</span><span class="token punctuation">(</span><span class="token keyword">int</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> first<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    va_list args<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> bh<span class="token punctuation">,</span> <span class="token operator">*</span> tmp<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bh <span class="token operator">=</span> <span class="token function">getblk</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;bread: getblk returned NULL\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bh<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>READ<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é¢„è¯»éšåçš„æ•°æ®å—</span></span>
<span class="line">    <span class="token comment">// åªéœ€è¯»è¿›é«˜é€Ÿç¼“å†²åŒºï¼Œå¹¶ä¸é©¬ä¸Šä½¿ç”¨</span></span>
<span class="line">    <span class="token comment">// å› æ­¤è¯»å®Œåå°†å…¶å¼•ç”¨è®¡æ•°é€’å‡ï¼Œé‡Šæ”¾æ‰è¯¥å—</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>first <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        tmp <span class="token operator">=</span> <span class="token function">getblk</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">ll_rw_block</span><span class="token punctuation">(</span>READA<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            tmp<span class="token operator">-&gt;</span>b_count<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">wait_on_buffer</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç­‰å¾…ç¬¬ä¸€ä¸ªç¼“å†²åŒºè§£é”</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>bh<span class="token operator">-&gt;</span>b_uptodate<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// ç¼“å†²åŒºæ•°æ®æœ‰æ•ˆ</span></span>
<span class="line">        <span class="token keyword">return</span> bh<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// è¯»æ“ä½œå¤±è´¥ï¼Œé‡Šæ”¾ç¼“å†²åŒºï¼Œè¿”å› NULL</span></span>
<span class="line">    <span class="token function">brelse</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="buffer-init-ç¼“å†²åŒºåˆå§‹åŒ–å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#buffer-init-ç¼“å†²åŒºåˆå§‹åŒ–å‡½æ•°"><span>buffer_init() - ç¼“å†²åŒºåˆå§‹åŒ–å‡½æ•°</span></a></h4><p>ä»ç¼“å†²åŒºå¤´å’Œå°¾åˆ†åˆ«åˆå§‹åŒ– buffer_head å’Œå¯¹åº”çš„æ•°æ®å—ï¼Œç›´åˆ°ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å­˜éƒ½è¢«åˆ†é…å®Œæ¯•ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">buffer_init</span><span class="token punctuation">(</span><span class="token keyword">long</span> buffer_end<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span> h <span class="token operator">=</span> start_buffer<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token operator">*</span> b<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> i<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¡®å®šç¼“å†²åŒºé«˜ç«¯çš„å®é™…ä½ç½®</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer_end <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// ç¼“å†²åŒºé«˜ç«¯ç­‰äº 1MB</span></span>
<span class="line">        <span class="token comment">// 640KB - 1MB è¢«æ˜¾å­˜å’Œ BIOS ä½¿ç”¨</span></span>
<span class="line">        <span class="token comment">// å®é™…ç¼“å†²åŒºé«˜ç«¯åº”ä¸º 640KB</span></span>
<span class="line">        b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">640</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> buffer_end<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>b <span class="token operator">-=</span> BLOCK_SIZE<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>h <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_dev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// ç¼“å†²åŒºè®¾å¤‡å·</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_dirt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_lock <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_uptodate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_wait <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_prev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> b<span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_prev_free <span class="token operator">=</span> h<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> h<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        h<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        NR_BUFFERS<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x100000</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// b é€’å‡åˆ° 1MBï¼Œåˆ™è·³è¿‡ 384KB</span></span>
<span class="line">            b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0xA0000</span><span class="token punctuation">;</span> <span class="token comment">// è®© b æŒ‡å‘ 640KB å¤„</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    h<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">// h æŒ‡å‘æœ€åä¸€ä¸ªç¼“å†²å—å¤´</span></span>
<span class="line">    free_list <span class="token operator">=</span> start_buffer<span class="token punctuation">;</span> <span class="token comment">// ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆ</span></span>
<span class="line">    free_list<span class="token operator">-&gt;</span>b_pref_free <span class="token operator">=</span> h<span class="token punctuation">;</span> <span class="token comment">// å¤´éƒ¨å’Œå°¾éƒ¨å…³è”å¾ªç¯</span></span>
<span class="line">    h<span class="token operator">-&gt;</span>b_next_free <span class="token operator">=</span> free_list<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆå§‹åŒ–æ‰€æœ‰çš„ hash è¡¨é¡¹</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NR_HASH<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">        hash_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary"><span>Summary</span></a></h2><p>è¿™é‡Œæ¶‰åŠåˆ°å¾ˆå¤šçš„ sleep å’Œ wake upï¼Œè¿›ç¨‹çŠ¶æ€çš„æ”¹å˜å’Œå¯¹å…¨å±€æ•°æ®ç»“æ„çš„æ“ä½œå°è£…åœ¨å­å‡½æ•°å†…ï¼Œå¯¼è‡´ä»£ç å‘é«˜å±‚å°è£…çš„æ—¶å€™è¶Šæ¥è¶Šéš¾æ‡‚äº†...çœ‹æ‡‚éƒ½å¾ˆéš¾äº†ï¼Œæ›´ä¸ç”¨æå¼€å‘çš„éš¾åº¦äº†..è¿˜æ˜¯å¾ˆä½©æœçš„ã€‚ğŸ‘</p>`,111)]))}const k=s(o,[["render",i],["__file","Chapter 12.2 - buffer.c ç¨‹åº.html.vue"]]),d=JSON.parse('{"path":"/linux-kernel-comments-notes/Chapter%2012%20-%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/Chapter%2012.2%20-%20buffer.c%20%E7%A8%8B%E5%BA%8F.html","title":"Chapter 12.2 - buffer.c ç¨‹åº","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"12.2 buffer.c ç¨‹åº","slug":"_12-2-buffer-c-ç¨‹åº","link":"#_12-2-buffer-c-ç¨‹åº","children":[{"level":3,"title":"12.2.1 åŠŸèƒ½æè¿°","slug":"_12-2-1-åŠŸèƒ½æè¿°","link":"#_12-2-1-åŠŸèƒ½æè¿°","children":[]},{"level":3,"title":"12.2.2 ä»£ç æ³¨é‡Š","slug":"_12-2-2-ä»£ç æ³¨é‡Š","link":"#_12-2-2-ä»£ç æ³¨é‡Š","children":[]}]},{"level":2,"title":"Summary","slug":"summary","link":"#summary","children":[]}],"git":{},"filePathRelative":"linux-kernel-comments-notes/Chapter 12 - æ–‡ä»¶ç³»ç»Ÿ/Chapter 12.2 - buffer.c ç¨‹åº.md"}');export{k as comp,d as data};
