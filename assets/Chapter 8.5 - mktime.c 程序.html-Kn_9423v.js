import{_ as n,c as a,a as p,o as e}from"./app-7eKjwDat.js";const t={};function o(c,s){return e(),a("div",null,s[0]||(s[0]=[p(`<h1 id="chapter-8-5-mktime-c-程序" tabindex="-1"><a class="header-anchor" href="#chapter-8-5-mktime-c-程序"><span>Chapter 8.5 - mktime.c 程序</span></a></h1><p>Created by : Mr Dk.</p><p>2019 / 08 / 16 17:05</p><p>Ningbo, Zhejiang, China</p><hr><h2 id="_8-5-mktime-c-程序" tabindex="-1"><a class="header-anchor" href="#_8-5-mktime-c-程序"><span>8.5 mktime.c 程序</span></a></h2><h3 id="_8-5-1-功能描述" tabindex="-1"><a class="header-anchor" href="#_8-5-1-功能描述"><span>8.5.1 功能描述</span></a></h3><p>该程序中只有一个 <code>kernel_mktime()</code>，仅供内核使用。计算从 1970 年 1 月 1 日 0 时起到开机时刻的秒数，作为开机时间。</p><h3 id="_8-5-2-代码注释" tabindex="-1"><a class="header-anchor" href="#_8-5-2-代码注释"><span>8.5.2 代码注释</span></a></h3><p>首先是对各个时间单位秒数的宏定义：</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MINUTE</span> <span class="token expression"><span class="token number">60</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HOUR</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">*</span>MINUTE<span class="token punctuation">)</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DAY</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span>HOUR<span class="token punctuation">)</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">YEAR</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">365</span><span class="token operator">*</span>DAY<span class="token punctuation">)</span></span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义了每个月开始时的秒数时间。这里考虑了闰年：2 月有 29 天。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">int</span> month<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                 <span class="token comment">// Janurary</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                              <span class="token comment">// Febrary</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                           <span class="token comment">// March</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token comment">// April</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                     <span class="token comment">// May</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                  <span class="token comment">// June</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token comment">// July</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment">// August</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// September</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// October</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// November</span></span>
<span class="line">    DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">29</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">)</span> <span class="token comment">// December</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来的函数，将 <code>tm</code> 结构体变量中的各字段计算为 1970.1.1 00:00:00 到该时间的秒数。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">long</span> <span class="token function">kernel_mktime</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span> tm<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">long</span> res<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> year<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 计算 1970 到现在经过的年数</span></span>
<span class="line">    year <span class="token operator">=</span> tm<span class="token operator">-&gt;</span>tm_year <span class="token operator">-</span> <span class="token number">70</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>tm<span class="token operator">-&gt;</span>tm_year <span class="token operator">&lt;</span> <span class="token number">70</span><span class="token punctuation">)</span> tm<span class="token operator">-&gt;</span>tm_year <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// res = 这些年的秒数 + 每个闰年多 1 天的秒数时间 + 当年到当时的秒数</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1972 年是 1970 年后的第一个闰年</span></span>
<span class="line">    <span class="token comment">// 从 1970 年开始的闰年数：1 + (y - 3)/4，即 (y + 1)/4</span></span>
<span class="line">    res <span class="token operator">=</span> YEAR<span class="token operator">*</span>year <span class="token operator">+</span> DAY<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>year<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    res <span class="token operator">+=</span> month<span class="token punctuation">[</span>tm<span class="token operator">-&gt;</span>tm_mon<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 非闰年 3 月以后，多算了 2 月 29 日</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 当年是闰年的判断方法：(y+2) 可以被 4 除尽</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>tm<span class="token operator">-&gt;</span>tm_mon <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        res <span class="token operator">-=</span> DAY<span class="token punctuation">;</span> <span class="token comment">// 减去多算的一天</span></span>
<span class="line">    res <span class="token operator">+=</span> DAY<span class="token operator">*</span><span class="token punctuation">(</span>tm<span class="token operator">-&gt;</span>tm_mday<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 本月已过去天数的秒数</span></span>
<span class="line">    res <span class="token operator">+=</span> HOUR<span class="token operator">*</span>tm<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">;</span>    <span class="token comment">// 本日已过去小时数的秒数</span></span>
<span class="line">    res <span class="token operator">+=</span> MINUTE<span class="token operator">*</span>tm<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">;</span>   <span class="token comment">// 本小时已过去分钟数的秒数</span></span>
<span class="line">    res <span class="token operator">+=</span> tm<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">;</span>          <span class="token comment">// 本分钟已过去的秒数</span></span>
<span class="line">    <span class="token keyword">return</span> res<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-3-其它信息" tabindex="-1"><a class="header-anchor" href="#_8-5-3-其它信息"><span>8.5.3 其它信息</span></a></h3><h4 id="_8-5-3-1-闰年时间的计算方法" tabindex="-1"><a class="header-anchor" href="#_8-5-3-1-闰年时间的计算方法"><span>8.5.3.1 闰年时间的计算方法</span></a></h4><p>若 y 能被 4 除尽且不能被 100 整除，或者能被 400 整除，则 y 是闰年。</p>`,18)]))}const r=n(t,[["render",o],["__file","Chapter 8.5 - mktime.c 程序.html.vue"]]),i=JSON.parse('{"path":"/linux-kernel-comments-notes/Chapter%208%20-%20%E5%86%85%E6%A0%B8%E4%BB%A3%E7%A0%81/Chapter%208.5%20-%20mktime.c%20%E7%A8%8B%E5%BA%8F.html","title":"Chapter 8.5 - mktime.c 程序","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"8.5 mktime.c 程序","slug":"_8-5-mktime-c-程序","link":"#_8-5-mktime-c-程序","children":[{"level":3,"title":"8.5.1 功能描述","slug":"_8-5-1-功能描述","link":"#_8-5-1-功能描述","children":[]},{"level":3,"title":"8.5.2 代码注释","slug":"_8-5-2-代码注释","link":"#_8-5-2-代码注释","children":[]},{"level":3,"title":"8.5.3 其它信息","slug":"_8-5-3-其它信息","link":"#_8-5-3-其它信息","children":[]}]}],"git":{},"filePathRelative":"linux-kernel-comments-notes/Chapter 8 - 内核代码/Chapter 8.5 - mktime.c 程序.md"}');export{r as comp,i as data};
