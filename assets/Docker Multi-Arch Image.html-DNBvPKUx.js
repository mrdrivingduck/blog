import{_ as s,c as a,a as e,o as l}from"./app-BeHGwf2X.js";const i="/blog/assets/docker-image-multi-arch-DmPCszb7.png",r={};function t(c,n){return l(),a("div",null,n[0]||(n[0]=[e(`<h1 id="docker-multi-arch-image" tabindex="-1"><a class="header-anchor" href="#docker-multi-arch-image"><span>Docker - Multi-Arch Image</span></a></h1><p>Created by : Mr Dk.</p><p>2022 / 05 / 15 16:15</p><p>Hangzhou, Zhejiang, China</p><hr><h2 id="background" tabindex="-1"><a class="header-anchor" href="#background"><span>Background</span></a></h2><p>è¿‘æ—¥ï¼Œç”±äºå·¥ä½œä¸Šçš„éœ€è¦ï¼Œè¦æŠŠè½¯ä»¶æ‰“åŒ…æ„å»ºåˆ° Docker é•œåƒä¸­ï¼Œå¹¶ä¸”è¯¥ Docker é•œåƒè¿˜è¦æ”¯æŒ <strong>å¤šç§ CPU æ¶æ„</strong>ã€‚å…¶å®ä¹‹å‰å·²ç»æˆ–å¤šæˆ–å°‘ä½¿ç”¨è¿‡å¤šæ¶æ„çš„é•œåƒäº†ã€‚è®°å¾—æœ‰ä¸€æ¬¡åœ¨ä¸€å° x86 CPU çš„æœºå™¨ä¸Šæ„å»ºäº†ä¸€ä¸ªé•œåƒå¹¶ push åˆ° DockerHub ä¸Šä»¥åï¼Œåœ¨ Apple M1 çš„ MacBook ä¸Š <code>docker pull</code> æ—¶çœ‹åˆ°äº†è­¦å‘Šï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">The requested image&#39;s platform (linux/amd64) does not match the detected host platform (linux/arm64) and nospecific platform was requested.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ‰€ä»¥ï¼Œä¸€ä¸ªé•œåƒå¦‚æœæƒ³åœ¨ç‰¹å®š CPU æ¶æ„ä¸Šè¿è¡Œï¼Œå°±è¦ä¸ºè¿™ä¸ª CPU æ¶æ„æ‰“ä¸€ä¸ªç‹¬ç«‹çš„é•œåƒã€‚ä¸ºæ¯ä¸ª CPU æ¶æ„ä¸Šçš„é•œåƒæ‰“ä¸€ä¸ª tag å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯ä¸å¤Ÿä¼˜é›…ã€‚å› ä¸º tag ä¸€èˆ¬æ¥è¯´ç”¨æ¥åŒºåˆ†é•œåƒå†…è½¯ä»¶çš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯ç”¨æ¥åŒºåˆ†é•œåƒçš„è¿è¡Œå¹³å°ã€‚Docker å·²ç»å°†é•œåƒçš„è¿è¡Œå¹³å°ç»´æŠ¤åœ¨ manifest ä¸­ã€‚ä»¥ DockerHub ä¸Šçš„ Ubuntu å®˜æ–¹é•œåƒä¸ºä¾‹ï¼š</p><p><img src="`+i+`" alt="multi-arch-image"></p><p>Tag çš„ä½œç”¨æ˜¯æ ‡è¯†é•œåƒ Ubuntu çš„ 22.04 / 20.04 / 18.04 ... ç­‰ç‰ˆæœ¬ï¼Œä½†æ¯ä¸ª tag ä¸Šæœ‰å¤šä¸ª OS/ARCHã€‚å¯ä»¥çœ‹åˆ°ï¼ŒUbuntu æ”¯æŒåœ¨ amd64ã€armv7ã€arm64(v8)ã€ppc64leã€riscv64ã€s390x æ¶æ„çš„ Linux ä¸Šè¿è¡Œã€‚</p><p><img src="https://miro.medium.com/max/1400/1*Iu-K4kpFkTOqC4qMy9pFXg.png" alt="docker-buildx"></p><p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä¹Ÿæƒ³æ‰“ä¸€ä¸ª multi-arch çš„é•œåƒæ€ä¹ˆåŠå‘¢ï¼Ÿåªèƒ½åœ¨ç›¸åº” CPU æ¶æ„çš„æœºå™¨ä¸Šæ‰å¯ä»¥æ„å»ºé•œåƒå—ï¼Ÿ</p><h2 id="buildx" tabindex="-1"><a class="header-anchor" href="#buildx"><span>Buildx</span></a></h2><p>å¹¶ä¸æ˜¯ã€‚åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œä½¿ç”¨ <a href="https://docs.docker.com/buildx/working-with-buildx/" target="_blank" rel="noopener noreferrer">Docker BuildX</a> æ’ä»¶ï¼Œä»¥ä¸ <code>docker build</code> ç±»ä¼¼çš„æ–¹å¼ï¼Œå°±å¯ä»¥æ„å»ºå‡ºå¤šæ¶æ„é•œåƒã€‚Docker BuildX ä½¿ç”¨ QEMU åœ¨ä¸€å°æœºå™¨ä¸Šæ¨¡æ‹Ÿè¿è¡Œå¦ä¸€ä¸ª CPU æ¶æ„çš„æŒ‡ä»¤ï¼Œä»è€Œå®ç°åœ¨ä¸€å°æœºå™¨ä¸Šæ„å»ºå¤šä¸ª CPU æ¶æ„çš„é•œåƒã€‚</p><p>æ‰€ä»¥ç¬¬ä¸€æ­¥è‚¯å®šæ˜¯å®‰è£… Docker BuildXã€‚æå®šä¹‹åï¼Œçœ‹çœ‹ç›®å‰æ”¯æŒçš„ CPU æ¶æ„æœ‰å“ªäº›ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker</span> buildx inspect <span class="token parameter variable">--bootstrap</span></span>
<span class="line">Name:   default</span>
<span class="line">Driver: <span class="token function">docker</span></span>
<span class="line"></span>
<span class="line">Nodes:</span>
<span class="line">Name:      default</span>
<span class="line">Endpoint:  default</span>
<span class="line">Status:    running</span>
<span class="line">Platforms: linux/amd64, linux/386</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰æ”¯æŒçš„åªæœ‰ 32/64 ä½çš„ x86 CPUã€‚å¾ˆæ­£å¸¸ï¼Œå› ä¸ºè¿™å°æœºå™¨ç›®å‰å°±å®‰è£…ç€ Intel çš„èŠ¯ç‰‡ã€‚é‚£ä¹ˆå¦‚ä½•åšåˆ°ä½¿ç”¨ QEMU æ¨¡æ‹Ÿå…¶å®ƒ CPU æ¶æ„çš„æŒ‡ä»¤å‘¢ï¼Ÿæ ¹æ® <a href="https://docs.docker.com/buildx/working-with-buildx/#build-multi-platform-images" target="_blank" rel="noopener noreferrer">Docker BuildX çš„æ–‡æ¡£</a>ï¼Œçœ‹èµ·æ¥éœ€è¦å‘å½“å‰æœºå™¨çš„ <code>binfmt_misc</code>ï¼ˆæ­¤å¤„æœ‰ç‚¹çœ¼ç†Ÿ ğŸ¤­ çˆ·é’å›ï¼‰æ¥å£æŒ‚è½½å…¶å®ƒ CPU æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†å‡½æ•°ã€‚å¤„ç†å‡½æ•°å†…ä¼°è®¡å°è£…äº† emulate å…¶å®ƒ CPU æŒ‡ä»¤çš„é€»è¾‘ã€‚ä½¿ç”¨æ–‡æ¡£å†…æä¾›çš„ä¸€è¡Œå‘½ä»¤ï¼Œå®‰è£…æ‰€æœ‰å¯ä»¥æ”¯æŒçš„ binfmtï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker</span> run <span class="token parameter variable">--privileged</span> <span class="token parameter variable">--rm</span> tonistiigi/binfmt <span class="token parameter variable">--install</span> all</span>
<span class="line">Unable to <span class="token function">find</span> image <span class="token string">&#39;tonistiigi/binfmt:latest&#39;</span> locally</span>
<span class="line">latest: Pulling from tonistiigi/binfmt</span>
<span class="line">2b4d0e08bd75: Pull complete</span>
<span class="line">c331be51c382: Pull complete</span>
<span class="line">Digest: sha256:5bf63a53ad6222538112b5ced0f1afb8509132773ea6dd3991a197464962854e</span>
<span class="line">Status: Downloaded newer image <span class="token keyword">for</span> tonistiigi/binfmt:latest</span>
<span class="line">installing: ppc64le OK</span>
<span class="line">installing: riscv64 OK</span>
<span class="line">installing: mips64le OK</span>
<span class="line">installing: arm64 OK</span>
<span class="line">installing: arm OK</span>
<span class="line">installing: s390x OK</span>
<span class="line">installing: mips64 OK</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;supported&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;linux/amd64&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/arm64&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/riscv64&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/ppc64le&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/s390x&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/386&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/mips64le&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/mips64&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/arm/v7&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;linux/arm/v6&quot;</span></span>
<span class="line">  <span class="token punctuation">]</span>,</span>
<span class="line">  <span class="token string">&quot;emulators&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;qemu-aarch64&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;qemu-arm&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;qemu-mips64&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;qemu-mips64el&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;qemu-ppc64le&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;qemu-riscv64&quot;</span>,</span>
<span class="line">    <span class="token string">&quot;qemu-s390x&quot;</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ¬¡æŸ¥çœ‹ BuildXï¼Œå¯ä»¥çœ‹åˆ° <code>Platforms</code> ä¸­å¤šå‡ºäº†å¾ˆå¤š CPU æ¶æ„ï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker</span> buildx inspect <span class="token parameter variable">--bootstrap</span></span>
<span class="line">Name:   default</span>
<span class="line">Driver: <span class="token function">docker</span></span>
<span class="line"></span>
<span class="line">Nodes:</span>
<span class="line">Name:      default</span>
<span class="line">Endpoint:  default</span>
<span class="line">Status:    running</span>
<span class="line">Platforms: linux/amd64, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/arm/v7, linux/arm/v6</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡†å¤‡å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹æ„å»ºäº†ã€‚<code>docker buildx build</code> å‘½ä»¤ä¸ <code>docker build</code> æœ‰ä¸€äº›ç»†å¾®çš„å·®åˆ«ã€‚é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ª builderï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker</span> buildx create <span class="token parameter variable">--name</span> multibuilder</span>
<span class="line">$ <span class="token function">docker</span> buildx use multibuilder</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åä½¿ç”¨è¿™ä¸ª builder è¿›è¡Œæ„å»ºï¼š</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">docker</span> buildx build <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--push</span> <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--platform</span> linux/amd64,linux/arm64 <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--tag</span> xxx/xxx:latest <span class="token punctuation">\\</span></span>
<span class="line">    <span class="token parameter variable">--file</span> Dockerfile <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»è¿‡ä½“éªŒï¼Œnative æŒ‡ä»¤é›†ï¼ˆå¯¹æˆ‘çš„æœºå™¨è€Œè¨€æ˜¯ amd64ï¼‰çš„é•œåƒæ„å»ºé€Ÿåº¦æœ€å¿«ï¼Œè¿œå¿«äº QEMU å¯¹å…¶å®ƒæŒ‡ä»¤é›†çš„æ¨¡æ‹Ÿã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•åªéœ€è¦ä¸€å°æœºå™¨å°±å¯ä»¥æ„å»ºèƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰ CPU å¹³å°ä¸Šçš„é•œåƒäº†ã€‚</p><h2 id="å¦‚ä½•ä½¿-dockerfile-ä¸-arch-æ— å…³" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿-dockerfile-ä¸-arch-æ— å…³"><span>å¦‚ä½•ä½¿ Dockerfile ä¸ ARCH æ— å…³</span></a></h2><p>å¯¹äºä¸åŒ arch ä¸Šçš„é•œåƒæ„å»ºï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ multi-arch çš„åŸºç¡€é•œåƒï¼Œè¿™æ²¡ä»€ä¹ˆé—®é¢˜ã€‚è¿™æ ·ä½¿ç”¨åŒä¸€ä»½ Dockerfile å°±å¯ä»¥æ„å»ºæˆ‘ä»¬è‡ªå·±çš„ multi-arch é•œåƒã€‚ä½†æœ‰æ—¶ï¼ŒåŒä¸€ä¸ªè½¯ä»¶åŒ…åœ¨ä¸åŒ arch ä¸Šçš„ç‰ˆæœ¬ä¸åŒï¼Œä½¿ä¸å¾—ä¸åœ¨ Dockerfile çš„å±‚é¢ä¸Šå»åŠ ä»¥åŒºåˆ«ã€‚å¦‚ä½•é¿å…ä¸ºä¸åŒçš„ arch å†™ä¸¤ä»½ Dockerfile å‘¢ï¼Ÿ</p><p>ä½¿ç”¨é•œåƒæ„å»ºæ—¶è‡ªåŠ¨ä¼ å…¥çš„é¢„å®šä¹‰ <code>ARG</code> æ¥åˆ¤æ–­æ„å»ºçš„ç›®æ ‡å¹³å°ï¼Œç„¶åä½¿ç”¨ shell çš„è¯­æ³•æ¥å¯¹ä¸åŒçš„å¹³å°æ‰§è¡Œä¸åŒçš„ <code>RUN</code> æŒ‡ä»¤ã€‚</p><p>é•œåƒæ„å»ºæ—¶å°†ä¼šé¢„å®šä¹‰å¦‚ä¸‹çš„ <code>ARG</code>ï¼š</p><ul><li><code>TARGETPLATFORM</code>ï¼š<code>linux/amd64</code> / <code>linux/arm/v7</code> ç­‰</li><li><code>TARGETOS</code>ï¼š<code>linux</code> / <code>windows</code> ç­‰</li><li><code>TARGETARCH</code>ï¼š<code>amd64</code> / <code>arm64</code> ç­‰</li></ul><p>åœ¨ Dockerfile ä¸­ä½¿ç”¨ shell è¯­æ³•åˆ¤æ–­è¿™äº› <code>ARG</code>ï¼š</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> if [ <span class="token string">&quot;$TARGETARCH&quot;</span> = <span class="token string">&quot;amd64&quot;</span> ]; then <span class="token operator">\\</span></span>
<span class="line">        OCI_ARCH=x86_64; <span class="token operator">\\</span></span>
<span class="line">        OCI_VERSION=19.14; <span class="token operator">\\</span></span>
<span class="line">    elif [ <span class="token string">&quot;$TARGETARCH&quot;</span> = <span class="token string">&quot;arm64&quot;</span> ]; then <span class="token operator">\\</span></span>
<span class="line">        OCI_ARCH=aarch64; <span class="token operator">\\</span></span>
<span class="line">        OCI_VERSION=19.10; <span class="token operator">\\</span></span>
<span class="line">    else <span class="token operator">\\</span></span>
<span class="line">        OCI_ARCH=x86_64; <span class="token operator">\\</span></span>
<span class="line">        OCI_VERSION=19.14; <span class="token operator">\\</span></span>
<span class="line">    fi &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    wget --no-verbose <span class="token operator">\\</span></span>
<span class="line">        https://xxx/<span class="token variable">\${OCI_ARCH}</span>/<span class="token variable">\${OCI_VERSION}</span>-basic-<span class="token variable">\${OCI_VERSION}</span>.<span class="token variable">\${OCI_ARCH}</span>.rpm</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="references" tabindex="-1"><a class="header-anchor" href="#references"><span>References</span></a></h2><p><a href="https://medium.com/nttlabs/buildx-multiarch-2c6c2df00ca2" target="_blank" rel="noopener noreferrer">Preparation toward running Docker on ARM Mac: Building multi-arch images with Docker BuildX</a></p><p><a href="https://www.docker.com/blog/getting-started-with-docker-for-arm-on-linux/" target="_blank" rel="noopener noreferrer">Getting started with Docker for Arm on Linux</a></p><p><a href="https://docs.docker.com/buildx/working-with-buildx/" target="_blank" rel="noopener noreferrer">Docker Buildx</a></p><p><a href="https://docs.docker.com/engine/reference/commandline/buildx_build/" target="_blank" rel="noopener noreferrer">docker buildx build</a></p><p><a href="https://docs.docker.com/engine/reference/builder/#automatic-platform-args-in-the-global-scope" target="_blank" rel="noopener noreferrer">Automatic platform ARGs in the global scope</a></p><p><a href="https://www.docker.com/blog/faster-multi-platform-builds-dockerfile-cross-compilation-guide/" target="_blank" rel="noopener noreferrer">Faster Multi-Platform Builds: Dockerfile Cross-Compilation Guide</a></p><p><a href="https://nielscautaerts.xyz/making-dockerfiles-architecture-independent.html" target="_blank" rel="noopener noreferrer">Making Dockerfiles architecture independent</a></p>`,42)]))}const d=s(r,[["render",t],["__file","Docker Multi-Arch Image.html.vue"]]),o=JSON.parse('{"path":"/notes/Docker/Docker%20Multi-Arch%20Image.html","title":"Docker - Multi-Arch Image","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Background","slug":"background","link":"#background","children":[]},{"level":2,"title":"Buildx","slug":"buildx","link":"#buildx","children":[]},{"level":2,"title":"å¦‚ä½•ä½¿ Dockerfile ä¸ ARCH æ— å…³","slug":"å¦‚ä½•ä½¿-dockerfile-ä¸-arch-æ— å…³","link":"#å¦‚ä½•ä½¿-dockerfile-ä¸-arch-æ— å…³","children":[]},{"level":2,"title":"References","slug":"references","link":"#references","children":[]}],"git":{},"filePathRelative":"notes/Docker/Docker Multi-Arch Image.md"}');export{d as comp,o as data};
