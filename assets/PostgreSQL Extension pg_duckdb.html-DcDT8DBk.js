import{_ as s,c as a,a as p,o as t}from"./app-BeHGwf2X.js";const e={};function c(o,n){return t(),a("div",null,n[0]||(n[0]=[p(`<h1 id="postgresql-extension-pg-duckdb" tabindex="-1"><a class="header-anchor" href="#postgresql-extension-pg-duckdb"><span>PostgreSQL (Extension) - pg_duckdb</span></a></h1><p>Created by: Mr Dk.</p><p>2026 / 02 / 07 0:27</p><p>Hangzhou, Zhejiang, China</p><hr><h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景"><span>背景</span></a></h2><p><a href="https://github.com/duckdb/duckdb" target="_blank" rel="noopener noreferrer">DuckDB</a> 是一款高性能的嵌入式分析型数据库。与传统 C/S 架构的数据库不同，它可以直接嵌入在应用程序中，作为进程内库 (不是内裤) 被使用。DuckDB 的核心特性包括：采用列式存储，能够高效压缩数据；采用向量化执行引擎，能够充分利用 CPU 缓存和 SIMD；采用并行化的查询处理，能够自动利用多核心的 CPU；支持全面的 SQL 标准和复杂查询，提供丰富的分析函数；此外还支持丰富的数据格式 (Parquet / CSV / JSON / ...) 与数据源 (S3 / HTTP / ...)，也支持 <a href="https://arrow.apache.org/" target="_blank" rel="noopener noreferrer">Apache Arrow</a> 格式的零拷贝数据交换。是数据科学家的利器。</p><p>在 SQL 语法的实现上，DuckDB 紧密遵循了 PostgreSQL 的 dialect，因此两者天然有一定的血缘关系。DuckDB 官方推出了 <a href="https://github.com/duckdb/pg_duckdb" target="_blank" rel="noopener noreferrer">pg_duckdb</a> 这款 PostgreSQL 插件，使 DuckDB 能够被嵌入到 PostgreSQL 的进程内。安装该插件后，PostgreSQL 便获得了 DuckDB 的上述所有能力。在保持其擅长的事务处理能力的同时，极大增强了数据分析能力。</p><p>本文基于 pg_duckdb 的 v1.1.1 版本，简要分析 pg_duckdb 是如何将 DuckDB 嵌入到 PostgreSQL 中为其提供分析能力的。</p><h2 id="加速-postgresql-的分析查询" tabindex="-1"><a class="header-anchor" href="#加速-postgresql-的分析查询"><span>加速 PostgreSQL 的分析查询</span></a></h2><p>PostgreSQL 的表数据使用行式存储，其执行器的执行模型也是逐行处理数据的经典火山模型。这种执行模型对分析型查询来说并不是特别高效。而如前所述，DuckDB 内部有面向列式存储的向量化执行引擎，能够出色地完成分析型查询。如果能够将 PostgreSQL 的表数据输入到 DuckDB 的向量化执行引擎中执行，就能极大提升 PostgreSQL 的分析能力。</p><p>要完成这个目标，理论上 DuckDB 需要能够识别 PostgreSQL 的表格式并读取数据，而且需要能够判断表内每一行数据的可见性。幸运的是，DuckDB 本身并不需要具有这个能力，pg_duckdb 会尽量复用 PostgreSQL 的现成能力，将 PostgreSQL 格式的数据喂入 DuckDB 的执行器中。</p><p>首先，pg_duckdb 使用 PostgreSQL 的 planner hook 机制，在 SQL 处理进入优化器阶段时接管，将执行流桥接到 pg_duckdb 的 C++ 代码中，并检查当前 SQL 是否需要/能够使用 DuckDB 来执行。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span></span>
<span class="line"><span class="token function">DuckdbInitHooks</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    prev_planner_hook <span class="token operator">=</span> planner_hook <span class="token operator">?</span> planner_hook <span class="token operator">:</span> standard_planner<span class="token punctuation">;</span></span>
<span class="line">    planner_hook <span class="token operator">=</span> DuckdbPlannerHook<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>检查内容包含是否启用了强制 DuckDB 执行的 GUC 参数、语法树中是否包含 DuckDB 的元素、SQL 语法是否是只读等等。只有通过检查，才会为后续扫描产生一个 DuckDB 的执行计划节点：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">static</span> PlannedStmt <span class="token operator">*</span></span>
<span class="line"><span class="token function">DuckdbPlannerHook_Cpp</span><span class="token punctuation">(</span>Query <span class="token operator">*</span>parse<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>query_string<span class="token punctuation">,</span> <span class="token keyword">int</span> cursor_options<span class="token punctuation">,</span> ParamListInfo bound_params<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">IsExtensionRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">NeedsDuckdbExecution</span><span class="token punctuation">(</span>parse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">TriggerActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">IsAllowedStatement</span><span class="token punctuation">(</span>parse<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">DuckdbPlanNode</span><span class="token punctuation">(</span>parse<span class="token punctuation">,</span> cursor_options<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">ShouldTryToUseDuckdbExecution</span><span class="token punctuation">(</span>parse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">TriggerActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            PlannedStmt <span class="token operator">*</span>duckdbPlan <span class="token operator">=</span> <span class="token function">DuckdbPlanNode</span><span class="token punctuation">(</span>parse<span class="token punctuation">,</span> cursor_options<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>duckdbPlan<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> duckdbPlan<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment">/* If we can&#39;t create a plan, we&#39;ll fall back to Postgres */</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>parse<span class="token operator">-&gt;</span>commandType <span class="token operator">!=</span> CMD_SELECT <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pgduckdb<span class="token double-colon punctuation">::</span>pg<span class="token double-colon punctuation">::</span><span class="token function">AllowWrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">elog</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">,</span> <span class="token string">&quot;Writing to DuckDB and Postgres tables in the same transaction block is not supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">prev_planner_hook</span><span class="token punctuation">(</span>parse<span class="token punctuation">,</span> query_string<span class="token punctuation">,</span> cursor_options<span class="token punctuation">,</span> bound_params<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来，将 PostgreSQL 的语法树 deparse 为 DuckDB 兼容的 SQL 语句，并传入 DuckDB 中得到一个 prepared statement。pg_duckdb 将相关信息组装好以后，构造一个 PostgreSQL 可以识别的 CustomScan 算子，并为这个算子注册了扫描时的回调函数：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">static</span> Plan <span class="token operator">*</span></span>
<span class="line"><span class="token function">CreatePlan</span><span class="token punctuation">(</span>Query <span class="token operator">*</span>query<span class="token punctuation">,</span> <span class="token keyword">bool</span> throw_error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> elevel <span class="token operator">=</span> throw_error <span class="token operator">?</span> ERROR <span class="token operator">:</span> WARNING<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">/*</span>
<span class="line">     * Prepare the query, se we can get the returned types and column names.</span>
<span class="line">     */</span></span>
<span class="line"></span>
<span class="line">    duckdb<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>duckdb<span class="token double-colon punctuation">::</span>PreparedStatement<span class="token operator">&gt;</span> prepared_query <span class="token operator">=</span> <span class="token function">DuckdbPrepare</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prepared_query<span class="token operator">-&gt;</span><span class="token function">HasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">elog</span><span class="token punctuation">(</span>elevel<span class="token punctuation">,</span> <span class="token string">&quot;(PGDuckDB/CreatePlan) Prepared query returned an error: %s&quot;</span><span class="token punctuation">,</span> prepared_query<span class="token operator">-&gt;</span><span class="token function">GetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    CustomScan <span class="token operator">*</span>duckdb_node <span class="token operator">=</span> <span class="token function">makeNode</span><span class="token punctuation">(</span>CustomScan<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">    duckdb_node<span class="token operator">-&gt;</span>custom_private <span class="token operator">=</span> <span class="token function">list_make1</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    duckdb_node<span class="token operator">-&gt;</span>methods <span class="token operator">=</span> <span class="token operator">&amp;</span>duckdb_scan_scan_methods<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span>Plan <span class="token operator">*</span><span class="token punctuation">)</span>duckdb_node<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在实际执行扫描时，当 PostgreSQL 的火山模型执行器试图从 CustomScan 算子拉出一行元组时，算子将从自己已经计算完毕的 Data Chunk 中构造一行并填入 PostgreSQL 的 TableTupleSlot。如果 Data Chunk 已经被消费完，则从 DuckDB 的向量化执行器中再拉取一批 Data Chunk：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">static</span> TupleTableSlot <span class="token operator">*</span></span>
<span class="line"><span class="token function">Duckdb_ExecCustomScan_Cpp</span><span class="token punctuation">(</span>CustomScanState <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    DuckdbScanState <span class="token operator">*</span>duckdb_scan_state <span class="token operator">=</span> <span class="token punctuation">(</span>DuckdbScanState <span class="token operator">*</span><span class="token punctuation">)</span>node<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">bool</span> already_executed <span class="token operator">=</span> duckdb_scan_state<span class="token operator">-&gt;</span>is_executed<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>already_executed<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">ExecuteQuery</span><span class="token punctuation">(</span>duckdb_scan_state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>duckdb_scan_state<span class="token operator">-&gt;</span>fetch_next<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            duckdb_scan_state<span class="token operator">-&gt;</span>current_data_chunk <span class="token operator">=</span> duckdb_scan_state<span class="token operator">-&gt;</span>query_results<span class="token operator">-&gt;</span><span class="token function">Fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            duckdb_scan_state<span class="token operator">-&gt;</span>current_row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">            duckdb_scan_state<span class="token operator">-&gt;</span>fetch_next <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>duckdb_scan_state<span class="token operator">-&gt;</span>current_data_chunk <span class="token operator">||</span> duckdb_scan_state<span class="token operator">-&gt;</span>current_data_chunk<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">MemoryContextReset</span><span class="token punctuation">(</span>duckdb_scan_state<span class="token operator">-&gt;</span>css<span class="token punctuation">.</span>ss<span class="token punctuation">.</span>ps<span class="token punctuation">.</span>ps_ExprContext<span class="token operator">-&gt;</span>ecxt_per_tuple_memory<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">ExecClearTuple</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">return</span> slot<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span>idx_t col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> duckdb_scan_state<span class="token operator">-&gt;</span>column_count<span class="token punctuation">;</span> col<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// FIXME: we should not use the Value API here, it&#39;s complicating the LIST conversion logic</span></span>
<span class="line">            <span class="token keyword">auto</span> value <span class="token operator">=</span> duckdb_scan_state<span class="token operator">-&gt;</span>current_data_chunk<span class="token operator">-&gt;</span><span class="token function">GetValue</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> duckdb_scan_state<span class="token operator">-&gt;</span>current_row<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                slot<span class="token operator">-&gt;</span>tts_isnull<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                slot<span class="token operator">-&gt;</span>tts_isnull<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">ConvertDuckToPostgresValue</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> value<span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">throw</span> duckdb<span class="token double-colon punctuation">::</span><span class="token function">ConversionException</span><span class="token punctuation">(</span><span class="token string">&quot;Value conversion failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">ExecStoreVirtualTuple</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> slot<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>exception <span class="token operator">&amp;</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">/* ... */</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么 DuckDB 的向量化执行器所需要的数据从哪来？在早些时候构造 DuckDB 的 prepared statement 时，原先对 PostgreSQL 表访问的部分将会被替换为 DuckDB 的 <code>pgduckdb_postgres_scan()</code> 函数，其中传入了要扫描的 PostgreSQL 表名、快照信息等。该函数的内部实现中，会根据要扫描的列，组装出一条对 PostgreSQL 进行全表扫描的 SQL：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">void</span></span>
<span class="line"><span class="token class-name">PostgresScanGlobalState</span><span class="token double-colon punctuation">::</span><span class="token function">ConstructTableScanQuery</span><span class="token punctuation">(</span><span class="token keyword">const</span> duckdb<span class="token double-colon punctuation">::</span>TableFunctionInitInput <span class="token operator">&amp;</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">/* SELECT COUNT(*) FROM */</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>column_ids<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> input<span class="token punctuation">.</span>column_ids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> UINT64_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        scan_query <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;SELECT COUNT(*) FROM &quot;</span> <span class="token operator">&lt;&lt;</span> pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">GenerateQualifiedRelationName</span><span class="token punctuation">(</span>rel<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        count_tuples_only <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">/*</span>
<span class="line">     * We need to read columns from the Postgres tuple in column order, but for</span>
<span class="line">     * outputting them we care about the DuckDB order. A map automatically</span>
<span class="line">     * orders them based on key, which in this case is the Postgres column</span>
<span class="line">     * order</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">    scan_query <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;SELECT &quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">    scan_query <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; FROM &quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token function">GenerateQualifiedRelationName</span><span class="token punctuation">(</span>rel<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>query_filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        scan_query <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; WHERE &quot;</span><span class="token punctuation">;</span></span>
<span class="line">        scan_query <span class="token operator">&lt;&lt;</span> <span class="token function">FilterJoin</span><span class="token punctuation">(</span>query_filters<span class="token punctuation">,</span> <span class="token string">&quot; AND &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这条 SQL 最终会被依次重新输入到 PostgreSQL 的解析器、优化器、执行器中，以获取 PostgreSQL 的表数据：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">void</span></span>
<span class="line"><span class="token class-name">PostgresTableReader</span><span class="token double-colon punctuation">::</span><span class="token function">InitUnsafe</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>table_scan_query<span class="token punctuation">,</span> <span class="token keyword">bool</span> count_tuples_only<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    List <span class="token operator">*</span>raw_parsetree_list <span class="token operator">=</span> <span class="token function">pg_parse_query</span><span class="token punctuation">(</span>table_scan_query<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token function">list_length</span><span class="token punctuation">(</span>raw_parsetree_list<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    RawStmt <span class="token operator">*</span>raw_parsetree <span class="token operator">=</span> <span class="token function">linitial_node</span><span class="token punctuation">(</span>RawStmt<span class="token punctuation">,</span> raw_parsetree_list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">PG_VERSION_NUM <span class="token operator">&gt;=</span> <span class="token number">150000</span></span></span></span>
<span class="line">    List <span class="token operator">*</span>query_list <span class="token operator">=</span> <span class="token function">pg_analyze_and_rewrite_fixedparams</span><span class="token punctuation">(</span>raw_parsetree<span class="token punctuation">,</span> table_scan_query<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></span>
<span class="line">    List <span class="token operator">*</span>query_list <span class="token operator">=</span> <span class="token function">pg_analyze_and_rewrite</span><span class="token punctuation">(</span>raw_parsetree<span class="token punctuation">,</span> table_scan_query<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">    PlannedStmt <span class="token operator">*</span>planned_stmt <span class="token operator">=</span> <span class="token function">standard_planner</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> table_scan_query<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    table_scan_query_desc <span class="token operator">=</span> <span class="token function">CreateQueryDesc</span><span class="token punctuation">(</span>planned_stmt<span class="token punctuation">,</span> table_scan_query<span class="token punctuation">,</span> <span class="token function">GetActiveSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> InvalidSnapshot<span class="token punctuation">,</span></span>
<span class="line">                                            None_Receiver<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">ExecutorStart</span><span class="token punctuation">(</span>table_scan_query_desc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>综上所述，pg_duckdb 从优化器开始介入执行流程，在执行计划中插入了能够调用 DuckDB 的 CustomScan 算子，将语法树 deparse 为 SQL 并转移给 DuckDB 执行，并将 SQL 中对 PostgreSQL 的表引用修改为 DuckDB 的 UDF。UDF 中重新拼接了全表扫描 PostgreSQL 表的 SQL，然后复用 PostgreSQL 对 SQL 的完整处理周期来得到 PostgreSQL 的表数据。</p><h2 id="根据-udf-直接使用-duckdb-执行" tabindex="-1"><a class="header-anchor" href="#根据-udf-直接使用-duckdb-执行"><span>根据 UDF 直接使用 DuckDB 执行</span></a></h2><p>对于 DuckDB 部分内置 UDF，pg_duckdb 在 PostgreSQL 中也注册了相应的 UDF。在 PostgreSQL 中识别到 SQL 中存在这些 UDF 时，相应的 SQL 会直接使用 DuckDB 来执行。这样在 PostgreSQL 中也可以直接使用 DuckDB 内置 UDF 提供的能力，比如直接从 S3 上读取 Parquet / CSV / JSON 文件，读取 Iceberg 等数据湖表格式等。</p><p>依旧回到 pg_duckdb 实现的 planner hook 中。对于 PostgreSQL 解析器输出的语法树，pg_duckdb 做了一次遍历来搜索语法树中是否存在需要直接使用 DuckDB 来执行的元素：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">bool</span></span>
<span class="line"><span class="token function">NeedsDuckdbExecution</span><span class="token punctuation">(</span>Query <span class="token operator">*</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">ContainsDuckdbItems</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Node <span class="token operator">*</span><span class="token punctuation">)</span>query<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">bool</span></span>
<span class="line"><span class="token function">ContainsDuckdbItems</span><span class="token punctuation">(</span>Node <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsA</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> FuncExpr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        FuncExpr <span class="token operator">*</span>func <span class="token operator">=</span> <span class="token function">castNode</span><span class="token punctuation">(</span>FuncExpr<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">IsDuckdbOnlyFunction</span><span class="token punctuation">(</span>func<span class="token operator">-&gt;</span>funcid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsA</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> Aggref<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        Aggref <span class="token operator">*</span>func <span class="token operator">=</span> <span class="token function">castNode</span><span class="token punctuation">(</span>Aggref<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">IsDuckdbOnlyFunction</span><span class="token punctuation">(</span>func<span class="token operator">-&gt;</span>aggfnoid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">PG_VERSION_NUM <span class="token operator">&gt;=</span> <span class="token number">160000</span></span></span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">expression_tree_walker</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ContainsDuckdbItems<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">expression_tree_walker</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ContainsDuckdbItems<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而所谓 DuckDB-only 的函数全部被放置在一个缓存中。缓存的构造方式也非常直接，目前使用了硬编码：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token comment">/*</span>
<span class="line"> * Returns true if the function with the given OID is a function that can only</span>
<span class="line"> * be executed by DuckDB.</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">bool</span></span>
<span class="line"><span class="token function">IsDuckdbOnlyFunction</span><span class="token punctuation">(</span>Oid function_oid<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Assert</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>valid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">foreach_oid</span><span class="token punctuation">(</span>duckdb_only_oid<span class="token punctuation">,</span> cache<span class="token punctuation">.</span>duckdb_only_functions<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>duckdb_only_oid <span class="token operator">==</span> function_oid<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">/*</span>
<span class="line"> * Builds the list of Postgres OIDs of functions that can only be executed by</span>
<span class="line"> * DuckDB. The resulting list is stored in cache.duckdb_only_functions.</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span></span>
<span class="line"><span class="token function">BuildDuckdbOnlyFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">/* This function should only be called during cache initialization */</span></span>
<span class="line">    <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">.</span>valid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token operator">!</span>cache<span class="token punctuation">.</span>duckdb_only_functions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">Assert</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>extension_oid <span class="token operator">!=</span> InvalidOid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/*</span>
<span class="line">     * We search the system cache for functions with these specific names. It&#39;s</span>
<span class="line">     * possible that other functions with the same also exist, so we check if</span>
<span class="line">     * each of the found functions is actually part of our extension before</span>
<span class="line">     * caching its OID as a DuckDB-only function.</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>function_names<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;read_parquet&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;read_csv&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;iceberg_scan&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;iceberg_metadata&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;iceberg_snapshots&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;delta_scan&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;read_json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;approx_count_distinct&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_exists&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_extract&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_extract_string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_array_length&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_contains&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_keys&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_structure&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_type&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_valid&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_group_array&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_group_object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_group_structure&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_transform&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;from_json&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_transform_strict&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;from_json_strict&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;json_value&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;strftime&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;strptime&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;epoch&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;epoch_ms&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;epoch_us&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;epoch_ns&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;make_timestamp&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;make_timestamptz&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;time_bucket&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;union_extract&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;union_tag&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;cardinality&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;element_at&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_concat&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_contains&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_contains_entry&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_contains_value&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_entries&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_extract&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_extract_value&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_from_entries&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_keys&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                                    <span class="token string">&quot;map_values&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">lengthof</span><span class="token punctuation">(</span>function_names<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        CatCList <span class="token operator">*</span>catlist <span class="token operator">=</span> <span class="token function">SearchSysCacheList1</span><span class="token punctuation">(</span>PROCNAMEARGSNSP<span class="token punctuation">,</span> <span class="token function">CStringGetDatum</span><span class="token punctuation">(</span>function_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> catlist<span class="token operator">-&gt;</span>n_members<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">/* ... */</span></span>
<span class="line">            cache<span class="token punctuation">.</span>duckdb_only_functions <span class="token operator">=</span> <span class="token function">lappend_oid</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>duckdb_only_functions<span class="token punctuation">,</span> function<span class="token operator">-&gt;</span>oid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">/* ... */</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">ReleaseSysCacheList</span><span class="token punctuation">(</span>catlist<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在识别到 SQL 中存在 DuckDB-only 的函数后，则 SQL 一定需要通过 DuckDB 来执行。之后的流程与前述类似，planner hook 将会创建 CustomScan 算子，并将 PostgreSQL 的语法树 deparse 为 DuckDB 的 SQL，并转移到 DuckDB 执行。</p><p>该特性使 PostgreSQL 借助 DuckDB UDF 具备了读取外部数据源的能力。甚至可以将外部数据源与 PostgreSQL 的表进行关联查询。</p><h2 id="创建并管理-duckdb-格式的表" tabindex="-1"><a class="header-anchor" href="#创建并管理-duckdb-格式的表"><span>创建并管理 DuckDB 格式的表</span></a></h2><p>如前所述，pg_duckdb 使 PostgreSQL 可以使用 DuckDB 的向量化执行引擎来访问 PostgreSQL 的表数据。但是 PostgreSQL 的表依旧是行式存储的，无法利用到列式存储所具有的高压缩、列裁剪等能力。有没有办法让 PostgreSQL 能够使用 DuckDB 的列式存储呢？</p><p>答案是肯定的。pg_duckdb 在 PostgreSQL 中以 <a href="https://www.postgresql.org/docs/current/tableam.html" target="_blank" rel="noopener noreferrer">Table AM</a> 的形式暴露了一个名为 <code>duckdb</code> 的 AM，用户可以在创建一张表时显式声明这张表的 AM 为 <code>duckdb</code>，使这张表被创建在 DuckDB 管理的存储中，而不是 PostgreSQL 管理的表文件里：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> duckdb<span class="token punctuation">.</span>_am_handler<span class="token punctuation">(</span>internal<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">RETURNS</span> table_am_handler</span>
<span class="line">    <span class="token keyword">SET</span> search_path <span class="token operator">=</span> pg_catalog<span class="token punctuation">,</span> pg_temp</span>
<span class="line">    <span class="token keyword">AS</span> <span class="token string">&#39;MODULE_PATHNAME&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;duckdb_am_handler&#39;</span></span>
<span class="line">    <span class="token keyword">LANGUAGE</span> C<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> ACCESS METHOD duckdb</span>
<span class="line">    <span class="token keyword">TYPE</span> <span class="token keyword">TABLE</span></span>
<span class="line">    <span class="token keyword">HANDLER</span> duckdb<span class="token punctuation">.</span>_am_handler<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line">Datum</span>
<span class="line"><span class="token function">duckdb_am_handler</span><span class="token punctuation">(</span>FunctionCallInfo <span class="token comment">/*funcinfo*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">PG_RETURN_POINTER</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>duckdb_methods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于这个 Table AM 的各个回调函数，pg_duckdb 实现得非常敷衍，基本上是能不支持就不支持，就算支持也直接返回空操作。这里的根本原因是，由于这个 AM 的表数据实际上由 DuckDB 管理，所以 PostgreSQL 本身不再有必要回调这些函数了。pg_duckdb 产生的 CustomScan 算子中会直接使用 DuckDB 完成执行，永远不会使用这些 PostgreSQL 的 Table AM 回调函数。</p><p>与前述处理方法类似，如果 PostgreSQL 接收到了一条操作 Table AM 为 <code>duckdb</code> 表的 SQL，同样会在 pg_duckdb 的 planner hook 中被判断和识别出来：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp" data-title="cpp"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">bool</span></span>
<span class="line"><span class="token function">ContainsDuckdbItems</span><span class="token punctuation">(</span>Node <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsA</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> Query<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        Query <span class="token operator">*</span>query <span class="token operator">=</span> <span class="token punctuation">(</span>Query <span class="token operator">*</span><span class="token punctuation">)</span>node<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ContainsDuckdbTables</span><span class="token punctuation">(</span>query<span class="token operator">-&gt;</span>rtable<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">PG_VERSION_NUM <span class="token operator">&gt;=</span> <span class="token number">160000</span></span></span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">query_tree_walker</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> ContainsDuckdbItems<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">query_tree_walker</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ContainsDuckdbItems<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">bool</span></span>
<span class="line"><span class="token function">ContainsDuckdbTables</span><span class="token punctuation">(</span>List <span class="token operator">*</span>rte_list<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">foreach_node</span><span class="token punctuation">(</span>RangeTblEntry<span class="token punctuation">,</span> rte<span class="token punctuation">,</span> rte_list<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsDuckdbTable</span><span class="token punctuation">(</span>rte<span class="token operator">-&gt;</span>relid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">bool</span></span>
<span class="line"><span class="token function">IsDuckdbTable</span><span class="token punctuation">(</span>Oid relid<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> pgduckdb<span class="token double-colon punctuation">::</span><span class="token function">DuckdbTableAmGetName</span><span class="token punctuation">(</span>relid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后对应的 PostgreSQL 语法树就会被 deparse 为 DuckDB 的 SQL，并在 CustomScan 算子中通过 DuckDB 来完成执行。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>pg_duckdb 通过 PostgreSQL 提供的一些较为灵活的可扩展性机制，将 DuckDB 这个强大的分析型数据库所具备的能力赋予了 PostgreSQL，极大增强了 PostgreSQL 的分析能力。此外，该插件也为 PostgreSQL 集成其它的计算工具提供了参考。</p>`,44)]))}const i=s(e,[["render",c],["__file","PostgreSQL Extension pg_duckdb.html.vue"]]),u=JSON.parse('{"path":"/notes/PostgreSQL/PostgreSQL%20Extension%20pg_duckdb.html","title":"PostgreSQL (Extension) - pg_duckdb","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"背景","slug":"背景","link":"#背景","children":[]},{"level":2,"title":"加速 PostgreSQL 的分析查询","slug":"加速-postgresql-的分析查询","link":"#加速-postgresql-的分析查询","children":[]},{"level":2,"title":"根据 UDF 直接使用 DuckDB 执行","slug":"根据-udf-直接使用-duckdb-执行","link":"#根据-udf-直接使用-duckdb-执行","children":[]},{"level":2,"title":"创建并管理 DuckDB 格式的表","slug":"创建并管理-duckdb-格式的表","link":"#创建并管理-duckdb-格式的表","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{},"filePathRelative":"notes/PostgreSQL/PostgreSQL Extension pg_duckdb.md"}');export{i as comp,u as data};
