import{_ as n,c as a,a as e,o as p}from"./app-BeHGwf2X.js";const t={};function l(c,s){return p(),a("div",null,s[0]||(s[0]=[e(`<h1 id="linux-performance-perf-report" tabindex="-1"><a class="header-anchor" href="#linux-performance-perf-report"><span>Linux Performance - Perf Report</span></a></h1><p>Created by: Mr Dk.</p><p>2023 / 09 / 20 23:19</p><p>Hangzhou, Zhejiang, China</p><hr><h2 id="background" tabindex="-1"><a class="header-anchor" href="#background"><span>Background</span></a></h2><p><code>perf record</code> 的输出默认会被写入到 <code>perf.data</code> 中。通过 <code>perf report</code> 命令可以从该采样文件中读取并产生简明的运行时热点情况，默认按开销从高到低排序。</p><h2 id="usage" tabindex="-1"><a class="header-anchor" href="#usage"><span>Usage</span></a></h2><h3 id="basic" tabindex="-1"><a class="header-anchor" href="#basic"><span>Basic</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ perf report</span>
<span class="line"></span>
<span class="line">Samples: 192K of event <span class="token string">&#39;cycles&#39;</span>, Event count <span class="token punctuation">(</span>approx.<span class="token punctuation">)</span>: <span class="token number">134062098663</span></span>
<span class="line">  Children      Self  Command   Shared Object         Symbol</span>
<span class="line">+   <span class="token number">99.15</span>%     <span class="token number">0.00</span>%  postgres  <span class="token punctuation">[</span>unknown<span class="token punctuation">]</span>             <span class="token punctuation">[</span>k<span class="token punctuation">]</span> 0x49564100642d3b3d</span>
<span class="line">+   <span class="token number">99.15</span>%     <span class="token number">0.00</span>%  postgres  libc-2.32.so          <span class="token punctuation">[</span>.<span class="token punctuation">]</span> __libc_start_main</span>
<span class="line">+   <span class="token number">99.15</span>%     <span class="token number">0.00</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> startup_hacks</span>
<span class="line">+   <span class="token number">99.15</span>%     <span class="token number">0.00</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> PostmasterMain</span>
<span class="line">+   <span class="token number">99.15</span>%     <span class="token number">0.00</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ServerLoop</span>
<span class="line">+   <span class="token number">99.15</span>%     <span class="token number">0.00</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> BackendStartup</span>
<span class="line">+   <span class="token number">99.15</span>%     <span class="token number">0.00</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ExitPostmaster</span>
<span class="line">+   <span class="token number">99.05</span>%     <span class="token number">0.08</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> PostgresMain</span>
<span class="line">+   <span class="token number">91.92</span>%     <span class="token number">0.14</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> exec_simple_query</span>
<span class="line">+   <span class="token number">29.00</span>%     <span class="token number">0.01</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> finish_xact_command</span>
<span class="line">+   <span class="token number">28.55</span>%     <span class="token number">0.05</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> PortalRun</span>
<span class="line">+   <span class="token number">26.79</span>%     <span class="token number">0.06</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> PortalRunMulti</span>
<span class="line">+   <span class="token number">26.13</span>%     <span class="token number">0.05</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ProcessQuery</span>
<span class="line">+   <span class="token number">25.37</span>%     <span class="token number">1.79</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> MemoryContextCheck</span>
<span class="line">+   <span class="token number">25.12</span>%    <span class="token number">15.12</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> AllocSetCheck</span>
<span class="line">+   <span class="token number">20.95</span>%     <span class="token number">0.01</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ExecutorRun</span>
<span class="line">+   <span class="token number">20.93</span>%     <span class="token number">0.02</span>%  postgres  pgaudit.so            <span class="token punctuation">[</span>.<span class="token punctuation">]</span> pgaudit_ExecutorRun_hook</span>
<span class="line">+   <span class="token number">20.92</span>%     <span class="token number">0.01</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> standard_ExecutorRun</span>
<span class="line">+   <span class="token number">20.88</span>%     <span class="token number">0.04</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> standard_ExecutorRun_NonPX</span>
<span class="line">+   <span class="token number">20.68</span>%     <span class="token number">0.03</span>%  postgres  polar_htap.so         <span class="token punctuation">[</span>.<span class="token punctuation">]</span> htap_ExecutePlan_hook</span>
<span class="line">+   <span class="token number">20.67</span>%     <span class="token number">0.04</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ExecutePlan</span>
<span class="line">+   <span class="token number">20.40</span>%     <span class="token number">0.02</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ExecProcNode</span>
<span class="line">+   <span class="token number">20.33</span>%     <span class="token number">0.02</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ExecProcNodeFirst</span>
<span class="line">+   <span class="token number">18.99</span>%     <span class="token number">0.07</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> ExecModifyTable</span>
<span class="line">+   <span class="token number">16.45</span>%     <span class="token number">0.04</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> pg_plan_queries</span>
<span class="line">+   <span class="token number">16.34</span>%     <span class="token number">0.02</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> pg_plan_query</span>
<span class="line">+   <span class="token number">16.32</span>%     <span class="token number">0.03</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> planner</span>
<span class="line">+   <span class="token number">16.27</span>%     <span class="token number">0.04</span>%  postgres  pg_hint_plan.so       <span class="token punctuation">[</span>.<span class="token punctuation">]</span> pg_hint_plan_planner</span>
<span class="line">+   <span class="token number">16.13</span>%     <span class="token number">0.03</span>%  postgres  polar_htap.so         <span class="token punctuation">[</span>.<span class="token punctuation">]</span> htap_planner_hook</span>
<span class="line">+   <span class="token number">16.02</span>%     <span class="token number">0.12</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> standard_planner</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，最右边一列中：</p><ul><li><code>.</code> 表示用户空间的符号</li><li><code>k</code> 表示内核级别的符号</li><li><code>g</code>/<code>u</code>/<code>H</code> 表示虚拟化环境中，虚拟机的内核级、用户级、虚拟机管理软件级别的符号</li></ul><h3 id="children" tabindex="-1"><a class="header-anchor" href="#children"><span>Children</span></a></h3><p>上述输出中，从上到下显示了被采样次数最多的函数，这里的采样次数是包括函数自身和函数所调用的子函数的。所以排名最靠前的函数实际上是入口函数。上述输出等价于加入了 <code>--children</code>。如果想看具体哪个函数在自身调用层级上消耗的时间较多，不包括子函数的开销，则需要指定 <code>--no-children</code> 参数：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ perf report --no-children</span>
<span class="line"></span>
<span class="line">Samples: 192K of event <span class="token string">&#39;cycles&#39;</span>, Event count <span class="token punctuation">(</span>approx.<span class="token punctuation">)</span>: <span class="token number">134062098663</span></span>
<span class="line">  Overhead  Command   Shared Object         Symbol</span>
<span class="line">+   <span class="token number">15.12</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> AllocSetCheck</span>
<span class="line">+    <span class="token number">9.97</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> sentinel_ok</span>
<span class="line">+    <span class="token number">2.30</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> AllocSetAlloc</span>
<span class="line">+    <span class="token number">2.07</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> base_yyparse</span>
<span class="line">+    <span class="token number">1.79</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> MemoryContextCheck</span>
<span class="line">+    <span class="token number">1.44</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> MemoryContextAllocZeroAligned</span>
<span class="line">+    <span class="token number">1.18</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> heap_hot_search_buffer</span>
<span class="line">+    <span class="token number">1.15</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> hash_bytes</span>
<span class="line">+    <span class="token number">1.03</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> hash_search_with_hash_value</span>
<span class="line">+    <span class="token number">0.91</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> POLAR_MEMORY_ACCOUNT_INC_ALLOCATED</span>
<span class="line">+    <span class="token number">0.89</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> expression_tree_walker</span>
<span class="line">+    <span class="token number">0.86</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> SearchCatCacheInternal</span>
<span class="line">+    <span class="token number">0.81</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> core_yylex</span>
<span class="line">+    <span class="token number">0.72</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> pg_checksum_block</span>
<span class="line">+    <span class="token number">0.70</span>%  postgres  libc-2.32.so          <span class="token punctuation">[</span>.<span class="token punctuation">]</span> __memset_evex_unaligned_erms</span>
<span class="line">+    <span class="token number">0.62</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> polar_lwlock_stat_acquire</span>
<span class="line">+    <span class="token number">0.54</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> palloc0</span>
<span class="line">+    <span class="token number">0.51</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> GetPrivateRefCountEntry</span>
<span class="line">     <span class="token number">0.48</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> palloc</span>
<span class="line">     <span class="token number">0.40</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> AllocSetFreeIndex</span>
<span class="line">     <span class="token number">0.40</span>%  postgres  libc-2.32.so          <span class="token punctuation">[</span>.<span class="token punctuation">]</span> __memmove_evex_unaligned_erms</span>
<span class="line">     <span class="token number">0.33</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> AllocSetFree</span>
<span class="line">     <span class="token number">0.32</span>%  postgres  postgres              <span class="token punctuation">[</span>.<span class="token punctuation">]</span> pg_atomic_compare_exchange_u32_impl</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面的结果中可以看出，热点位于 PostgreSQL 的 MemoryContext Check 中。这是 debug 模式下的性能问题根源。</p><h2 id="references" tabindex="-1"><a class="header-anchor" href="#references"><span>References</span></a></h2><p><a href="https://perf.wiki.kernel.org/index.php/Tutorial#Sample_analysis_with_perf_report" target="_blank" rel="noopener noreferrer">Kernel Wiki - Sample analysis with perf report</a></p><p><a href="https://man7.org/linux/man-pages/man1/perf-report.1.html" target="_blank" rel="noopener noreferrer">perf-report(1) — Linux manual page</a></p>`,19)]))}const i=n(t,[["render",l],["__file","Linux Perf Report.html.vue"]]),r=JSON.parse('{"path":"/notes/Performance/Linux%20Perf%20Report.html","title":"Linux Performance - Perf Report","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Background","slug":"background","link":"#background","children":[]},{"level":2,"title":"Usage","slug":"usage","link":"#usage","children":[{"level":3,"title":"Basic","slug":"basic","link":"#basic","children":[]},{"level":3,"title":"Children","slug":"children","link":"#children","children":[]}]},{"level":2,"title":"References","slug":"references","link":"#references","children":[]}],"git":{},"filePathRelative":"notes/Performance/Linux Perf Report.md"}');export{i as comp,r as data};
