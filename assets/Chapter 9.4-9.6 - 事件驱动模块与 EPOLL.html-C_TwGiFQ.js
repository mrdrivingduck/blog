import{_ as s,c as a,a as p,o as e}from"./app-BeHGwf2X.js";const t={};function l(c,n){return e(),a("div",null,n[0]||(n[0]=[p(`<h1 id="chapter-9-4-9-6-äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸-epoll" tabindex="-1"><a class="header-anchor" href="#chapter-9-4-9-6-äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸-epoll"><span>Chapter 9.4-9.6 - äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸ EPOLL</span></a></h1><p>Created by : Mr Dk.</p><p>2020 / 07 / 24 10:44</p><p>Nanjing, Jiangsu, China</p><hr><h2 id="_9-4-äº‹ä»¶æ ¸å¿ƒæ¨¡å—" tabindex="-1"><a class="header-anchor" href="#_9-4-äº‹ä»¶æ ¸å¿ƒæ¨¡å—"><span>9.4 äº‹ä»¶æ ¸å¿ƒæ¨¡å—</span></a></h2><p><code>ngx_events_module</code> æ˜¯ä¸€ä¸ª <strong>æ ¸å¿ƒæ¨¡å—</strong>ã€‚å…¶ä¸­ï¼Œå®šä¹‰äº†æ–°çš„ <strong>äº‹ä»¶æ¨¡å—</strong>ï¼Œä»¥åŠæ‰€æœ‰äº‹ä»¶æ¨¡å—éƒ½è¦å®ç°çš„ <code>ngx_event_module_t</code> é€šç”¨æ¥å£ã€‚å›é¡¾æ ¸å¿ƒæ¨¡å—çš„æ¥å£å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">ngx_module_s</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>            ctx_index<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>            index<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">char</span>                 <span class="token operator">*</span>name<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>            spare0<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>            spare1<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>            version<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token keyword">char</span>           <span class="token operator">*</span>signature<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">void</span>                 <span class="token operator">*</span>ctx<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_command_t</span>        <span class="token operator">*</span>commands<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>            type<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ngx_int_t</span>           <span class="token punctuation">(</span><span class="token operator">*</span>init_master<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">ngx_log_t</span> <span class="token operator">*</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ngx_int_t</span>           <span class="token punctuation">(</span><span class="token operator">*</span>init_module<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ngx_int_t</span>           <span class="token punctuation">(</span><span class="token operator">*</span>init_process<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_int_t</span>           <span class="token punctuation">(</span><span class="token operator">*</span>init_thread<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">void</span>                <span class="token punctuation">(</span><span class="token operator">*</span>exit_thread<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">void</span>                <span class="token punctuation">(</span><span class="token operator">*</span>exit_process<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">void</span>                <span class="token punctuation">(</span><span class="token operator">*</span>exit_master<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook0<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook1<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook2<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook3<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook4<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook5<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook6<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span>             spare_hook7<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºäº†å®šä¹‰ä¸€ä¸ªæ–°çš„æ ¸å¿ƒæ¨¡å—ï¼Œè¦æ»¡è¶³ä¸‰ä¸ªè¦ç´ ï¼š</p><ul><li>æ¨¡å—ç±»å‹ <code>type</code></li><li>æ¨¡å—æ„Ÿå…´è¶£çš„é…ç½®é¡¹ <code>commands</code></li><li>å®ç°æ ¸å¿ƒæ¨¡å—çš„é€šç”¨æ¥å£ <code>ngx_core_module_t</code> äº <code>ctx</code> æŒ‡é’ˆä¸­</li></ul><p>é‚£ä¹ˆï¼Œ<code>ngx_events_module</code> æ ¸å¿ƒæ¨¡å—æ„Ÿå…´è¶£çš„é…ç½®é¡¹æœ‰å“ªäº›å‘¢ï¼Ÿå¦‚ä¸‹æ‰€ç¤ºï¼Œè¯¥æ¨¡å—åªå¯¹ <code>events{...}</code> é…ç½®é¡¹æ„Ÿå…´è¶£ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_command_t</span> ngx_events_commandsp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        NGX_MAIN_CONF <span class="token operator">|</span> NGX_CONF_BLOCK <span class="token operator">|</span> NGX_CONF_NOARGS<span class="token punctuation">,</span></span>
<span class="line">        ngx_events_block<span class="token punctuation">,</span> <span class="token comment">// è§£æé…ç½®é¡¹çš„å›è°ƒ</span></span>
<span class="line">        <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token constant">NULL</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    ngx_null_command</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½œä¸ºæ ¸å¿ƒæ¨¡å—ï¼Œ<code>ngx_events_module</code> éœ€è¦å®ç°æ ¸å¿ƒæ¨¡å—çš„é€šç”¨æ¥å£ã€‚å…¶ä¸­åªæ˜¯å®šä¹‰äº†æ¨¡å—åç§°ï¼Œå¹¶æ²¡æœ‰å®ç° <code>create_conf()</code> å’Œ <code>init_conf()</code> - å› ä¸ºè¿™ä¸ªæ¨¡å—ä¸è§£æå…·ä½“çš„é…ç½®é¡¹å‚æ•°ï¼Œç”±å„ä¸ªäº‹ä»¶æ¨¡å—å®ç°è¿™ä¸¤ä¸ªå‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_core_module_t</span> ngx_events_module_ctx <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">NULL</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€ç»ˆï¼Œ<code>ngx_events_module</code> æ ¸å¿ƒæ¨¡å—çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token class-name">ngx_module_t</span> ngx_events_module <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    NGX_MODULE_V1<span class="token punctuation">,</span></span>
<span class="line">    <span class="token operator">&amp;</span>ngx_events_module_ctx<span class="token punctuation">,</span> <span class="token comment">// æ ¸å¿ƒæ¨¡å—é€šç”¨æ¥å£</span></span>
<span class="line">    ngx_events_commands<span class="token punctuation">,</span> <span class="token comment">// æ¨¡å—æ„Ÿå…´è¶£çš„é…ç½®é¡¹</span></span>
<span class="line">    NGX_CORE_MODULE<span class="token punctuation">,</span> <span class="token comment">// æ¨¡å—ç±»å‹</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// init master</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// init module</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// init process</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// init thread</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// exit thread</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// exit process</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// exit master</span></span>
<span class="line">    NGX_MODULE_V1_PADDING</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-4-1-ç®¡ç†æ‰€æœ‰äº‹ä»¶æ¨¡å—çš„é…ç½®é¡¹" tabindex="-1"><a class="header-anchor" href="#_9-4-1-ç®¡ç†æ‰€æœ‰äº‹ä»¶æ¨¡å—çš„é…ç½®é¡¹"><span>9.4.1 ç®¡ç†æ‰€æœ‰äº‹ä»¶æ¨¡å—çš„é…ç½®é¡¹</span></a></h3><p>æ¯ä¸ªäº‹ä»¶æ¨¡å—éƒ½å¿…é¡»å®ç° <code>ngx_event_module_t</code> é€šç”¨æ¥å£ï¼Œå…¶ä¸­çš„ <code>create_conf()</code> å‡½æ•°å…è®¸æ¯ä¸ªäº‹ä»¶æ¨¡å—è‡ªå·±åˆ†é…å†…å­˜å»ºç«‹è‡ªå·±çš„é…ç½®é¡¹ç»“æ„ä½“ã€‚ä½†å„ä¸ªæ¨¡å—çš„é…ç½®é¡¹ç»“æ„ä½“çš„å†…å­˜æŒ‡é’ˆå¦‚ä½•ç”± <code>ngx_events_module</code> æ¨¡å—ç®¡ç†å‘¢ï¼Ÿæ¯ä¸€ä¸ªäº‹ä»¶æ¨¡å—çš„é…ç½®ç»“æ„ä½“éƒ½ä¼šè¢«å­˜æ”¾åˆ° <code>ngx_events_module</code> æ¨¡å—çš„æŒ‡é’ˆæ•°ç»„ä¸­ã€‚è¿™ä¸ªæŒ‡é’ˆæ•°ç»„åˆä¼šè¢«å­˜æ”¾åˆ° <code>ngx_cycle_t</code> æ ¸å¿ƒç»“æ„ä½“çš„çš„ <code>conf_ctx</code> æˆå‘˜ä¸­ï¼š(å››çº§æŒ‡é’ˆå“¦ ğŸ˜ª)</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>conf_ctx<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ <code>ngx_cycle_t</code> æ ¸å¿ƒç»“æ„ä½“ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—ä¸‹å±çš„æ¯ä¸€ä¸ªæ‰©å±•æ¨¡å—ä¸­çš„æ¯ä¸€ä¸ªé…ç½®é¡¹ã€‚æ¯ä¸ªäº‹ä»¶æ¨¡å—é€šè¿‡å¦‚ä¸‹çš„å®å°±å¯ä»¥ä» <code>conf_ctx</code> ä¸­è·å¾—å½“å‰æ¨¡å—å»ºç«‹çš„é…ç½®é¡¹ç»“æ„ä½“ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ngx_event_get_conf</span><span class="token expression"><span class="token punctuation">(</span>conf_ctx<span class="token punctuation">,</span> module<span class="token punctuation">)</span> </span><span class="token punctuation">\\</span></span>
<span class="line">    <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">ngx_get_conf</span><span class="token punctuation">(</span>conf_ctx<span class="token punctuation">,</span> ngx_events_module<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>module<span class="token punctuation">.</span>ctx_index<span class="token punctuation">]</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ngx_get_conf</span><span class="token expression"><span class="token punctuation">(</span>conf_ctx<span class="token punctuation">,</span> module<span class="token punctuation">)</span> conf_ctx<span class="token punctuation">[</span>module<span class="token punctuation">.</span>index<span class="token punctuation">]</span></span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-4-2-ç®¡ç†äº‹ä»¶æ¨¡å—" tabindex="-1"><a class="header-anchor" href="#_9-4-2-ç®¡ç†äº‹ä»¶æ¨¡å—"><span>9.4.2 ç®¡ç†äº‹ä»¶æ¨¡å—</span></a></h3><p>æ‰€æœ‰é…ç½®é¡¹çš„ä¿å­˜éƒ½åœ¨ <code>ngx_events_block()</code> å‡½æ•°ä¸­è¿›è¡Œã€‚é¦–å…ˆä¼šåˆå§‹åŒ–æ¯ä¸ªäº‹ä»¶æ¨¡å—çš„ <code>ctx_index</code> æˆå‘˜ã€‚è¿™é‡Œæ³¨æ„æ¯ä¸ªæ¨¡å—çš„ <code>index</code> æŒ‡çš„æ˜¯è¯¥æ¨¡å—åœ¨æ‰€æœ‰æ¨¡å—ä¸­çš„åºå·ï¼Œè€Œ <code>ctx_index</code> æ˜¯æŒ‡è¯¥æ¨¡å—åœ¨åŒç±»å‹æ¨¡å—ä¸­çš„åºå·ã€‚</p><p>æ‰€æœ‰æ¨¡å—ç¼–å·ç¡®å®šï¼Œä¸ªæ•°ä¹Ÿå°±ç¡®å®šäº†ï¼Œé‚£ä¹ˆåˆ†é…é…ç½®é¡¹æŒ‡é’ˆæ•°ç»„ã€‚ç„¶åå¯¹æ¯ä¸€ä¸ªäº‹ä»¶æ¨¡å—ï¼Œä¾æ¬¡è°ƒç”¨äº‹ä»¶æ¨¡å—é€šç”¨æ¥å£ä¸­çš„ <code>create_conf()</code> å‡½æ•°ï¼Œäº§ç”Ÿçš„ç»“æ„ä½“æŒ‡é’ˆä¿å­˜åœ¨ä¸Šè¿°æŒ‡é’ˆæ•°ç»„ä¸­ã€‚é…ç½®é¡¹è§£æå®Œæ¯•åï¼Œä¾æ¬¡è°ƒç”¨æ¯ä¸€ä¸ªäº‹ä»¶æ¨¡å—çš„ <code>init_conf()</code> å‡½æ•°ã€‚</p><hr><h2 id="_9-5-æ ¸å¿ƒäº‹ä»¶æ¨¡å—" tabindex="-1"><a class="header-anchor" href="#_9-5-æ ¸å¿ƒäº‹ä»¶æ¨¡å—"><span>9.5 æ ¸å¿ƒäº‹ä»¶æ¨¡å—</span></a></h2><blockquote><p><code>ngx_events_module</code> - äº‹ä»¶æ ¸å¿ƒæ¨¡å— - æ˜¯ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œä½†å®šä¹‰äº†äº‹ä»¶æ¨¡å—çš„ä¿¡æ¯</p><p><code>ngx_event_core_module</code> - æ ¸å¿ƒäº‹ä»¶æ¨¡å— - æ˜¯ä¸€ä¸ªäº‹ä»¶æ¨¡å—ï¼Œä½†æ˜¯æ˜¯æœ€æ ¸å¿ƒçš„äº‹ä»¶æ¨¡å—</p></blockquote><p><code>ngx_event_core_module</code> æ˜¯æ‰€æœ‰äº‹ä»¶æ¨¡å—ä¸­æ’ç¬¬ä¸€ä½çš„æ¨¡å—ã€‚å®ƒè´Ÿè´£åˆ›å»ºè¿æ¥æ± ï¼Œå¹¶å†³å®šä½¿ç”¨å“ªç§äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œå¹¶åˆå§‹åŒ–ç›¸åº”çš„äº‹ä»¶é©±åŠ¨æœºåˆ¶æ¨¡å—ã€‚è¯¥æ¨¡å—å¯¹ä»¥ä¸‹é…ç½®é¡¹æ„Ÿå…´è¶£ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_command_t</span>  ngx_event_core_commands<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// è¿æ¥æ± å¤§å° (æ¯ä¸ª worker è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°)</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;worker_connections&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_TAKE1<span class="token punctuation">,</span></span>
<span class="line">      ngx_event_connections<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// é€‰æ‹©å“ªä¸€ä¸ªäº‹ä»¶é©±åŠ¨æ¨¡å—</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;use&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_TAKE1<span class="token punctuation">,</span></span>
<span class="line">      ngx_event_use<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å°½å¯èƒ½å¤šåœ°æ¥æ”¶è¿æ¥</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;multi_accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_FLAG<span class="token punctuation">,</span></span>
<span class="line">      ngx_conf_set_flag_slot<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token class-name">ngx_event_conf_t</span><span class="token punctuation">,</span> multi_accept<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ˜¯å¦å¯ç”¨è´Ÿè½½å‡è¡¡é”</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;accept_mutex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_FLAG<span class="token punctuation">,</span></span>
<span class="line">      ngx_conf_set_flag_slot<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token class-name">ngx_event_conf_t</span><span class="token punctuation">,</span> accept_mutex<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å¯ç”¨è´Ÿè½½å‡è¡¡é”åï¼Œåœ¨è¯•å›¾å¤„ç†æ–°è¿æ¥ä¹‹å‰ï¼Œå»¶è¿Ÿçš„æ¯«ç§’æ•°</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;accept_mutex_delay&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_TAKE1<span class="token punctuation">,</span></span>
<span class="line">      ngx_conf_set_msec_slot<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token class-name">ngx_event_conf_t</span><span class="token punctuation">,</span> accept_mutex_delay<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å¯¹æŒ‡å®š IP çš„ TCP è¿æ¥æ‰“å° debug çº§åˆ«çš„è°ƒè¯•æ—¥å¿—</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;debug_connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_TAKE1<span class="token punctuation">,</span></span>
<span class="line">      ngx_event_debug_connection<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">      ngx_null_command</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¯¥æ¨¡å—ä¸­ï¼Œå®šä¹‰äº†å­˜å‚¨ä¸Šè¿°æ‰€æœ‰é…ç½®çš„ç»“æ„ä½“ (ä¸¤è€…å¯¹åº”)ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>    connections<span class="token punctuation">;</span> <span class="token comment">// è¿æ¥æ± å¤§å°</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>    use<span class="token punctuation">;</span> <span class="token comment">// é€‰ç”¨çš„äº‹ä»¶é©±åŠ¨æ¨¡å—åœ¨æ‰€æœ‰äº‹ä»¶æ¨¡å—ä¸­çš„åºå·</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ngx_flag_t</span>    multi_accept<span class="token punctuation">;</span> <span class="token comment">// æ ‡å¿—ä½ï¼Œæ˜¯å¦å°½å¯èƒ½å¤šåœ°å»ºç«‹è¿æ¥</span></span>
<span class="line">    <span class="token class-name">ngx_flag_t</span>    accept_mutex<span class="token punctuation">;</span> <span class="token comment">// æ ‡å¿—ä½ï¼Œæ˜¯å¦å¯åŠ¨è´Ÿè½½å‡è¡¡é”</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">ngx_msec_t</span>    accept_mutex_delay<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    u_char       <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">// ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å—çš„åç§°</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_DEBUG<span class="token punctuation">)</span></span></span></span>
<span class="line">    <span class="token class-name">ngx_array_t</span>   debug_connection<span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token class-name">ngx_event_conf_t</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½œä¸ºä¸€ä¸ª <strong>äº‹ä»¶æ¨¡å—</strong>ï¼Œ<code>ngx_event_core_module</code> ä¹Ÿè¦å®ç°äº‹ä»¶æ¨¡å—çš„é€šç”¨æ¥å£ <code>ngx_event_module_t</code>ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_str_t</span>  event_core_name <span class="token operator">=</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;event_core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_event_module_t</span>  ngx_event_core_module_ctx <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token operator">&amp;</span>event_core_name<span class="token punctuation">,</span> <span class="token comment">// &quot;event_core&quot;</span></span>
<span class="line">    ngx_event_core_create_conf<span class="token punctuation">,</span>            <span class="token comment">/* create configuration */</span></span>
<span class="line">    ngx_event_core_init_conf<span class="token punctuation">,</span>              <span class="token comment">/* init configuration */</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å¹¶ä¸å®ç° ngx_event_actions_tï¼Œå› ä¸ºè¿™ä¸ªæ¨¡å—ä¸çœŸæ­£è´Ÿè´£ç½‘ç»œäº‹ä»¶é©±åŠ¨</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åå°†è¿™ä¸ªäº‹ä»¶æ¨¡å—æ¥å£ä¸Šä¸‹æ–‡å¹¶å…¥æ•´ä½“æ¨¡å—ä¿¡æ¯ä¸­ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token class-name">ngx_module_t</span>  ngx_event_core_module <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    NGX_MODULE_V1<span class="token punctuation">,</span></span>
<span class="line">    <span class="token operator">&amp;</span>ngx_event_core_module_ctx<span class="token punctuation">,</span>            <span class="token comment">/* module context */</span> <span class="token comment">// äº‹ä»¶æ¨¡å—é€šç”¨æ¥å£</span></span>
<span class="line">    ngx_event_core_commands<span class="token punctuation">,</span>               <span class="token comment">/* module directives */</span> <span class="token comment">// è¯¥æ¨¡å—æ„Ÿå…´è¶£çš„é…ç½®é¡¹</span></span>
<span class="line">    NGX_EVENT_MODULE<span class="token punctuation">,</span>                      <span class="token comment">/* module type */</span> <span class="token comment">// æ¨¡å—ç±»å‹ä¸ºäº‹ä»¶æ¨¡å—</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                  <span class="token comment">/* init master */</span></span>
<span class="line">    ngx_event_module_init<span class="token punctuation">,</span>                 <span class="token comment">/* init module */</span></span>
<span class="line">    ngx_event_process_init<span class="token punctuation">,</span>                <span class="token comment">/* init process */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                  <span class="token comment">/* init thread */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                  <span class="token comment">/* exit thread */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                  <span class="token comment">/* exit process */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                  <span class="token comment">/* exit master */</span></span>
<span class="line">    NGX_MODULE_V1_PADDING</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Nginx å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œè¿˜æ²¡æœ‰ <code>fork()</code> å‡º worker å­è¿›ç¨‹æ—¶ï¼Œè°ƒç”¨ <code>ngx_event_module_init()</code> è¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼›åœ¨ worker å­è¿›ç¨‹ç”Ÿæˆåï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½ä¼šè°ƒç”¨ <code>ngx_event_process_init()</code> å‡½æ•°åè¿›å…¥å·¥ä½œå¾ªç¯ã€‚<code>ngx_event_process_init()</code> å‡½æ•°å¹²äº†å¾ˆå¤šäº‹æƒ…ï¼š</p><ol><li>ç¡®è®¤ Nginx ä½¿ç”¨äº† master æ¨¡å¼ï¼Œä¸” worker è¿›ç¨‹æ•°é‡å¤§äº 1ï¼Œæ‰“å¼€è´Ÿè½½å‡è¡¡é”</li><li>å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™å…³é—­è´Ÿè½½å‡è¡¡é” (æ ‡å¿—ä½)</li><li>åˆå§‹åŒ–çº¢é»‘æ ‘å®ç°çš„å®šæ—¶å™¨</li><li>åœ¨æŒ‡å®šä½¿ç”¨çš„äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸­ï¼Œè°ƒç”¨äº‹ä»¶æ¨¡å—é€šç”¨æ¥å£ä¸­çš„ <code>init()</code> è¿›è¡Œè¿™ä¸ªæ¨¡å—çš„åˆå§‹åŒ–</li><li>è®¾ç½®æ›´æ–°ç³»ç»Ÿäº‹ä»¶çš„å›è°ƒ</li><li>å¦‚æœä½¿ç”¨ EPOLLï¼Œåˆ™é¢„åˆ†é…å¥æŸ„</li><li>é¢„åˆ†é… <code>ngx_conntection_t</code> æ•°ç»„ä½œä¸ºè¿æ¥æ± </li><li>é¢„åˆ†é… <code>ngx_event_t</code> æ•°ç»„ä½œä¸ºè¯»äº‹ä»¶æ± </li><li>é¢„åˆ†é… <code>ngx_event_t</code> æ•°ç»„ä½œä¸ºå†™äº‹ä»¶æ± </li><li>å°†è¯»å†™äº‹ä»¶è®¾ç½®åˆ°å¯¹åº”çš„è¿æ¥æ± ä¸­</li><li>è®¾ç½® <code>ngx_cycle_t</code> ä¸­çš„ç©ºé—²è¿æ¥é“¾è¡¨</li><li>ä¸ºæ‰€æœ‰ <code>ngx_listening_t</code> å¯¹è±¡ä¸­çš„ <code>connection</code> æˆå‘˜åˆ†é…è¿æ¥ï¼Œè®¾ç½®è¯»äº‹ä»¶å¤„ç†å‡½æ•°ä¸º <code>ngx_event_accept()</code></li><li>å°†æ‰€æœ‰ <code>ngx_listening_t</code> å¯¹è±¡çš„è¯»äº‹ä»¶æ·»åŠ åˆ°äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸­ (æ¯”å¦‚åŠ å…¥ EPOLL æ–‡ä»¶ç³»ç»Ÿ)</li></ol><hr><h2 id="_9-6-epoll-äº‹ä»¶é©±åŠ¨æ¨¡å—" tabindex="-1"><a class="header-anchor" href="#_9-6-epoll-äº‹ä»¶é©±åŠ¨æ¨¡å—"><span>9.6 EPOLL äº‹ä»¶é©±åŠ¨æ¨¡å—</span></a></h2><h3 id="_9-6-1-epoll-çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#_9-6-1-epoll-çš„åŸç†"><span>9.6.1 EPOLL çš„åŸç†</span></a></h3><p>EPOLL é€‚ç”¨çš„å…¸å‹åœºæ™¯ï¼šå¤§é‡ç”¨æˆ· (1M) ä¸ä¸€ä¸ªè¿›ç¨‹ä¿æŒç€ TCP è¿æ¥ï¼Œæ¯ä¸ªæ—¶åˆ»åªæœ‰å‡ ç™¾ä¸ª TCP è¿æ¥æ˜¯æ´»è·ƒçš„ (å¯ä»¥ä¸é˜»å¡è¯»å–æ•°æ®)ã€‚é‚£ä¹ˆè¿›ç¨‹è¦å°†è¿™ 1M ä¸ªè¿æ¥å‘Šè¯‰ OSï¼Œç”± OS è´Ÿè´£æŸ¥è¯¢å“ªäº›è¿æ¥æ˜¯æ´»è·ƒçš„ã€‚åœ¨ Linux kernel 2.4 ä¹‹å‰ï¼ŒSELECT å’Œ POLL ä¸¤ä¸ªäº‹ä»¶é©±åŠ¨æ–¹å¼éƒ½æ˜¯è¿™ä¹ˆåšçš„ã€‚</p><p>ç”±äºè¿™ 1M ä¸ªè¿æ¥å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸æ´»è·ƒçš„ï¼Œå› æ­¤æ¯æ¬¡å°† 1M ä¸ªè¿æ¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¼ é€’ç»™ OS éå¸¸ä½æ•ˆï¼EPOLL åœ¨å†…æ ¸ä¸­ç”³è¯·äº†ä¸€ä¸ªç®€æ˜“çš„æ–‡ä»¶ç³»ç»Ÿã€‚æ¯æ¬¡åªéœ€åˆ›å»ºä¸€ä¸ª EPOLL å¯¹è±¡ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åå‘æ–‡ä»¶ç³»ç»Ÿä¸­æ·»åŠ æˆ–åˆ é™¤è¿æ¥å³å¯ã€‚EPOLL çš„æ•ˆç‡éå¸¸é«˜ï¼Œå› ä¸ºï¼š</p><ul><li>è°ƒç”¨ EPOLL æ—¶ä¸å†éœ€è¦ä¼ é€’ 1M ä¸ªè¿æ¥</li><li>å†…æ ¸ä¹Ÿä¸éœ€è¦å…¨é‡éå†æ‰€æœ‰è¿æ¥æ¥æ‰¾å‡ºå…¶ä¸­çš„æ´»è·ƒè¿æ¥</li></ul><p>è¿›ç¨‹è°ƒç”¨ <code>epoll_create()</code> å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºä¸€ä¸ª <code>eventpoll</code> ç»“æ„ä½“ã€‚å…¶ä¸­ä¸¤ä¸ªæ•°æ®ç»“æ„éå¸¸é‡è¦ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">rb_root</span> rbr<span class="token punctuation">;</span> <span class="token comment">// çº¢é»‘æ ‘æ ¹ç»“ç‚¹ï¼Œçº¢é»‘æ ‘ä¸­ä¿å­˜äº†æ‰€æœ‰ç›‘æ§çš„äº‹ä»¶</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> rdllist<span class="token punctuation">;</span> <span class="token comment">// å°†è¦è¿”å›ç»™ç”¨æˆ·çš„ (æ»¡è¶³æ¡ä»¶çš„) äº‹ä»¶</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªç»“æ„ä½“å¼€è¾Ÿäºå†…æ ¸ä¸­ï¼Œå½“ç”¨æˆ·ä½¿ç”¨ <code>epoll_ctl()</code> å‡½æ•°å‘è¯¥ç»“æ„ä½“ä¸­æ·»åŠ äº‹ä»¶æ—¶ï¼Œéƒ½ä¼šè¢«åŠ å…¥åˆ°ç»“æ„ä½“çš„çº¢é»‘æ ‘ä¸­ã€‚å› æ­¤å¢åˆ æ”¹çš„æ•ˆç‡å¾ˆé«˜ï¼Œé‡å¤æ·»åŠ çš„äº‹ä»¶ä¹Ÿèƒ½è¢«å¿«é€Ÿè¯†åˆ«ã€‚æ‰€æœ‰æ·»åŠ çš„äº‹ä»¶éƒ½ä¼šä¸ <strong>è®¾å¤‡é©±åŠ¨ç¨‹åº</strong> (å¦‚ç½‘å¡é©±åŠ¨ç¨‹åº) å»ºç«‹å›è°ƒå…³ç³»ï¼Œåœ¨ç›¸åº”äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘å›è°ƒã€‚åœ¨å›è°ƒä¸­ï¼Œä¼šæŠŠç›¸åº”äº‹ä»¶æ”¾åˆ° <code>rdllist</code> é“¾è¡¨ä¸­ã€‚åœ¨ç”¨æˆ·è°ƒç”¨ <code>epoll_wait()</code> æŸ¥è¯¢äº‹ä»¶æ—¶ï¼Œåªéœ€è¦æ£€æŸ¥ <code>rdllist</code> é“¾è¡¨ä¸Šæ˜¯å¦å­˜åœ¨äº‹ä»¶ï¼Œå¹¶å°†é“¾è¡¨ä¸Šçš„äº‹ä»¶å¤åˆ¶åˆ°ç”¨æˆ·æ€å†…å­˜ä¸­ã€‚EPOLL å¯ä»¥è½»æ˜“å¤„ç†ç™¾ä¸‡çº§åˆ«çš„å¹¶å‘è¿æ¥ã€‚</p><h3 id="_9-6-3-ngx-epoll-module-æ¨¡å—çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#_9-6-3-ngx-epoll-module-æ¨¡å—çš„å®ç°"><span>9.6.3 <code>ngx_epoll_module</code> æ¨¡å—çš„å®ç°</span></a></h3><p>EPOLL æ¨¡å—æ„Ÿå…´è¶£çš„é…ç½®é¡¹ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_command_t</span>  ngx_epoll_commands<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;epoll_events&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// epoll_wait() æ—¶æœ€å¤šå¯ä»¥è¿”å›çš„äº‹ä»¶æ•°</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_TAKE1<span class="token punctuation">,</span></span>
<span class="line">      ngx_conf_set_num_slot<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token class-name">ngx_epoll_conf_t</span><span class="token punctuation">,</span> events<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;worker_aio_requests&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// åˆå§‹åŒ–åˆ†é…çš„å¼‚æ­¥ I/O äº‹ä»¶ä¸ªæ•°</span></span>
<span class="line">      NGX_EVENT_CONF<span class="token operator">|</span>NGX_CONF_TAKE1<span class="token punctuation">,</span></span>
<span class="line">      ngx_conf_set_num_slot<span class="token punctuation">,</span></span>
<span class="line">      <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token class-name">ngx_epoll_conf_t</span><span class="token punctuation">,</span> aio_requests<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">      ngx_null_command</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¨¡å—ä¸­å¯¹åº”çš„å­˜å‚¨é…ç½®é¡¹çš„ç»“æ„ä½“ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>  events<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>  aio_requests<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token class-name">ngx_epoll_conf_t</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½œä¸ºä¸€ä¸ªäº‹ä»¶æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—è‡ªç„¶éœ€è¦å®ç°äº‹ä»¶æ¨¡å—çš„é€šç”¨æ¥å£ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_str_t</span>      epoll_name <span class="token operator">=</span> <span class="token function">ngx_string</span><span class="token punctuation">(</span><span class="token string">&quot;epoll&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_event_module_t</span>  ngx_epoll_module_ctx <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token operator">&amp;</span>epoll_name<span class="token punctuation">,</span></span>
<span class="line">    ngx_epoll_create_conf<span class="token punctuation">,</span>               <span class="token comment">/* create configuration */</span></span>
<span class="line">    ngx_epoll_init_conf<span class="token punctuation">,</span>                 <span class="token comment">/* init configuration */</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        ngx_epoll_add_event<span class="token punctuation">,</span>             <span class="token comment">/* add an event */</span></span>
<span class="line">        ngx_epoll_del_event<span class="token punctuation">,</span>             <span class="token comment">/* delete an event */</span></span>
<span class="line">        ngx_epoll_add_event<span class="token punctuation">,</span>             <span class="token comment">/* enable an event */</span></span>
<span class="line">        ngx_epoll_del_event<span class="token punctuation">,</span>             <span class="token comment">/* disable an event */</span></span>
<span class="line">        ngx_epoll_add_connection<span class="token punctuation">,</span>        <span class="token comment">/* add an connection */</span></span>
<span class="line">        ngx_epoll_del_connection<span class="token punctuation">,</span>        <span class="token comment">/* delete an connection */</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_HAVE_EVENTFD<span class="token punctuation">)</span></span></span></span>
<span class="line">        ngx_epoll_notify<span class="token punctuation">,</span>                <span class="token comment">/* trigger a notify */</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></span>
<span class="line">        <span class="token constant">NULL</span><span class="token punctuation">,</span>                            <span class="token comment">/* trigger a notify */</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line">        ngx_epoll_process_events<span class="token punctuation">,</span>        <span class="token comment">/* process the events */</span></span>
<span class="line">        ngx_epoll_init<span class="token punctuation">,</span>                  <span class="token comment">/* init the events */</span></span>
<span class="line">        ngx_epoll_done<span class="token punctuation">,</span>                  <span class="token comment">/* done the events */</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­ï¼Œ<code>ngx_epoll_create_conf()</code> å’Œ <code>ngx_epoll_init_conf()</code> ä»…ä¸ºäº†è§£æé…ç½®é¡¹ã€‚<code>ngx_epoll_init()</code> å‡½æ•°ä¸»è¦ä¼šåšä¸¤ä»¶äº‹ï¼š</p><ol><li>è°ƒç”¨ <code>epoll_create()</code> åˆ›å»ºåœ¨å†…æ ¸ä¸­åˆ›å»º EPOLL ç»“æ„ä½“</li><li>åˆ›å»º <code>event_list</code> æ•°ç»„ï¼Œç”¨äº <code>epoll_wait()</code> æ—¶å­˜æ”¾å°±ç»ªçš„äº‹ä»¶</li></ol><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_int_t</span></span>
<span class="line"><span class="token function">ngx_epoll_init</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">,</span> <span class="token class-name">ngx_msec_t</span> timer<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ngx_epoll_conf_t</span>  <span class="token operator">*</span>epcf<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å–å¾—å·²ç»è§£æå®Œæ¯•çš„é…ç½®é¡¹</span></span>
<span class="line">    epcf <span class="token operator">=</span> <span class="token function">ngx_event_get_conf</span><span class="token punctuation">(</span>cycle<span class="token operator">-&gt;</span>conf_ctx<span class="token punctuation">,</span> ngx_epoll_module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ep <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è°ƒç”¨ epoll_create()</span></span>
<span class="line">        ep <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span>cycle<span class="token operator">-&gt;</span>connection_n <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ep <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">ngx_log_error</span><span class="token punctuation">(</span>NGX_LOG_EMERG<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> ngx_errno<span class="token punctuation">,</span></span>
<span class="line">                          <span class="token string">&quot;epoll_create() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> NGX_ERROR<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_HAVE_EVENTFD<span class="token punctuation">)</span></span></span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ngx_epoll_notify_init</span><span class="token punctuation">(</span>cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">)</span> <span class="token operator">!=</span> NGX_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ngx_epoll_module_ctx<span class="token punctuation">.</span>actions<span class="token punctuation">.</span>notify <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_HAVE_FILE_AIO<span class="token punctuation">)</span></span></span></span>
<span class="line">        <span class="token function">ngx_epoll_aio_init</span><span class="token punctuation">(</span>cycle<span class="token punctuation">,</span> epcf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_HAVE_EPOLLRDHUP<span class="token punctuation">)</span></span></span></span>
<span class="line">        <span class="token function">ngx_epoll_test_rdhup</span><span class="token punctuation">(</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>nevents <span class="token operator">&lt;</span> epcf<span class="token operator">-&gt;</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>event_list<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">ngx_free</span><span class="token punctuation">(</span>event_list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// æ ¹æ®é…ç½®é¡¹ä¸­çš„æœ€å¤§è¿”å›äº‹ä»¶æ•°ï¼Œåˆ†é… event_list æ•°ç»„</span></span>
<span class="line">        event_list <span class="token operator">=</span> <span class="token function">ngx_alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token punctuation">)</span> <span class="token operator">*</span> epcf<span class="token operator">-&gt;</span>events<span class="token punctuation">,</span></span>
<span class="line">                               cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>event_list <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> NGX_ERROR<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    nevents <span class="token operator">=</span> epcf<span class="token operator">-&gt;</span>events<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    ngx_io <span class="token operator">=</span> ngx_os_io<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    ngx_event_actions <span class="token operator">=</span> ngx_epoll_module_ctx<span class="token punctuation">.</span>actions<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_HAVE_CLEAR_EVENT<span class="token punctuation">)</span></span></span></span>
<span class="line">    ngx_event_flags <span class="token operator">=</span> NGX_USE_CLEAR_EVENT</span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></span>
<span class="line">    ngx_event_flags <span class="token operator">=</span> NGX_USE_LEVEL_EVENT</span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line">                      <span class="token operator">|</span>NGX_USE_GREEDY_EVENT</span>
<span class="line">                      <span class="token operator">|</span>NGX_USE_EPOLL_EVENT<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> NGX_OK<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»é€šç”¨æ¥å£çš„è§’åº¦æ¥çœ‹ï¼ŒEPOLL ä¸å­˜åœ¨ enable ä¸€ä¸ªäº‹ä»¶æˆ– disable ä¸€ä¸ªäº‹ä»¶ã€‚å› æ­¤ enable å’Œ add æ¥å£éƒ½æ˜¯ç”± <code>ngx_epoll_add_event()</code> å®ç°çš„ï¼Œdisable å’Œ del æ¥å£éƒ½æ˜¯ç”± <code>ngx_epoll_del_event()</code> å®ç°çš„ã€‚è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«ç”¨äºå‘å†…æ ¸ä¸­æ³¨å†Œæˆ–è§£é™¤æ³¨å†Œäº‹ä»¶ã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_int_t</span></span>
<span class="line"><span class="token function">ngx_epoll_add_event</span><span class="token punctuation">(</span><span class="token class-name">ngx_event_t</span> <span class="token operator">*</span>ev<span class="token punctuation">,</span> <span class="token class-name">ngx_int_t</span> event<span class="token punctuation">,</span> <span class="token class-name">ngx_uint_t</span> flags<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span>                  op<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint32_t</span>             events<span class="token punctuation">,</span> prev<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_event_t</span>         <span class="token operator">*</span>e<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_connection_t</span>    <span class="token operator">*</span>c<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span>   ee<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    c <span class="token operator">=</span> ev<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> event<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> NGX_READ_EVENT<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        e <span class="token operator">=</span> c<span class="token operator">-&gt;</span>write<span class="token punctuation">;</span></span>
<span class="line">        prev <span class="token operator">=</span> EPOLLOUT<span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_READ_EVENT <span class="token operator">!=</span> EPOLLIN<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">)</span></span></span></span>
<span class="line">        events <span class="token operator">=</span> EPOLLIN<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span> <span class="token comment">// è¯»äº‹ä»¶çš„è§¦å‘æ ‡å¿—</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        e <span class="token operator">=</span> c<span class="token operator">-&gt;</span>read<span class="token punctuation">;</span></span>
<span class="line">        prev <span class="token operator">=</span> EPOLLIN<span class="token operator">|</span>EPOLLRDHUP<span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_WRITE_EVENT <span class="token operator">!=</span> EPOLLOUT<span class="token punctuation">)</span></span></span></span>
<span class="line">        events <span class="token operator">=</span> EPOLLOUT<span class="token punctuation">;</span> <span class="token comment">// å†™äº‹ä»¶çš„è§¦å‘æ ‡å¿—</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// ç¡®å®šåˆ°åº•æ˜¯æ·»åŠ äº‹ä»¶è¿˜æ˜¯ä¿®æ”¹äº‹ä»¶</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        op <span class="token operator">=</span> EPOLL_CTL_MOD<span class="token punctuation">;</span></span>
<span class="line">        events <span class="token operator">|=</span> prev<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        op <span class="token operator">=</span> EPOLL_CTL_ADD<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_HAVE_EPOLLEXCLUSIVE <span class="token operator">&amp;&amp;</span> NGX_HAVE_EPOLLRDHUP<span class="token punctuation">)</span></span></span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> NGX_EXCLUSIVE_EVENT<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        events <span class="token operator">&amp;=</span> <span class="token operator">~</span>EPOLLRDHUP<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">    ee<span class="token punctuation">.</span>events <span class="token operator">=</span> events <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> flags<span class="token punctuation">;</span></span>
<span class="line">    ee<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> c <span class="token operator">|</span> ev<span class="token operator">-&gt;</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">ngx_log_debug3</span><span class="token punctuation">(</span>NGX_LOG_DEBUG_EVENT<span class="token punctuation">,</span> ev<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                   <span class="token string">&quot;epoll add event: fd:%d op:%d ev:%08XD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                   c<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> op<span class="token punctuation">,</span> ee<span class="token punctuation">.</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// è°ƒç”¨ epoll_ctl å‘å†…æ ¸ä¸­æ·»åŠ äº‹ä»¶æˆ–ä¿®æ”¹äº‹ä»¶</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> op<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ee<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">ngx_log_error</span><span class="token punctuation">(</span>NGX_LOG_ALERT<span class="token punctuation">,</span> ev<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> ngx_errno<span class="token punctuation">,</span></span>
<span class="line">                      <span class="token string">&quot;epoll_ctl(%d, %d) failed&quot;</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> NGX_ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å½“å‰äº‹ä»¶æ´»è·ƒ</span></span>
<span class="line">    ev<span class="token operator">-&gt;</span>active <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span></span>
<span class="line">    ev<span class="token operator">-&gt;</span>oneshot <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> NGX_ONESHOT_EVENT<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> NGX_OK<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦å¤–ï¼Œ<code>ngx_epoll_add_connection()</code> å’Œ <code>ngx_epoll_del_connection()</code> ä¹Ÿä¸ä¸Šè¿°å‡½æ•°ç±»ä¼¼ã€‚ä¸Šè¿°å‡½æ•°åªæ˜¯å•ç‹¬æ·»åŠ æŸä¸ªè¿æ¥çš„è¯»æˆ–å†™äº‹ä»¶ï¼Œè€Œ <code>ngx_epoll_add_connection()</code> æ˜¯æ·»åŠ æ•´ä¸ªè¿æ¥ (å³åŒæ—¶æ·»åŠ è¯»å’Œå†™äº‹ä»¶)ï¼Œå…·ä½“å®ç°æ–¹å¼ç±»ä¼¼ã€‚</p><p><code>ngx_epoll_process_events()</code> å‡½æ•°å®ç°äº†æ”¶é›†ã€åˆ†å‘äº‹ä»¶çš„æ¥å£ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token class-name">ngx_int_t</span></span>
<span class="line"><span class="token function">ngx_epoll_process_events</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">,</span> <span class="token class-name">ngx_msec_t</span> timer<span class="token punctuation">,</span> <span class="token class-name">ngx_uint_t</span> flags<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span>                events<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uint32_t</span>           revents<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_int_t</span>          instance<span class="token punctuation">,</span> i<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_uint_t</span>         level<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_err_t</span>          err<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_event_t</span>       <span class="token operator">*</span>rev<span class="token punctuation">,</span> <span class="token operator">*</span>wev<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_queue_t</span>       <span class="token operator">*</span>queue<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ngx_connection_t</span>  <span class="token operator">*</span>c<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">/* NGX_TIMER_INFINITE == INFTIM */</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">ngx_log_debug1</span><span class="token punctuation">(</span>NGX_LOG_DEBUG_EVENT<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                   <span class="token string">&quot;epoll timer: %M&quot;</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// è°ƒç”¨ epoll_wait() ä»å†…æ ¸ä¸­æ”¶é›†å°±ç»ªäº‹ä»¶</span></span>
<span class="line">    events <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> event_list<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> nevents<span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    err <span class="token operator">=</span> <span class="token punctuation">(</span>events <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> ngx_errno <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ›´æ–°æ—¶é—´</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> NGX_UPDATE_TIME <span class="token operator">||</span> ngx_event_timer_alarm<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">ngx_time_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NGX_EINTR<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>ngx_event_timer_alarm<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                ngx_event_timer_alarm <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">return</span> NGX_OK<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            level <span class="token operator">=</span> NGX_LOG_INFO<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            level <span class="token operator">=</span> NGX_LOG_ALERT<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">ngx_log_error</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token string">&quot;epoll_wait() failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> NGX_ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// æ²¡æœ‰å°±ç»ªäº‹ä»¶</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>events <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">!=</span> NGX_TIMER_INFINITE<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> NGX_OK<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">ngx_log_error</span><span class="token punctuation">(</span>NGX_LOG_ALERT<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                      <span class="token string">&quot;epoll_wait() returned no events without timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> NGX_ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å¼€å§‹éå†å†…æ ¸è¿”å›çš„æ‰€æœ‰äº‹ä»¶</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> events<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        c <span class="token operator">=</span> event_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> c <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ngx_connection_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> c <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// è¯»äº‹ä»¶</span></span>
<span class="line">        rev <span class="token operator">=</span> c<span class="token operator">-&gt;</span>read<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// è¯»äº‹ä»¶æ˜¯å¦è¿‡æœŸ</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> rev<span class="token operator">-&gt;</span>instance <span class="token operator">!=</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">/*</span>
<span class="line">             * the stale event from a file descriptor</span>
<span class="line">             * that was just closed in this iteration</span>
<span class="line">             */</span></span>
<span class="line"></span>
<span class="line">            <span class="token function">ngx_log_debug1</span><span class="token punctuation">(</span>NGX_LOG_DEBUG_EVENT<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                           <span class="token string">&quot;epoll: stale event %p&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// è·å¾—äº‹ä»¶ç±»å‹</span></span>
<span class="line">        revents <span class="token operator">=</span> event_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">ngx_log_debug3</span><span class="token punctuation">(</span>NGX_LOG_DEBUG_EVENT<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                       <span class="token string">&quot;epoll: fd:%d ev:%04XD d:%p&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                       c<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> revents<span class="token punctuation">,</span> event_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>revents <span class="token operator">&amp;</span> <span class="token punctuation">(</span>EPOLLERR<span class="token operator">|</span>EPOLLHUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">ngx_log_debug2</span><span class="token punctuation">(</span>NGX_LOG_DEBUG_EVENT<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                           <span class="token string">&quot;epoll_wait() error on fd:%d ev:%04XD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                           c<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> revents<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">/*</span>
<span class="line">             * if the error events were returned, add EPOLLIN and EPOLLOUT</span>
<span class="line">             * to handle the events at least in one active handler</span>
<span class="line">             */</span></span>
<span class="line"></span>
<span class="line">            revents <span class="token operator">|=</span> EPOLLIN<span class="token operator">|</span>EPOLLOUT<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>revents <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>EPOLLIN<span class="token operator">|</span>EPOLLOUT<span class="token operator">|</span>EPOLLERR<span class="token operator">|</span>EPOLLHUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">ngx_log_error</span><span class="token punctuation">(</span>NGX_LOG_ALERT<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                          <span class="token string">&quot;strange epoll_wait() events fd:%d ev:%04XD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                          c<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> revents<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// äº‹ä»¶æ˜¯è¯»äº‹ä»¶ï¼Œè€Œä¸”æ´»è·ƒ</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>revents <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rev<span class="token operator">-&gt;</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_HAVE_EPOLLRDHUP<span class="token punctuation">)</span></span></span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>revents <span class="token operator">&amp;</span> EPOLLRDHUP<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                rev<span class="token operator">-&gt;</span>pending_eof <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">            rev<span class="token operator">-&gt;</span>ready <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">            rev<span class="token operator">-&gt;</span>available <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> NGX_POST_EVENTS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// å»¶åå¤„ç†äº‹ä»¶</span></span>
<span class="line">                queue <span class="token operator">=</span> rev<span class="token operator">-&gt;</span>accept <span class="token operator">?</span> <span class="token operator">&amp;</span>ngx_posted_accept_events</span>
<span class="line">                                    <span class="token operator">:</span> <span class="token operator">&amp;</span>ngx_posted_events<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token function">ngx_post_event</span><span class="token punctuation">(</span>rev<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// ç«‹åˆ»è°ƒç”¨è¯»äº‹ä»¶çš„å›è°ƒå‡½æ•°å¤„ç†äº‹ä»¶</span></span>
<span class="line">                rev<span class="token operator">-&gt;</span><span class="token function">handler</span><span class="token punctuation">(</span>rev<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// å†™äº‹ä»¶</span></span>
<span class="line">        wev <span class="token operator">=</span> c<span class="token operator">-&gt;</span>write<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>revents <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> wev<span class="token operator">-&gt;</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// å†™äº‹ä»¶è¿‡æœŸ</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> wev<span class="token operator">-&gt;</span>instance <span class="token operator">!=</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">/*</span>
<span class="line">                 * the stale event from a file descriptor</span>
<span class="line">                 * that was just closed in this iteration</span>
<span class="line">                 */</span></span>
<span class="line"></span>
<span class="line">                <span class="token function">ngx_log_debug1</span><span class="token punctuation">(</span>NGX_LOG_DEBUG_EVENT<span class="token punctuation">,</span> cycle<span class="token operator">-&gt;</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">                               <span class="token string">&quot;epoll: stale event %p&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            wev<span class="token operator">-&gt;</span>ready <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NGX_THREADS<span class="token punctuation">)</span></span></span></span>
<span class="line">            wev<span class="token operator">-&gt;</span>complete <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> NGX_POST_EVENTS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// å»¶åå¤„ç†å†™äº‹ä»¶</span></span>
<span class="line">                <span class="token function">ngx_post_event</span><span class="token punctuation">(</span>wev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ngx_posted_events<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// è°ƒç”¨å†™äº‹ä»¶çš„å›è°ƒå‡½æ•°å¤„ç†äº‹ä»¶</span></span>
<span class="line">                wev<span class="token operator">-&gt;</span><span class="token function">handler</span><span class="token punctuation">(</span>wev<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> NGX_OK<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°å‡½æ•°å‘å†…æ ¸æ”¶é›†äº†å½“å‰å·²å°±ç»ªçš„æ‰€æœ‰äº‹ä»¶ï¼Œå¯¹äºä¸éœ€è¦å»¶åå¤„ç†çš„äº‹ä»¶ï¼Œç«‹åˆ»è°ƒç”¨å…¶å›è°ƒå‡½æ•°ã€‚è¿™é‡Œç›¸å½“äºå®ç°äº† <strong>äº‹ä»¶åˆ†å‘</strong> çš„å·¥ä½œã€‚å› æ­¤æ¯ä¸€ä¸ªå›è°ƒå‡½æ•°ä¸èƒ½å¯¼è‡´è¿›ç¨‹ä¼‘çœ æˆ–å ç”¨å¤ªå¤šäº‹ä»¶ï¼Œå¦åˆ™å°†ä¸èƒ½åŠæ—¶å¤„ç†å…¶å®ƒäº‹ä»¶ã€‚</p><p>ä»€ä¹ˆæ˜¯è¿‡æœŸäº‹ä»¶ï¼Ÿæ¯”å¦‚åœ¨å¤„ç†ç¬¬ä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œç”±äºåšäº†ä¸€äº›æ“ä½œå¯¼è‡´ç¬¬ä¸‰ä¸ªäº‹ä»¶æ— æ•ˆäº†ã€‚ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦é€šè¿‡ <code>instance</code> æ ‡å¿—ä½æ¥æ ‡è®°æ˜¯å¦è¿‡æœŸã€‚å½“è¿æ¥æ¯æ¬¡ä»è¿æ¥æ± ä¸­å–å‡ºæ—¶ï¼Œ<code>instance</code> æ ‡å¿—ä½å°†ä¼šè¢«å–åã€‚</p><p><code>ngx_epoll_done()</code> å‡½æ•°åœ¨ Nginx é€€å‡ºæœåŠ¡æ—¶ä¼šè¢«è°ƒç”¨ã€‚ä¸»è¦å·¥ä½œï¼š</p><ol><li>å…³é—­ EPOLL æè¿°ç¬¦ (å›æ”¶å†…æ ¸ä¸­çš„ EPOLL å†…å­˜)</li><li>é‡Šæ”¾ <code>event_list</code> æ•°ç»„</li></ol><p>ä»¥ä¸Šï¼Œæ˜¯ <code>ngx_epoll_module</code> æ¨¡å—çš„äº‹ä»¶æ¨¡å—ä¸Šä¸‹æ–‡ä¸­çš„æ‰€æœ‰çš„å‡½æ•°å®ç°ã€‚ç”±æ­¤ï¼Œæ•´ä¸ªæ¨¡å—çš„å®šä¹‰å°±æ˜¾è€Œæ˜“è§äº†ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token class-name">ngx_module_t</span>  ngx_epoll_module <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    NGX_MODULE_V1<span class="token punctuation">,</span></span>
<span class="line">    <span class="token operator">&amp;</span>ngx_epoll_module_ctx<span class="token punctuation">,</span>               <span class="token comment">/* module context */</span></span>
<span class="line">    ngx_epoll_commands<span class="token punctuation">,</span>                  <span class="token comment">/* module directives */</span></span>
<span class="line">    NGX_EVENT_MODULE<span class="token punctuation">,</span>                    <span class="token comment">/* module type */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                <span class="token comment">/* init master */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                <span class="token comment">/* init module */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                <span class="token comment">/* init process */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                <span class="token comment">/* init thread */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                <span class="token comment">/* exit thread */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                <span class="token comment">/* exit process */</span></span>
<span class="line">    <span class="token constant">NULL</span><span class="token punctuation">,</span>                                <span class="token comment">/* exit master */</span></span>
<span class="line">    NGX_MODULE_V1_PADDING</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,67)]))}const o=s(t,[["render",l],["__file","Chapter 9.4-9.6 - äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸ EPOLL.html.vue"]]),u=JSON.parse('{"path":"/understanding-nginx-notes/Part%203%20-%20%E6%B7%B1%E5%85%A5%20Nginx/Chapter%209.4-9.6%20-%20%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97%E4%B8%8E%20EPOLL.html","title":"Chapter 9.4-9.6 - äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸ EPOLL","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"9.4 äº‹ä»¶æ ¸å¿ƒæ¨¡å—","slug":"_9-4-äº‹ä»¶æ ¸å¿ƒæ¨¡å—","link":"#_9-4-äº‹ä»¶æ ¸å¿ƒæ¨¡å—","children":[{"level":3,"title":"9.4.1 ç®¡ç†æ‰€æœ‰äº‹ä»¶æ¨¡å—çš„é…ç½®é¡¹","slug":"_9-4-1-ç®¡ç†æ‰€æœ‰äº‹ä»¶æ¨¡å—çš„é…ç½®é¡¹","link":"#_9-4-1-ç®¡ç†æ‰€æœ‰äº‹ä»¶æ¨¡å—çš„é…ç½®é¡¹","children":[]},{"level":3,"title":"9.4.2 ç®¡ç†äº‹ä»¶æ¨¡å—","slug":"_9-4-2-ç®¡ç†äº‹ä»¶æ¨¡å—","link":"#_9-4-2-ç®¡ç†äº‹ä»¶æ¨¡å—","children":[]}]},{"level":2,"title":"9.5 æ ¸å¿ƒäº‹ä»¶æ¨¡å—","slug":"_9-5-æ ¸å¿ƒäº‹ä»¶æ¨¡å—","link":"#_9-5-æ ¸å¿ƒäº‹ä»¶æ¨¡å—","children":[]},{"level":2,"title":"9.6 EPOLL äº‹ä»¶é©±åŠ¨æ¨¡å—","slug":"_9-6-epoll-äº‹ä»¶é©±åŠ¨æ¨¡å—","link":"#_9-6-epoll-äº‹ä»¶é©±åŠ¨æ¨¡å—","children":[{"level":3,"title":"9.6.1 EPOLL çš„åŸç†","slug":"_9-6-1-epoll-çš„åŸç†","link":"#_9-6-1-epoll-çš„åŸç†","children":[]},{"level":3,"title":"9.6.3 ngx_epoll_module æ¨¡å—çš„å®ç°","slug":"_9-6-3-ngx-epoll-module-æ¨¡å—çš„å®ç°","link":"#_9-6-3-ngx-epoll-module-æ¨¡å—çš„å®ç°","children":[]}]}],"git":{},"filePathRelative":"understanding-nginx-notes/Part 3 - æ·±å…¥ Nginx/Chapter 9.4-9.6 - äº‹ä»¶é©±åŠ¨æ¨¡å—ä¸ EPOLL.md"}');export{o as comp,u as data};
