import{_ as n,c as a,a as e,o as p}from"./app-BeHGwf2X.js";const t={};function o(c,s){return p(),a("div",null,s[0]||(s[0]=[e(`<h1 id="chapter-4-å­—å…¸" tabindex="-1"><a class="header-anchor" href="#chapter-4-å­—å…¸"><span>Chapter 4 - å­—å…¸</span></a></h1><p>Created by : Mr Dk.</p><p>2020 / 06 / 01 15:47</p><p>Nanjing, Jiangsu, China</p><hr><p>å­—å…¸æ˜¯ç”¨äºä¿å­˜ key-value pair çš„æŠ½è±¡æ•°æ®ç»“æ„ï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ª key éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚ç”±äº C å†…ç½®æ²¡æœ‰è¿™æ ·çš„æ•°æ®ç»“æ„ï¼ŒRedis é€šè¿‡å®ç°ä¸€ä¸ª hash è¡¨æ¥ä½œä¸ºå­—å…¸çš„åº•å±‚å®ç°ã€‚</p><h2 id="definition" tabindex="-1"><a class="header-anchor" href="#definition"><span>Definition</span></a></h2><p>é¦–å…ˆæ˜¯ hash è¡¨çš„å®šä¹‰ï¼Œè¡¨ç»“æ„æœ¬èº«çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictht</span> <span class="token punctuation">{</span></span>
<span class="line">    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span> <span class="token comment">// Hash è¡¨æ•°ç»„</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span> <span class="token comment">// è¡¨å¤§å° (2^n)</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span> <span class="token comment">// è¡¨å¤§å°æ©ç  == size - 1</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span> <span class="token comment">// å·²æœ‰ç»“ç‚¹çš„æ•°é‡</span></span>
<span class="line"><span class="token punctuation">}</span> dictht<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¡¨ç»“ç‚¹çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">union</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">uint64_t</span> u64<span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">int64_t</span> s64<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> v<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    sturct dictEntry <span class="token operator">*</span>next<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œçš„å®ç°ä¸ JDK 8 ä¸­çš„ HashMap å®ç°ç±»ä¼¼ã€‚<code>struct dictht</code> ä¸­ï¼Œé€šè¿‡ <code>table</code> æŒ‡é’ˆå¼€è¾Ÿä¸€ä¸ªä¸€ç»´çš„æ•°ç»„ã€‚æ¯ä¸ªå…ƒç´ é€šè¿‡ <code>sizemask</code> æ˜ å°„åˆ°ä¸€ç»´æ•°ç»„çš„ç›¸åº”ä½ç½®ã€‚å¦‚æœè¯¥ä½ç½®å·²ç»å­˜åœ¨å…ƒç´ ï¼Œè¯´æ˜å‡ºç°äº† hash å†²çªï¼Œå†²çªç»“ç‚¹é€šè¿‡ <code>next</code> æŒ‡é’ˆçš„é“¾åœ°å€æ³•å¤„ç†å†²çªã€‚</p><p>å¦å¤–ï¼Œç”±äºå†²çªé“¾è¡¨æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæ²¡æœ‰è¡¨å°¾æŒ‡é’ˆï¼Œå› æ­¤æ–°åŠ å…¥çš„å†²çªç»“ç‚¹æ€»æ˜¯æ’å…¥åˆ°é“¾è¡¨çš„è¡¨å¤´ä½ç½®ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</p><p>æœ€ä¸Šå±‚çš„å­—å…¸å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dict</span> <span class="token punctuation">{</span></span>
<span class="line">    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// å“ˆå¸Œè¡¨</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">int</span> trehashidx<span class="token punctuation">;</span> <span class="token comment">// rehash ç´¢å¼•</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”¨é€”ä¸åŒçš„å­—å…¸ä¼šæœ‰ä¸åŒç±»å‹çš„å‡½æ•°ï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">typedef</span> sturct dictType <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è®¡ç®— hash çš„å‡½æ•°</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>hashFunction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å¤åˆ¶ key çš„å‡½æ•°</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>keyDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å¤åˆ¶ value çš„å‡½æ•°</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>valDup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å¯¹æ¯” key çš„å‡½æ•°</span></span>
<span class="line">    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyCompare<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// é”€æ¯ key çš„å‡½æ•°</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>keyDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// é”€æ¯ value çš„å‡½æ•°</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>valDestructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> dictType<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="hash-calculation" tabindex="-1"><a class="header-anchor" href="#hash-calculation"><span>Hash Calculation</span></a></h2><p>å…³äº hash å€¼çš„è®¡ç®—æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚é€šè¿‡å®šä¹‰å¥½çš„ hash å‡½æ•°å¯¹ key è¿ç®—ï¼Œå°†å¾—åˆ°çš„ç»“æœä¸ mask ä½œä¸è¿ç®—ï¼Œå°±èƒ½å¾—åˆ°åœ¨ hash table ä¸­çš„ indexã€‚</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line">hash <span class="token operator">=</span> dict<span class="token operator">-&gt;</span>type<span class="token operator">-&gt;</span><span class="token function">hashFunction</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">index <span class="token operator">=</span> hash <span class="token operator">&amp;</span> dict<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="rehash" tabindex="-1"><a class="header-anchor" href="#rehash"><span>Rehash</span></a></h2><p>ä¸ JDK HashMap ç±»ä¼¼ï¼Œæœ€å¤æ‚çš„æ“ä½œåº”è¯¥å°±æ˜¯ hash table çš„æ‰©å®¹äº†ã€‚å½“ hash table çš„ load factor è¶…å‡ºäº†ä¸€å®šé˜ˆå€¼ï¼Œå°±è¦å¯¹è¡¨è¿›è¡Œæ‰©å®¹ï¼Œç„¶åå¯¹åŸæœ‰çš„ç»“ç‚¹é‡æ–°è®¡ç®— hashï¼Œæ˜ å°„åˆ°æ–°çš„ä½ç½®ä¸Šã€‚åœ¨å­—å…¸çš„ <code>dict</code> ç»“æ„ä½“çš„å®šä¹‰ä¸­ï¼Œä¸ºä»€ä¹ˆè¦å®šä¹‰ä¸¤ä¸ª hash table <code>ht[2]</code> å‘¢ï¼Ÿ</p><p>åœ¨å¹³æ—¶ï¼Œhash table åªä½¿ç”¨ <code>ht[0]</code>ï¼›å½“ rehash æ—¶ï¼Œhash table ä½¿ç”¨ <code>ht[1]</code> åˆ†é…å†…å­˜ã€‚åˆ†é…å†…å­˜æ—¶æœ‰ä¸¤ç§æƒ…å†µï¼Œä½†éœ€è¦ä¿è¯åˆ†é…çš„å†…å­˜å¯¹åº”çš„ç»“ç‚¹æ•°ä¸º <strong>2 çš„æ•´æ•°æ¬¡å¹‚</strong>ï¼š</p><ul><li>æ‰©å®¹</li><li>æ”¶ç¼©</li></ul><p>å†…å­˜åˆ†é…å®Œæ¯•åï¼Œå°† <code>ht[0]</code> ä¸Šçš„ç‚¹ <strong>é€æ­¥è¿ç§»</strong> åˆ° <code>ht[1]</code> ä¸­ï¼Œç›´åˆ° <code>ht[0]</code> ç§°ä¸ºä¸€ä¸ªç©ºè¡¨ã€‚å°† <code>ht[1]</code> èµ‹å€¼ç»™ <code>ht[0]</code>ï¼Œä½¿ <code>ht[1]</code> ä¸ºä¸‹ä¸€æ¬¡ rehash åšå‡†å¤‡ã€‚</p><h2 id="trigger-condition-of-rehash" tabindex="-1"><a class="header-anchor" href="#trigger-condition-of-rehash"><span>Trigger Condition of Rehash</span></a></h2><p>Rehash åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹æ‰ä¼šè§¦å‘å‘¢ï¼ŸRedis ä¸­å®šä¹‰äº†ä¸€ä¸ªè´Ÿè½½å› å­çš„æ¦‚å¿µï¼š</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line">load_factor <span class="token operator">=</span> ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">/</span> ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹è§¦å‘ rehash å‘¢ï¼Ÿ</p><ol><li>æ‰©å®¹ - åœ¨ <code>BGSAVE</code> æˆ– <code>BGREWRITEAOF</code> å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼Œè´Ÿè½½å› å­è¶…è¿‡ 5</li><li>æ‰©å®¹ - å¦åˆ™ï¼Œè´Ÿè½½å› å­è¶…è¿‡ 1</li><li>æ”¶ç¼© - è´Ÿè½½å› å­å°äº 0.1</li></ol><blockquote><p>ä¸ºä»€ä¹ˆåœ¨ <code>BGSAVE</code> å’Œ <code>BGREWRITEAOF</code> å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼Œrehash çš„è§¦å‘æ¡ä»¶æ›´åŠ è‹›åˆ»å‘¢ï¼Ÿ</p><p>åœ¨è¿™ä¸¤ä¸ªå‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼ŒRedis ä¼šåˆ›å»ºå­è¿›ç¨‹ï¼Œè€Œå¤§éƒ¨åˆ† OS ä½¿ç”¨ copy-on-write æœºåˆ¶æ¥ä¼˜åŒ–å­è¿›ç¨‹ã€‚åœ¨è¿™æœŸé—´ï¼Œå¦‚æœè¿›è¡Œ rehashï¼Œé‚£ä¹ˆå°†å¸¦æ¥é¡µé¢å†™æ“ä½œï¼ŒOS ä¸å¾—ä¸ä¸ºå†™é¡µé¢çš„è¿›ç¨‹é‡æ–°åˆ†é…å†…å­˜ã€‚å› æ­¤ï¼Œå°†è´Ÿè½½å› å­é˜ˆå€¼è°ƒé«˜ä¸€äº›ï¼Œä½¿ rehash è¾ƒéš¾å‘ç”Ÿã€‚</p></blockquote><h2 id="gradual-rehash" tabindex="-1"><a class="header-anchor" href="#gradual-rehash"><span>Gradual Rehash</span></a></h2><p>Rehash æœŸé—´ï¼Œä» <code>ht[0]</code> åˆ° <code>ht[1]</code> çš„è¿ç§»ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ï¼Œå¦åˆ™å¯èƒ½ä¼šå› ä¸ºä¸€æ¬¡æ€§è¿ç§»é‡å¤ªå¤šï¼Œè€Œä½¿æœåŠ¡å™¨åœæ­¢æœåŠ¡ã€‚</p><p>Redis é€šè¿‡ <code>rehashidx</code> æ ‡å¿—å­—å…¸çš„ rehash çŠ¶æ€ã€‚åœ¨ rehash è¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸è¿›è¡Œå¢åˆ æ”¹æŸ¥æ—¶ï¼Œé¦–å…ˆåˆ° <code>ht[0]</code> ä¸ŠæŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†æ‰¾ <code>ht[1]</code>ã€‚åœ¨å®Œæˆç›¸åº”æ“ä½œçš„åŒæ—¶ï¼Œé¡ºä¾¿å°† <code>ht[0]</code> ä¸Šçš„ç»“ç‚¹è¿ç§»åˆ° <code>ht[1]</code> ä¸Š (ä½†æ˜¯æ–°æ’å…¥ç»“ç‚¹å°±åªä¼šåœ¨ <code>ht[1]</code> ä¸Š)ã€‚ç›´åˆ° <code>ht[0]</code> æˆä¸ºç©ºè¡¨ã€‚</p><p>è¿™ç§æ–¹æ³•ï¼Œé¿å…äº†é›†ä¸­å¼ rehash å¸¦æ¥çš„åºå¤§è®¡ç®—é‡ï¼Œå°†è¿ç§»æˆæœ¬å‡æ‘Šåˆ°äº†æ¯æ¬¡å¯¹å­—å…¸è¿›è¡Œå¢åˆ æ”¹æŸ¥ä¸Šã€‚666666 ğŸ‘</p><hr><p>ä¸ JDK ä¸­çš„ HashMap å¯ä»¥è¯´æ˜¯å„æœ‰åƒç§‹å§ï¼ŒæŒºæœ‰è¶£çš„ã€‚</p>`,37)]))}const i=n(t,[["render",o],["__file","Chapter 4 - å­—å…¸.html.vue"]]),d=JSON.parse('{"path":"/redis-implementation-notes/Part%201%20-%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1/Chapter%204%20-%20%E5%AD%97%E5%85%B8.html","title":"Chapter 4 - å­—å…¸","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Definition","slug":"definition","link":"#definition","children":[]},{"level":2,"title":"Hash Calculation","slug":"hash-calculation","link":"#hash-calculation","children":[]},{"level":2,"title":"Rehash","slug":"rehash","link":"#rehash","children":[]},{"level":2,"title":"Trigger Condition of Rehash","slug":"trigger-condition-of-rehash","link":"#trigger-condition-of-rehash","children":[]},{"level":2,"title":"Gradual Rehash","slug":"gradual-rehash","link":"#gradual-rehash","children":[]}],"git":{},"filePathRelative":"redis-implementation-notes/Part 1 - æ•°æ®ç»“æ„ä¸å¯¹è±¡/Chapter 4 - å­—å…¸.md"}');export{i as comp,d as data};
