import{_ as n,c as a,a as e,o as p}from"./app-BeHGwf2X.js";const r={};function l(t,s){return p(),a("div",null,s[0]||(s[0]=[e(`<h1 id="linux-performance-flame-graphs" tabindex="-1"><a class="header-anchor" href="#linux-performance-flame-graphs"><span>Linux Performance - Flame Graphs</span></a></h1><p>Created by: Mr Dk.</p><p>2023 / 09 / 20 23:19</p><p>Hangzhou, Zhejiang, China</p><hr><h2 id="background" tabindex="-1"><a class="header-anchor" href="#background"><span>Background</span></a></h2><p>火焰图（Flame Graph）是性能优化大师 Brendan Gregg 发明的可视化性能分析方法，将采样得到的统计数据以直观的形式通过图表展示出来，解决了采样数据量较大、难以直观分析的问题。火焰图可以有 on-CPU / off-CPU 火焰图、内存火焰图、冷热火焰图、差分火焰图等等。一般来说，通过 <code>perf record</code> 采样的数据能够得到的是 on-CPU 火焰图，展示了 CPU 运行过程中被采样最频繁的函数。然而，这并不能反映出程序因阻塞而离开 CPU 的时间，所以还需要通过其它方式进行采样，并产生 off-CPU 火焰图进行全面的分析。两者结合可以解释 100% 的程序运行时间。</p><p>每一簇火焰的宽度表示被采样命中的次数（按字母排序），每一簇火焰的高度表示被采样时的栈深度。一簇火焰越宽，表示采样时遇到它所对应的函数最频繁；一簇火焰越高，表示采样时它的调用栈越深。</p><p><img src="https://www.brendangregg.com/FlameGraphs/cpu-mysql-updated.svg" alt="flamegraph"></p><h2 id="generation" tabindex="-1"><a class="header-anchor" href="#generation"><span>Generation</span></a></h2><p>如何得到一张火焰图呢？一般来说需要三步：</p><ol><li>采样数据</li><li>折叠堆栈</li><li>产生火焰图</li></ol><h3 id="sampling" tabindex="-1"><a class="header-anchor" href="#sampling"><span>Sampling</span></a></h3><p>使用 Perf / eBPF / DTrace 都是可以的。</p><h3 id="folding-stacks" tabindex="-1"><a class="header-anchor" href="#folding-stacks"><span>Folding Stacks</span></a></h3><p>采样后的数据需要被加工才能产生火焰图。Brendan Gregg 的 <a href="https://github.com/brendangregg/FlameGraph" target="_blank" rel="noopener noreferrer">FlameGraph</a> GitHub 仓库中已经提供了加工采样后数据的脚本：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">git</span> clone https://github.com/brendangregg/FlameGraph</span>
<span class="line"><span class="token builtin class-name">cd</span> FlameGraph</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>仓库内有一堆 <code>stackcollapse-*.pl</code> 的脚本。根据采样时使用的工具，选择相对应的工具来进行加工即可：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">$ <span class="token function">ls</span> <span class="token parameter variable">-l</span> <span class="token operator">|</span> <span class="token function">grep</span> stackcollapse-</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">1185</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-aix.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">1901</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-bpftrace.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">3910</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-chrome-tracing.py</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">2304</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-elfutils.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">1816</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-gdb.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">3631</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-go.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres      <span class="token number">680</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-instruments.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">1786</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-java-exceptions.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">5207</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-jstack.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">1858</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-ljp.awk</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres    <span class="token number">13179</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-perf.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">6527</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-perf-sched.awk</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">2675</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-pmc.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">1569</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-recursive.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">7871</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-sample.awk</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">2309</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-stap.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">2983</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-vsprof.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">3434</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-vtune-mc.pl</span>
<span class="line">-rw-rw-r-- <span class="token number">1</span> postgres postgres     <span class="token number">3174</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-vtune.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">1938</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-wcp.pl</span>
<span class="line">-rwxrwxr-x <span class="token number">1</span> postgres postgres     <span class="token number">5683</span> Sep <span class="token number">17</span> <span class="token number">11</span>:28 stackcollapse-xdebug.php</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="generating-flame-graph" tabindex="-1"><a class="header-anchor" href="#generating-flame-graph"><span>Generating Flame Graph</span></a></h3><p>假设使用了 Perf 采样，当前路径下会有 <code>perf.data</code>。使用如下命令就可以生成火焰图：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">perf script <span class="token operator">|</span> ./stackcollapse-perf.pl <span class="token operator">&gt;</span> out.perf-folded</span>
<span class="line">./flamegraph.pl out.perf-folded <span class="token operator">&gt;</span> perf.svg</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后直接通过浏览器访问 <code>perf.svg</code> 即可。</p><h2 id="references" tabindex="-1"><a class="header-anchor" href="#references"><span>References</span></a></h2><p><a href="https://www.brendangregg.com/flamegraphs.html" target="_blank" rel="noopener noreferrer">Flame Graphs</a></p><p><a href="https://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html" target="_blank" rel="noopener noreferrer">CPU Flame Graphs</a></p><p><a href="https://www.brendangregg.com/FlameGraphs/offcpuflamegraphs.html" target="_blank" rel="noopener noreferrer">Off-CPU Flame Graphs</a></p><p><a href="https://www.brendangregg.com/offcpuanalysis.html" target="_blank" rel="noopener noreferrer">Off-CPU Analysis</a></p>`,28)]))}const o=n(r,[["render",l],["__file","Linux Flame Graphs.html.vue"]]),i=JSON.parse('{"path":"/notes/Performance/Linux%20Flame%20Graphs.html","title":"Linux Performance - Flame Graphs","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Background","slug":"background","link":"#background","children":[]},{"level":2,"title":"Generation","slug":"generation","link":"#generation","children":[{"level":3,"title":"Sampling","slug":"sampling","link":"#sampling","children":[]},{"level":3,"title":"Folding Stacks","slug":"folding-stacks","link":"#folding-stacks","children":[]},{"level":3,"title":"Generating Flame Graph","slug":"generating-flame-graph","link":"#generating-flame-graph","children":[]}]},{"level":2,"title":"References","slug":"references","link":"#references","children":[]}],"git":{},"filePathRelative":"notes/Performance/Linux Flame Graphs.md"}');export{o as comp,i as data};
