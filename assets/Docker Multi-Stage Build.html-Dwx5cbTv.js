import{_ as i,c as l,a as n,o as a}from"./app-BeHGwf2X.js";const s={};function t(r,e){return a(),l("div",null,e[0]||(e[0]=[n(`<h1 id="docker-multi-stage-build" tabindex="-1"><a class="header-anchor" href="#docker-multi-stage-build"><span>Docker - Multi-Stage Build</span></a></h1><p>Created by : Mr Dk.</p><p>2022 / 05 / 11 23:35</p><p>Hangzhou, Zhejiang, China</p><hr><p>目的：产生更小的镜像。</p><h2 id="background" tabindex="-1"><a class="header-anchor" href="#background"><span>Background</span></a></h2><p>最近要发布一个带有可执行文件的 Docker 镜像，可供用户直接 <code>docker run</code> 起来就可以使用了。其中，可执行文件需要通过源码编译获取。</p><p>所以最简单的做法是：</p><ol><li>在容器内准备好编译代码和运行可执行文件的所有依赖</li><li>克隆源码</li><li>编译构建可执行文件</li><li>镜像打包</li></ol><p>但是这种做法有几个问题：</p><ul><li>镜像内的编译工具在编译完毕后不再被使用</li><li>镜像内的源码没有必要保留，但是删除源码并不能减小镜像大小</li></ul><h2 id="multi-stage-image-building" tabindex="-1"><a class="header-anchor" href="#multi-stage-image-building"><span>Multi-Stage Image Building</span></a></h2><p>Docker 支持多阶段的镜像构建，这是减小最终镜像的有效手段。多阶段构建允许在一个 Dockerfile 中使用多个 <code>FROM</code> 指令。配合 <code>COPY --from</code> 指令将 <strong>编译镜像</strong> 中构建完毕的可执行文件拷贝到另一个 <strong>运行时镜像</strong> 当中。其中：</p><ul><li>编译镜像中包含编译源码所需要的所有依赖</li><li>运行时镜像中包含可执行文件运行所需要的所有依赖</li><li>编译镜像中产生的可执行文件被拷贝到运行时镜像中</li></ul><p>这样来看，运行时镜像的层次主要有：</p><ul><li>基础镜像</li><li><s>编译工具和依赖</s></li><li>运行时依赖</li><li><s>源码</s></li><li>可执行文件</li><li><s>（删除源码）</s></li></ul><p>可见，多阶段构建的镜像能够减少不必要的镜像层，从而减小镜像的大小。</p><h2 id="practice" tabindex="-1"><a class="header-anchor" href="#practice"><span>Practice</span></a></h2><p>其具体实践方式的伪代码如下：</p><div class="language-Dockerfile line-numbers-mode" data-highlighter="prismjs" data-ext="Dockerfile" data-title="Dockerfile"><pre><code><span class="line">FROM building_image AS building</span>
<span class="line">RUN install building tools</span>
<span class="line">RUN clone the code</span>
<span class="line">RUN build the code</span>
<span class="line"></span>
<span class="line">FROM running_image</span>
<span class="line">RUN install running dependencies</span>
<span class="line">COPY --from=building &lt;path_in_building_image&gt; &lt;path_in_running_image&gt;</span>
<span class="line">ENTRYPOINT ...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终，发布运行版的容器镜像即可。</p><p>其中 <code>COPY</code> 指令有一个挺坑的地方：如果想递归拷贝整个目录（保持目录和文件的结构），那么 <strong>不能使用通配符</strong>，否则目录的结构将会被 <strong>拉平</strong>。这与 <code>cp</code> 命令不同。</p><blockquote><p>It&#39;s important to note that the secret sauce here is that there is ONE source directory, and ONE target directory specified. Any other combination copies the contents of the source directory(ies) to the target directory.</p></blockquote><h2 id="references" tabindex="-1"><a class="header-anchor" href="#references"><span>References</span></a></h2><p><a href="https://levelup.gitconnected.com/docker-multi-stage-builds-and-copy-from-other-images-3bf1a2b095e0" target="_blank" rel="noopener noreferrer">About Docker Multi-Stage Builds and COPY --from</a></p><p><a href="https://stackoverflow.com/questions/30215830/dockerfile-copy-keep-subdirectory-structure" target="_blank" rel="noopener noreferrer">stackoverflow - Dockerfile copy keep subdirectory structure</a></p>`,27)]))}const o=i(s,[["render",t],["__file","Docker Multi-Stage Build.html.vue"]]),d=JSON.parse('{"path":"/notes/Docker/Docker%20Multi-Stage%20Build.html","title":"Docker - Multi-Stage Build","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"Background","slug":"background","link":"#background","children":[]},{"level":2,"title":"Multi-Stage Image Building","slug":"multi-stage-image-building","link":"#multi-stage-image-building","children":[]},{"level":2,"title":"Practice","slug":"practice","link":"#practice","children":[]},{"level":2,"title":"References","slug":"references","link":"#references","children":[]}],"git":{},"filePathRelative":"notes/Docker/Docker Multi-Stage Build.md"}');export{o as comp,d as data};
